<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìš¸ë¦¼ ì„±ìš°Â·ìŠ¤í”¼ì¹˜Â·ì—°ê¸°í•™ì› í†µí•© ì—°ìŠµí”„ë¡œê·¸ë¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ë°ì´í„° íŒŒì¼ -->
<script src="appdata/etude/data.js"></script>
<script src="appdata/vocalization/data.js"></script>
<script src="appdata/past_questions/data.js"></script>

<!-- html2canvas -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2ecc71">

<style>
/* -------------------------
    ê¸°ë³¸ Reset & Body
-------------------------- */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: #f5f7fb;
    color: #333;
}

/* -------------------------
    LOGIN í™”ë©´
-------------------------- */
#loginScreen {
    position: fixed;
    inset: 0;
    background: #eef2f5;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.login-card {
    width: 90%;
    max-width: 360px;
    background: #fff;
    padding: 30px 28px 40px;
    border-radius: 22px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.12);
    text-align: center;
}

.login-logo {
    width: 120px;
    margin-bottom: 18px;
}

.login-title {
    font-size: 21px;
    font-weight: 800;
    color: #2ecc71;
    margin-bottom: 20px;
}

.login-input {
    width: 100%;
    padding: 13px;
    border-radius: 10px;
    border: 1px solid #ccc;
    margin-bottom: 12px;
    font-size: 15px;
}

.login-btn {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    margin-top: 5px;
}

.login-btn.main {
    background: #2ecc71;
    color: #fff;
}
.login-btn.main:hover { background: #27c06a; }

.login-btn.guest {
    background: #dcdcdc;
    color: #333;
}
.login-btn.guest:hover { background: #c7c7c7; }

.login-links {
    margin-top: 18px;
    font-size: 13px;
}
.login-links a {
    color: #2980b9;
    margin: 0 4px;
}

/* -------------------------
    ë©”ì¸ ë ˆì´ì•„ì›ƒ
-------------------------- */
#mainArea {
    display: none;
}

header {
    background: #fff;
    padding: 16px 20px;
    box-shadow: 0px 2px 10px rgba(0,0,0,0.05);
    display: flex;
    justify-content: center;
}

.header-content {
    display: flex;
    align-items: center;
}

.logo-img {
    height: 42px;
    margin-right: 10px;
}

.header-title {
    font-size: 20px;
    font-weight: 800;
    color: #2ecc71;
}

.wrapper {
    width: 92%;
    max-width: 1200px;
    margin: 20px auto;
}

.tabs {
    display: flex;
    gap: 5px;
    border-bottom: 2px solid #ddd;
    overflow-x: auto;
    white-space: nowrap;
}

.tab {
    padding: 12px 16px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    color: #666;
    flex-shrink: 0;
}

.tab.active {
    color: #2ecc71;
    background: #fff;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 10px 10px 0 0;
}

.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn .25s; }

@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
</style>
</head>

<body>

<!-- -------------------------
     ë¡œê·¸ì¸ í™”ë©´
-------------------------- -->
<div id="loginScreen">
  <div class="login-card">
      <img src="appdata/logo.png" class="login-logo">

      <div class="login-title">ìš¸ë¦¼ì—°ê¸°í•™ì› ì—°ìŠµí”„ë¡œê·¸ë¨</div>

      <input id="loginName" class="login-input" type="text" placeholder="í•™ìƒ ì´ë¦„">
      <input id="loginPW" class="login-input" type="password" maxlength="4" placeholder="ì•”í˜¸ (íœ´ëŒ€í° ë’¤ 4ìë¦¬)">

      <button class="login-btn main" onclick="login()">ë¡œê·¸ì¸</button>
      <button class="login-btn guest" onclick="guestLogin()">ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸</button>

      <div class="login-links">
        <a href="https://www.youtube.com/@ìš¸ë¦¼ì„±ìš°ì—°ê¸°í•™ì›">ìœ íŠœë¸Œ</a> |
        <a href="https://blog.naver.com/ulimvoice">ë¸”ë¡œê·¸</a> |
        <a href="https://instagram.com/ulimvoice">ì¸ìŠ¤íƒ€</a>
      </div>
  </div>
</div>

<!-- -------------------------
     ë©”ì¸ ì „ì²´ UI
-------------------------- -->
<div id="mainArea">

<header>
  <div class="header-content">
      <img src="appdata/logo.png" class="logo-img">
      <div class="header-title">ìš¸ë¦¼ì—°ê¸°í•™ì› ì—°ìŠµí”„ë¡œê·¸ë¨</div>
  </div>
</header>

<main class="wrapper">

  <div class="tabs">
      <div class="tab active" data-tab="tab_skit">ğŸ­ ìƒí™©ê·¹</div>
      <div class="tab" data-tab="tab_vocal">ğŸ¤ ë°œì„±í›ˆë ¨</div>
      <div class="tab" data-tab="tab_questions">ğŸ“„ ê¸°ì¶œë¬¸ì œ</div>
      <div class="tab" data-tab="tab_log">ğŸ“… ì—°ìŠµì¼ì§€</div>
  </div>

  <!-- TAB ì˜ì—­ì€ PART3 ì—ì„œ ì´ì–´ì„œ ì‘ì„±ë¨ -->
<script>
/***************************************************
 * 0. ì „ì—­ ìƒíƒœ ë³€ìˆ˜
 ***************************************************/
let studentName = localStorage.getItem("studentName") || "";
let phoneLast4 = localStorage.getItem("phoneLast4") || "";
let instructorName = localStorage.getItem("instructorName") || "";
let instructorFolderId = localStorage.getItem("instructorFolderId") || "";
let isGuest = localStorage.getItem("isGuest") === "true";

// GAS URLs
const GET_API_URL =
  "https://script.google.com/macros/s/AKfycbz5M-B0ogXDLiiV86KVPqRkmrIYJlSgWFf973t7MbPWM0wxjF5L8ubDWSZdlZazhe04sQ/exec";

const GOOGLE_APP_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbxgIXZv73FmnG-r-JoWnBGcfjrzJZV3I6Zp5xmJbSheUrJ9pWc165UOxAn4HUD5hMpc9g/exec";


/***************************************************
 * 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ì—¬ë¶€ ì²´í¬
 ***************************************************/
window.onload = function () {

  if (!studentName && !isGuest) {
    // ë¡œê·¸ì¸ í•„ìš”
    document.getElementById("loginScreen").style.display = "flex";
    document.getElementById("mainArea").style.display = "none";
  } else {
    // ë¡œê·¸ì¸ ìœ ì§€ ìƒíƒœ
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainArea").style.display = "block";

    activateTabs(); // íƒ­ ê¸°ëŠ¥ í™œì„±í™”
  }
};


/***************************************************
 * 2. í•™ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬
 ***************************************************/
async function login() {
  const nameInput = document.getElementById("loginName").value.trim();
  const pwInput = document.getElementById("loginPW").value.trim();

  if (!nameInput || !pwInput) {
    alert("ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  try {
    const res = await fetch(
      `${GET_API_URL}?name=${encodeURIComponent(nameInput)}&phoneLast4=${encodeURIComponent(pwInput)}`
    );
    const data = await res.json();

    if (data.status !== "success") {
      alert("í•™ìƒ ì¸ì¦ ì‹¤íŒ¨. ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.");
      return;
    }

    // ë¡œê·¸ì¸ ì„±ê³µ
    studentName = data.name;
    phoneLast4 = data.phoneLast4;
    instructorName = data.instructor;
    instructorFolderId = data.instructorFolderId || "";

    // ì €ì¥
    localStorage.setItem("studentName", studentName);
    localStorage.setItem("phoneLast4", phoneLast4);
    localStorage.setItem("instructorName", instructorName);
    localStorage.setItem("instructorFolderId", instructorFolderId);
    localStorage.setItem("isGuest", "false");

    // UI ì „í™˜
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainArea").style.display = "block";

    activateTabs();

    alert(`${studentName}ë‹˜ ë¡œê·¸ì¸ ì„±ê³µ!`);
  } catch (err) {
    alert("ì„œë²„ ì˜¤ë¥˜: " + err);
  }
}


/***************************************************
 * 3. ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸
 ***************************************************/
function loginGuest() {
  localStorage.setItem("isGuest", "true");
  isGuest = true;

  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainWrapper").style.display = "block";

  activateTabEvents();

  // â˜… ê²ŒìŠ¤íŠ¸ ì „ìš© ê¸°ëŠ¥: ìƒí™©ê·¹ íƒ­ ìë™ í™œì„±í™”
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

  document.querySelector('[data-tab="tab_skit"]').classList.add("active");
  document.getElementById("tab_skit").classList.add("active");

  // â˜… ìƒí™©ê·¹ ìë™ ìƒì„±
  generateSkit();
}


/***************************************************
 * 4. íƒ­ í™œì„±í™” ë° ê²ŒìŠ¤íŠ¸ ì œí•œ
 ***************************************************/
function activateTabs() {
  document.querySelectorAll(".tab").forEach(tab => {
    tab.onclick = function () {
      const tabId = tab.dataset.tab;

      // â˜… ê²ŒìŠ¤íŠ¸ ì ‘ê·¼ ì œí•œ (ìƒí™©ê·¹ tab_skit ë§Œ ê°€ëŠ¥)
      if (isGuest && tabId !== "tab_skit") {
        alert("ê²ŒìŠ¤íŠ¸ëŠ” 'ìƒí™©ê·¹' ë©”ë‰´ë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }

      // íƒ­ í™œì„±í™” ì²˜ë¦¬
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

      tab.classList.add("active");
      document.getElementById(tabId).classList.add("active");
    };
  });
}

</script>
<script>
/***************************************************
 * 5. ìƒí™©ê·¹ ìƒì„± ê¸°ëŠ¥
 ***************************************************/
function generateSkit() {
  const emotions = ["ë¶„ë…¸", "ê¸°ì¨", "ìŠ¬í””", "ë†€ëŒ", "ê²©ì•™"];
  const places = ["ì§€í•˜ì² ", "ê°•ì˜ì‹¤", "ë³‘ì›", "ì‚¬ë¬´ì‹¤", "ì²´ìœ¡ê´€"];
  const relations = ["ì¹œêµ¬", "ë¶€ëª¨", "ì§ì¥ìƒì‚¬", "í˜•ì œ", "ì„ ìƒë‹˜"];
  const lines = [
    "ì™œ ê·¸ë ‡ê²Œ í–‰ë™í•œ ê±°ì•¼?",
    "ë‚˜ë„ ì´ì œ ì§€ì³¤ì–´.",
    "ë‹¤ì‹œ ìƒê°í•´ë³¼ ìˆ˜ëŠ” ì—†ì„ê¹Œ?",
    "ê·¸ëŸ´ ë¦¬ê°€ ì—†ì–ì•„!",
    "ì˜¤ëŠ˜ë§Œì€ ì°¸ìâ€¦ ì œë°œ."
  ];

  const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

  const skit = `
    <b>[ê°ì •]</b> ${pick(emotions)}<br>
    <b>[ì¥ì†Œ]</b> ${pick(places)}<br>
    <b>[ê´€ê³„]</b> ${pick(relations)}<br>
    <b>[ëŒ€ì‚¬]</b> ${pick(lines)}<br>
  `;

  document.getElementById("skitOutput").innerHTML = skit;
}


/***************************************************
 * 6. ë°œì„±í›ˆë ¨ â€” ë¬¸ì¥ ë½‘ê¸°
 ***************************************************/
let currentTrainObj = null;
let trainStep = 1;

function trainNew() {
  if (typeof vocalData === "undefined") {
    alert("ë°œì„± ë°ì´í„°(appdata/vocalization/data.js)ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const idx = Math.floor(Math.random() * vocalData.length);
  currentTrainObj = vocalData[idx];

  document.getElementById("train_origin").textContent = currentTrainObj.text;

  trainStep = 1;
  document.getElementById("recordUI").style.display = "block";
  document.getElementById("recordedAudio").style.display = "none";

  document.getElementById("btnStartRecord").style.display = "inline-block";
  document.getElementById("btnStopRecord").style.display = "none";
}


/***************************************************
 * 7. ë…¹ìŒ ê¸°ëŠ¥
 ***************************************************/
let mediaRecorder;
let recordedChunks = [];

async function startRecording() {
  recordedChunks = [];

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
  } catch (err) {
    alert("ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨: " + err);
    return;
  }

  mediaRecorder.ondataavailable = (e) => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };

  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: "audio/webm" });
    const url = URL.createObjectURL(blob);

    const audio = document.getElementById("recordedAudio");
    audio.src = url;
    audio.style.display = "block";

    uploadRecordedAudio(blob);
  };

  mediaRecorder.start();

  document.getElementById("btnStartRecord").style.display = "none";
  document.getElementById("btnStopRecord").style.display = "inline-block";
}

function stopRecording() {
  if (mediaRecorder) {
    mediaRecorder.stop();
  }

  document.getElementById("btnStartRecord").style.display = "inline-block";
  document.getElementById("btnStopRecord").style.display = "none";
}


/***************************************************
 * 8. ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ + ì—°ìŠµì¼ì§€ ê¸°ë¡(GAS POST)
 ***************************************************/
async function uploadRecordedAudio(blob) {
  if (!instructorFolderId) {
    alert("ê°•ì‚¬ í´ë” IDê°€ ì—†ì–´ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const formData = new FormData();
  formData.append("audio", blob, "record.webm");
  formData.append("student", studentName || "ê²ŒìŠ¤íŠ¸");
  formData.append("folderId", instructorFolderId);
  formData.append("sentence", currentTrainObj.text);

  try {
    const res = await fetch(GOOGLE_APP_SCRIPT_URL, {
      method: "POST",
      body: formData,
    });

    const result = await res.json();

    if (result.status === "success") {
      alert("ë…¹ìŒ ì—…ë¡œë“œ + ì—°ìŠµì¼ì§€ ê¸°ë¡ ì™„ë£Œ!");
      saveLogRecord(currentTrainObj.text);
    } else {
      alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + result.message);
    }
  } catch (err) {
    alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err);
  }
}


/***************************************************
 * 9. ì—°ìŠµ ì¼ì§€ ê¸°ë¡(ë¡œì»¬ ì €ì¥ â†’ ë‹¬ë ¥ í‘œì‹œ ê°€ëŠ¥)
 ***************************************************/
function saveLogRecord(sentence) {
  const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
  let logs = JSON.parse(localStorage.getItem("practiceLogs") || "{}");

  logs[today] = sentence;
  localStorage.setItem("practiceLogs", JSON.stringify(logs));

  renderCalendar();
}


/***************************************************
 * 10. ì—°ìŠµì¼ì§€ ë‹¬ë ¥ (í•„ìš” ì‹œ í™•ì¥)
 ***************************************************/
function renderCalendar() {
  const area = document.getElementById("calendarDisplayArea");
  area.innerHTML = "";

  const logs = JSON.parse(localStorage.getItem("practiceLogs") || "{}");

  if (Object.keys(logs).length === 0) {
    area.innerHTML = "<p>ì—°ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  let html = "<h3>ì™„ë£Œëœ ì—°ìŠµ ëª©ë¡</h3>";

  html += "<ul style='line-height:1.8; padding-left:15px;'>";

  for (let date in logs) {
    html += `<li><b>${date}</b> â€” ${logs[date]}</li>`;
  }

  html += "</ul>";

  area.innerHTML = html;
}


/***************************************************
 * 11. ê¸°ì¶œë¬¸ì œ ëœë¤ ê¸°ëŠ¥
 ***************************************************/
function generateQuestion() {
  if (!pastQuestions || pastQuestions.length === 0) {
    alert("ê¸°ì¶œë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const idx = Math.floor(Math.random() * pastQuestions.length);
  document.getElementById("questionOutput").textContent = pastQuestions[idx];
}
</script>
<style>
/* -----------------------------
   ê¸°ë³¸ ì´ˆê¸°í™”
------------------------------*/
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Pretendard", "Noto Sans KR", sans-serif;
}

body {
  background: #f5f7f9;
  color: #222;
  overflow-x: hidden;
}

/* -----------------------------
   LOGIN SCREEN
------------------------------*/
#loginScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #eef2f5;
  display: none; /* JSë¡œ ì œì–´ */
  justify-content: center;
  align-items: center;
  padding: 20px;
  z-index: 9999;
}

.login-box {
  width: 92%;
  max-width: 380px;
  background: white;
  padding: 28px;
  border-radius: 12px;
  box-shadow: 0px 6px 20px rgba(0,0,0,0.12);
  text-align: center;
}

.login-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 20px;
}

.login-subtitle {
  font-size: 14px;
  margin-bottom: 20px;
  opacity: 0.7;
}

.login-box input {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 15px;
  margin-bottom: 12px;
}

.login-btn {
  width: 100%;
  padding: 13px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  margin-top: 5px;
  cursor: pointer;
  transition: 0.2s;
  font-weight: 600;
}

.login-btn.main   { background: #1b8f3f; color: white; }
.login-btn.main:hover { background: #146c30; }

.login-btn.guest  { background: #ececec; color: #444; }
.login-btn.guest:hover { background: #dcdcdc; }

/* -----------------------------
   MAIN WRAPPER
------------------------------*/
#mainWrapper {
  display: none;
  padding-bottom: 80px;
}

/* -----------------------------
   HEADER
------------------------------*/
.header {
  background: #1b8f3f;
  color: white;
  padding: 14px 18px;
  font-size: 18px;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 5;
}

/* -----------------------------
   TAB MENU
------------------------------*/
.tab-container {
  display: flex;
  background: white;
  border-bottom: 1px solid #ddd;
  position: sticky;
  top: 52px;
  z-index: 4;
}

.tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  font-size: 15px;
  cursor: pointer;
  transition: 0.2s;
  border-bottom: 3px solid transparent;
}

.tab.active {
  font-weight: 700;
  color: #1b8f3f;
  border-bottom: 3px solid #1b8f3f;
}

.tab:hover { background: #f1f5f2; }

/* -----------------------------
   TAB CONTENT AREA
------------------------------*/
.tab-content {
  display: none;
  padding: 18px;
}

.tab-content.active {
  display: block;
}

/* -----------------------------
   CARDS
------------------------------*/
.card {
  background: white;
  padding: 18px;
  border-radius: 12px;
  box-shadow: 0px 3px 10px rgba(0,0,0,0.08);
  margin-bottom: 20px;
}

/* -----------------------------
   BUTTONS
------------------------------*/
.btn {
  display: inline-block;
  padding: 12px 16px;
  background: #1b8f3f;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  text-align: center;
  margin-top: 6px;
  transition: 0.2s;
}

.btn:hover { background: #146c30; }

.btn-secondary {
  background: #ddd;
  color: #444;
}

.btn-secondary:hover {
  background: #c9c9c9;
}

.btn-row {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}
.btn-row .btn {
  flex: 1;
}

/* -----------------------------
   SKIT OUTPUT
------------------------------*/
#skitOutput {
  font-size: 16px;
  line-height: 1.7;
  margin-top: 10px;
}

/* -----------------------------
   VOCAL TRAINING
------------------------------*/
#train_origin {
  font-size: 18px;
  font-weight: 600;
  line-height: 1.6;
  padding: 12px;
  background: #f6faf7;
  border-radius: 10px;
  margin-bottom: 10px;
}

/* ë…¹ìŒ ë°•ìŠ¤ */
#recordUI {
  background: #fff;
  padding: 18px;
  border-radius: 12px;
  box-shadow: 0px 3px 8px rgba(0,0,0,0.08);
  margin-top: 18px;
}

.record-box audio {
  width: 100%;
  margin-top: 12px;
}

/* -----------------------------
   ê¸°ì¶œë¬¸ì œ
------------------------------*/
#questionOutput {
  font-size: 17px;
  padding: 12px;
  background: #fafafa;
  border-left: 4px solid #1b8f3f;
  border-radius: 8px;
  margin-top: 12px;
}

/* -----------------------------
   ì—°ìŠµ ì¼ì§€
------------------------------*/
#calendarDisplayArea {
  margin-top: 10px;
  padding: 15px;
  background: white;
  border-radius: 10px;
  box-shadow: 0px 2px 8px rgba(0,0,0,0.07);
}
</style>

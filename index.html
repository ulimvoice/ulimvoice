<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìš¸ë¦¼ ì„±ìš°Â·ìŠ¤í”¼ì¹˜Â·ì—°ê¸°í•™ì› í†µí•© ì—°ìŠµ í”„ë¡œê·¸ë¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="appdata/etude/data.js"></script>
<script src="appdata/vocalization/data.js"></script>
<script src="appdata/past_questions/data.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#2ecc71">
<style>
/* ===========================
Â  Â ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ìƒëµ)
Â  Â =========================== */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f5f7fb; margin: 0; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
.wrapper { max-width: 1200px; width: 95%; margin: 0 auto; flex: 1; padding: 20px 0; }
header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
.header-content { max-width: 1200px; width: 100%; display: flex; align-items: center; }
.logo-img { height: 45px; width: auto; margin-right: 12px; }
.header-title { font-size: 20px; font-weight: 800; color: #2ecc71; margin: 0; word-break: keep-all; }
footer { background: #333; color: #aaa; padding: 30px 20px; text-align: center; font-size: 13px; line-height: 1.6; margin-top: 40px; }
footer b { color: #fff; font-weight: 700; }
.tabs { display: flex; gap: 5px; border-bottom: 2px solid #ddd; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
.tab { padding: 12px 16px; cursor: pointer; font-weight: 700; color: #666; font-size: 15px; transition: 0.2s; flex-shrink: 0; }
.tab.active { background: #fff; color: #2ecc71; border: 1px solid #ddd; border-bottom: none; border-radius: 10px 10px 0 0; }
.tab-content { display: none; animation: fadeIn 0.3s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.section { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
.btn-row { display: flex; gap: 10px; margin-top: 20px; }
.btn-row button { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 17px; font-weight: 800; cursor: pointer; color: white; transition: 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); white-space: nowrap; }
.btn-row button:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
.btn-gen { background: #2ecc71; } .btn-save { background: #3498db; } .btn-male { background: #3498db; } .btn-female { background: #ff7979; }
.btn-share { background: #e67e22; }
.lock-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.05); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; z-index: 10; }
.lock-btn.locked { background: #ff4757; color: white; opacity: 1; }
.scene-main-card { border: 2px solid #f0f0f0; border-radius: 20px; padding: 30px 20px; background: #fff; text-align: center; margin-bottom: 30px; }
.color-badge-box { width: 100%; height: 80px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 20px; position: relative; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; text-align: left; }
.info-item { background: #f9f9f9; padding: 15px; border-radius: 14px; position: relative; min-height: 50px; display: flex; flex-direction: column; justify-content: center; }
.info-label { font-size: 12px; color: #888; font-weight: 700; margin-bottom: 4px; display:block; }
.info-value { font-size: 17px; font-weight: 700; color: #333; word-break: keep-all; }
.line-area { padding: 25px; background: #f0fdf4; border-radius: 16px; border: 2px solid #dcfce7; margin-bottom: 20px; position: relative; }
.line-text { font-size: 24px; font-weight: 900; color: #166534; word-break: keep-all; line-height: 1.4; }
.mission-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
.mission-card { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.mission-title-input { border: none; border-bottom: 1px dashed #ccc; font-size: 16px; font-weight: 800; color: #333; width: 150px; padding: 2px; background: transparent; }
.mission-title-input:focus { outline: none; border-bottom: 2px solid #2ecc71; }
.char-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
.char-img-frame { width: 100%; max-width: 300px; aspect-ratio: 1/1; border-radius: 20px; overflow: hidden; background: #f0f0f0; border: 5px solid #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; position: relative; }
.char-img { width: 100%; height: 100%; object-fit: cover; }
.char-placeholder { color: #aaa; text-align: center; font-size: 14px; padding: 20px; }
.char-info-box { text-align: center; width: 100%; }
.char-name { font-size: 26px; font-weight: 900; color: #333; margin-bottom: 5px; }
.char-job { font-size: 17px; color: #2ecc71; font-weight: 700; margin-bottom: 15px; }
.char-desc { background: #f8f9fa; padding: 20px; border-radius: 14px; font-size: 16px; color: #555; line-height: 1.6; border: 1px solid #eee; word-break: keep-all; }
.char-save-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 30px; }
.mini-char-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; font-size: 13px; border:1px solid #eee; }
.mini-char-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background:#ddd; }
.mini-char-info { padding: 10px; }
.train-origin-text {Â 
Â  Â  font-size: 20px; font-weight: 700; color: #333; text-align: center;Â 
Â  Â  margin-bottom: 25px; word-break: keep-all; line-height: 1.5;Â 
Â  Â  min-height: 30px; padding: 15px; background: #e8f5e9; border-radius: 12px; border: 1px solid #c8e6c9;
}
.train-card { background: #fff; border: 2px solid #eee; border-radius: 20px; padding: 30px 15px; text-align: center; margin-bottom: 20px; }
.train-main-text { font-size: 32px; font-weight: 900; color: #2ecc71; word-break: keep-all; line-height: 1.3; margin: 20px 0; }
.train-nav { display: flex; justify-content: space-between; align-items: center; gap:10px; margin-top:20px;}
.train-nav button { background: #333; color: #fff; padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; }
.train-nav button:disabled { background: #ddd; cursor: not-allowed; }
.record-box { margin-top: 10px; padding-top: 20px; border-top: 2px dashed #eee; display: none; }
.pro-player-box { background: #f0fdf4; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; }
.player-label { font-size: 12px; font-weight: 800; color: #2ecc71; margin-bottom: 5px; display: block; }
audio { width: 100%; height: 40px; }
.mic-btn {
Â  Â  width: 80px; height: 80px; border-radius: 50%; background: #ff4757; color: white; border: none;
Â  Â  font-size: 34px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.5); display: flex; align-items: center; justify-content: center; margin: 0 auto;
Â  Â  transition: transform 0.1s;
}
.mic-btn:active { transform: scale(0.95); }
.mic-btn.recording { animation: pulse 1.5s infinite; background: #333; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }
.result-box { margin-top: 20px; background: #fff; border-radius: 15px; border: 1px solid #e0e0e0; display: none; overflow:hidden; }
.result-section { padding: 20px; border-bottom: 1px solid #f0f0f0; }
.result-section:last-child { border-bottom: none; }
.section-title { font-size: 14px; font-weight: 800; color: #555; margin-bottom: 10px; display: flex; align-items:center; gap:5px; }
.time-info { margin-top:8px; font-size:14px; color:#555; font-weight:bold; }
.time-val { color: #ff4757; font-weight:900; }
.stt-text { font-size: 18px; color: #333; line-height: 1.4; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:10px; font-weight:500; min-height: 40px;}
.accuracy-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 13px; color: white; font-weight:bold; }
.acc-good { background: #2ecc71; } .acc-bad { background: #ff6b6b; } .acc-soso { background: #f1c40f; } .acc-wait { background: #aaa; }
.guide-text { font-size:12px; color:#999; margin-top:5px; }
.past-display-card { border: 2px solid #ddd; border-radius: 20px; padding: 30px; background: #fff; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; word-break: keep-all; margin-bottom:20px; }
.past-role { font-size: 20px; font-weight: 900; color: #2ecc71; margin-bottom: 20px; }
.past-lines { font-size: 18px; line-height: 1.8; color: #333; white-space: pre-wrap; font-family: 'KoPub Batang', serif; }
@media (max-width: 600px) {
Â  Â  .section { padding: 20px; }
Â  Â  .info-grid { grid-template-columns: 1fr; }
Â  Â  .line-text { font-size: 22px; }
Â  Â  .train-main-text { font-size: 28px; }
Â  Â  .header-title { font-size: 18px; }
Â  Â  .logo-img { height: 35px; }
Â  Â  .btn-row { flex-wrap: wrap; }
Â  Â  .btn-row button { min-width: 45%; }
}
</style>
</head>
<body>

<header>
Â  Â  <div class="header-content">
Â  Â  Â  Â  <img src="appdata/logo.png" class="logo-img" alt="ìš¸ë¦¼ì—°ê¸°í•™ì›" onerror="this.style.display='none';">
Â  Â  Â  Â  <h1 class="header-title">ìš¸ë¦¼ì—°ê¸°í•™ì› ì—°ìŠµ í”„ë¡œê·¸ë¨</h1>
Â  Â  </div>
</header>
<div id="loginOverlay" style="
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f7fb;
    z-index: 10000; display: none; flex-direction: column; align-items: center;
    justify-content: center; padding: 20px; box-sizing: border-box;
">
    <div style="max-width: 350px; width: 100%; padding: 40px 25px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
        <img src="appdata/logo.png" style="width: 100%; max-width: 150px; display: block; margin: 0 auto 30px;" alt="ìš¸ë¦¼ì—°ê¸°í•™ì› ë¡œê³ ">
        <h2 style="text-align: center; color: #2ecc71; margin-bottom: 30px; font-size: 24px;">í•™ìƒ ì¸ì¦ ë¡œê·¸ì¸</h2>

        <div style="margin-bottom: 20px;">
            <label for="studentNameInput" style="display: block; font-size: 14px; color: #555; margin-bottom: 5px; font-weight: bold;">ğŸ‘¤ í•™ìƒ ì´ë¦„:</label>
            <input type="text" id="studentNameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px;">
        </div>
        <div style="margin-bottom: 30px;">
            <label for="phoneLast4Input" style="display: block; font-size: 14px; color: #555; margin-bottom: 5px; font-weight: bold;">ğŸ”‘ ì•”í˜¸ (ì „í™”ë²ˆí˜¸ ë’¤ ë„¤ ìë¦¬):</label>
            <input type="password" id="phoneLast4Input" placeholder="ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬" maxlength="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px;">
        </div>

        <button onclick="authenticateStudentFromInputs()" style="width: 100%; padding: 14px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-size: 17px; font-weight: bold; cursor: pointer; transition: background 0.2s;">
            ë¡œê·¸ì¸
        </button>
        <button onclick="guestLogin()" style="width: 100%; padding: 14px; background: #aaa; color: white; border: none; border-radius: 8px; font-size: 17px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.2s;">
            ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ (ìƒí™©ê·¹ íƒ­ë§Œ ì‚¬ìš©)
        </button>
    </div>

    <div style="margin-top: 40px; text-align: center;">
        <p style="font-size: 14px; color: #888; margin-bottom: 15px;">ìš¸ë¦¼ ì—°ê¸°í•™ì›ì˜ ë‹¤ì–‘í•œ ì†Œì‹ì„ ë§Œë‚˜ë³´ì„¸ìš”!</p>
        <a href="#" target="_blank" style="margin: 0 10px;"><img src="https://img.icons8.com/color/40/000000/youtube-play.png" alt="YouTube" style="vertical-align: middle;"></a>
        <a href="#" target="_blank" style="margin: 0 10px;"><img src="https://img.icons8.com/fluent/40/000000/instagram-new.png" alt="Instagram" style="vertical-align: middle;"></a>
        <a href="#" target="_blank" style="margin: 0 10px;"><img src="https://img.icons8.com/color/40/000000/blogger.png" alt="Blog" style="vertical-align: middle;"></a>
    </div>
</div>
<main class="wrapper" style="display: none;">
Â  <div class="tabs">
Â  Â  <div class="tab active" data-tab="tab1">ğŸ­ ìƒí™©ê·¹</div>
Â  Â  <div class="tab" data-tab="tab2">ğŸ¨ ìºë¦­í„°</div>
Â  Â  <div class="tab" data-tab="tab3">ğŸ¤ ë°œì„±í›ˆë ¨</div>
Â  Â  <div class="tab" data-tab="tab4">ğŸ“„ ê¸°ì¶œë¬¸ì œ</div>
Â  </div>

Â  <div class="tab-content active" id="tab1">
Â  Â  <div class="section">
Â  Â  Â  <div class="scene-main-card">
Â  Â  Â  Â  <div class="color-badge-box" id="colorBg" style="background:#ddd;">
Â  Â  Â  Â  Â  Â  <span id="colorText">ìƒ‰ìƒ</span>
Â  Â  Â  Â  Â  Â  <button class="lock-btn" id="lock-color" onclick="toggleLock('color')">ğŸ”“</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  <div class="info-item"><span class="info-label">ì¥ì†Œ</span><span class="info-value" id="placeDisplay">-</span><button class="lock-btn" id="lock-place" onclick="toggleLock('place')">ğŸ”“</button></div>
Â  Â  Â  Â  Â  Â  <div class="info-item"><span class="info-label">ê°ì •</span><span class="info-value" id="emotionDisplay">-</span><button class="lock-btn" id="lock-emotion" onclick="toggleLock('emotion')">ğŸ”“</button></div>
Â  Â  Â  Â  Â  Â  <div class="info-item"><span class="info-label">ê´€ê³„</span><span class="info-value" id="relationDisplay">-</span><button class="lock-btn" id="lock-relation" onclick="toggleLock('relation')">ğŸ”“</button></div>
Â  Â  Â  Â  Â  Â  <div class="info-item"><span class="info-label">í–‰ë™</span><span class="info-value" id="actionDisplay">-</span><button class="lock-btn" id="lock-action" onclick="toggleLock('action')">ğŸ”“</button></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="line-area">
Â  Â  Â  Â  Â  Â  <div class="line-text" id="lineDisplay">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
Â  Â  Â  Â  Â  Â  <button class="lock-btn" id="lock-line" onclick="toggleLock('line')">ğŸ”“</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="btn-row">
Â  Â  Â  Â  Â  Â  <button class="btn-gen" id="btnGen" onclick="rollScene()">ğŸ² ëœë¤ ë½‘ê¸°</button>
Â  Â  Â  Â  Â  Â  <button class="btn-save" onclick="saveScene()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
Â  Â  Â  Â  Â  Â  <button class="btn-share" id="btnShare" onclick="shareSceneAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€/ê³µìœ </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <h3 style="margin-top:30px; color:#555;">ğŸ“‹ ì €ì¥ëœ ë¯¸ì…˜</h3>
Â  Â  Â  <div id="missionGrid" class="mission-grid"></div>
Â  Â  </div>
Â  </div>

Â  <div class="tab-content" id="tab2">
Â  Â  <div class="section">
Â  Â  Â  <div class="scene-main-card" id="characterCard">
Â  Â  Â  Â  <div class="char-container">
Â  Â  Â  Â  Â  Â  <div class="char-img-frame">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="char-placeholder">ë½‘ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</span>
Â  Â  Â  Â  Â  Â  Â  Â  <img id="charImgDisplay" class="char-img" src="" style="display:none;" onerror="this.style.display='none'; this.previousElementSibling.style.display='block';">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="char-info-box">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="charNameDisplay" class="char-name">ìºë¦­í„° ì´ë¦„</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="charJobDisplay" class="char-job">ì§ì—…</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="charDescDisplay" class="char-desc">ë²„íŠ¼ì„ ëˆŒëŸ¬ ìºë¦­í„°ë¥¼ ì†Œí™˜í•˜ì„¸ìš”.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="btn-row">
Â  Â  Â  Â  Â  Â  <button class="btn-male" onclick="rollCharacter('male')">ğŸ‘±â€â™‚ï¸ ë‚¨ì ë½‘ê¸°</button>
Â  Â  Â  Â  Â  Â  <button class="btn-female" onclick="rollCharacter('female')">ğŸ‘© ì—¬ì ë½‘ê¸°</button>
Â  Â  Â  Â  Â  Â  <button class="btn-save" onclick="saveCharacter()">â­ ì €ì¥í•˜ê¸°</button>
Â  Â  Â  Â  Â  Â  <button class="btn-share" onclick="shareCharacterAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€/ê³µìœ </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="charSaveGrid" class="char-save-grid"></div>
Â  Â  </div>
Â  </div>

Â <div class="tab-content" id="tab3">
Â  Â  <div class="section">
Â  Â  Â  <div class="train-origin-text" id="train_origin">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¬¸ì¥ì„ ë½‘ì•„ì£¼ì„¸ìš”</div>

Â  Â  Â  <div class="btn-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  <button class="btn-gen" style="flex: 2;" onclick="trainNew()">âœ¨ ìƒˆ ë¬¸ì¥ ë½‘ê¸°</button>
Â  Â  Â  Â  <button class="btn-save" id="btnComplete" style="flex: 1; background: #2980b9; display: none;" onclick="completeTraining()">âœ… ì—°ìŠµ ì™„ë£Œ</button>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <button onclick="toggleCalendar()" style="width:100%; padding:10px; margin-top:5px; background:#ddd; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">
Â  Â  Â  Â  ğŸ“… ì—°ìŠµ ê¸°ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°
Â  Â  Â  </button>

Â  Â  Â  <div id="calendarDisplayArea" style="display: none;">
Â  Â  Â  Â  <h3 style="margin-top:20px; color:#555;">ğŸ“… ì—°ìŠµ ê¸°ë¡</h3>
Â  Â  Â  Â  <div id="calendarContainer" style="display: flex; justify-content: center; margin-top: 15px;">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p style="font-size:12px; color:#aaa; text-align:center; margin-top:10px;">(O: ì™„ë£Œ, X: ë¯¸ì™„ë£Œ)</p>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div id="train_card" class="train-card">
Â  Â  Â  Â  <p style="color:#aaa;">'ìƒˆ ë¬¸ì¥ ë½‘ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
Â  Â  Â  </div>

Â  Â  Â  <div class="record-box" id="recordBox">
Â  Â  Â  Â  <div class="pro-player-box">
Â  Â  Â  Â  Â  Â  <span class="player-label">ğŸ§ í”„ë¡œ ì„±ìš° ì˜ˆì‹œ ë“£ê¸°</span>
Â  Â  Â  Â  Â  Â  <audio id="proAudio" controls src=""></audio>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align:center; margin: 30px 0;">
Â  Â  Â  Â  Â  Â  <button id="micBtn" class="mic-btn" onclick="handleAction()">ğŸ¤</button>
Â  Â  Â  Â  Â  Â  <p id="recStatus" style="font-size:14px; color:#555; margin-top:10px; font-weight:bold;">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="result-box" id="resultBox">
Â  Â  Â  Â  Â  Â  <div class="result-section" id="aiSection" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="section-title">ğŸ¤– AI ë°œìŒ ì²´í¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stt-result-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="sttResult" class="stt-text">...</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="accBadge" class="accuracy-badge acc-wait">ë¶„ì„ ëŒ€ê¸°ì¤‘</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="guide-text">* ì •í™•ë„ 30% ì´ìƒì´ë©´ í†µê³¼ì…ë‹ˆë‹¤.</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="result-section" id="recSection" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="section-title">ğŸ“‚ ë‚´ ë…¹ìŒ í™•ì¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  <audio id="myAudio" controls src="" style="width:100%;"></audio>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ë‚´ ì‹œê°„: <span id="myTime" class="time-val">0.0s</span>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:normal; color:#aaa; margin-left:10px;">(í”„ë¡œ: <span id="proTime">0.0s</span>)</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="train-nav" style="margin-top:20px;">
Â  Â  Â  Â  <button id="btn_prev" onclick="trainPrev()" disabled>â¬… ì´ì „</button>
Â  Â  Â  Â  <div id="step_indicator" style="font-weight:bold; color:#2ecc71; font-size:18px;">STEP 0</div>
Â  Â  Â  Â  <button id="btn_next" onclick="trainNext()" disabled>ë‹¤ìŒ â¡</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

<div id="recordDisplayBox" style="
Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;Â 
Â  Â  background: rgba(0,0,0,0.7); display: none; justify-content: center;Â 
Â  Â  align-items: center; z-index: 9999;
">
Â  Â  <div style="
Â  Â  Â  Â  background: white; padding: 30px; border-radius: 20px; max-width: 400px;Â 
Â  Â  Â  Â  width: 90%; box-shadow: 0 4px 30px rgba(0,0,0,0.5);
Â  Â  ">
Â  Â  Â  Â  <h3 id="recordDisplayDate" style="color: #2980b9; margin-top: 0;">ê¸°ë¡ ìƒì„¸</h3>
Â  Â  Â  Â  <p id="recordDisplayContent" style="
Â  Â  Â  Â  Â  Â  background: #f8f8f8; padding: 15px; border-radius: 10px;Â 
Â  Â  Â  Â  Â  Â  font-size: 16px; line-height: 1.5; word-break: break-all;
Â  Â  Â  Â  ">ì„ íƒëœ ë‚ ì§œì˜ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
Â  Â  Â  Â  <button onclick="document.getElementById('recordDisplayBox').style.display='none';" style="
Â  Â  Â  Â  Â  Â  width: 100%; padding: 10px; background: #e74c3c; color: white; border: none;Â 
Â  Â  Â  Â  Â  Â  border-radius: 10px; margin-top: 20px; cursor: pointer; font-weight: bold;
Â  Â  Â  Â  ">ë‹«ê¸°</button>
Â  Â  </div>
</div>
<div class="tab-content" id="tab4">
Â  Â  <div class="section">
Â  Â  Â  <div class="past-display-card">
Â  Â  Â  Â  <div id="pastRoleDisplay" class="past-role">ë²„íŠ¼ì„ ëˆŒëŸ¬ ëŒ€ë³¸ì„ ë½‘ì•„ì£¼ì„¸ìš”</div>
Â  Â  Â  Â  <div id="pastLinesDisplay" class="past-lines">-</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="btn-row">
Â  Â  Â  Â  <button class="btn-male" onclick="rollPastQuestion('male')">ğŸ‘±â€â™‚ï¸ ë‚¨ì ê¸°ì¶œ ë½‘ê¸°</button>
Â  Â  Â  Â  <button class="btn-female" onclick="rollPastQuestion('female')">ğŸ‘© ì—¬ì ê¸°ì¶œ ë½‘ê¸°</button>
Â  Â  Â  </div>

Â  Â  Â  <div class="record-box" id="pastRecordBox" style="display:block; margin-top:30px; border-top:2px dashed #eee; padding-top:20px;">
Â  Â  Â  Â  <div style="text-align:center; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  <p style="font-size:16px; font-weight:800; color:#333; margin-bottom:15px;">ğŸ™ï¸ ì‹¤ì „ ë…¹ìŒ ì—°ìŠµ</p>
Â  Â  Â  Â  Â  Â  <button id="pastMicBtn" class="mic-btn" onclick="togglePastRecord()">ğŸ¤</button>
Â  Â  Â  Â  Â  Â  <p id="pastRecStatus" style="font-size:14px; color:#555; margin-top:10px; font-weight:bold;">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="result-box" id="pastResultBox" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="result-section">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="section-title">ğŸ“‚ ë‚´ ë…¹ìŒ í™•ì¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  <audio id="pastAudio" controls src="" style="width:100%;"></audio>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ë…¹ìŒ ì‹œê°„: <span id="pastTime" class="time-val">0.0s</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  </div>
Â  </div>
</main>

<footer>
Â  Â  <b>ìƒë‹´ì „í™”</b> : 010-7372-5875 <br>
Â  Â  <b>ì£¼ì†Œ</b> : ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ì²­ëª…ë‚¨ë¡œ 28ë²ˆê¸¸ 2 ì•„ì´í…í…ë¹Œë”© 502í˜¸ <br>
Â  Â  Copyright Â© ìš¸ë¦¼ì—°ê¸°í•™ì›. All rights reserved.
</footer>
---
<script>

// --- [0. ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”] ---

// ê°•ì‚¬ IDê°€ ERRORë¡œ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ì•„ì˜ˆ ì§€ì›Œë²„ë¦¼
if (localStorage.getItem('instructorFolderId') === 'ERROR_ID_NOT_FOUND') {
    localStorage.removeItem('instructorFolderId');
}
let studentName = localStorage.getItem('studentName') || '';
let instructorName = localStorage.getItem('instructorName') || 'ê¸°ë³¸';
let phoneLast4 = localStorage.getItem('phoneLast4') || '';

let instructorFolderId = localStorage.getItem('instructorFolderId');
if (!instructorFolderId || instructorFolderId === 'ERROR_ID_NOT_FOUND') {
    instructorFolderId = '';
}
console.log("Loaded instructorFolderId:", instructorFolderId);
let currentFilenameBase = `${instructorName}_${studentName}_${phoneLast4}`;

// --- [1. GAS URL ì •ì˜] ---
const GET_API_URL = 'https://script.google.com/macros/s/AKfycbx7wQFuw6MqqOijmvuwpeiCWOk3xU3hr41xoKbRltQHLb1kLbr_1RD5Zzy3iuWcrhUD0A/exec';

const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxgIXZv73FmnG-r-JoWnBGcfjrzJZV3I6Zp5xmJbSheUrJ9pWc165UOxAn4HUD5hMpc9g/exec';

// --- [2. ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜] ---

// íŒŒì¼ëª… ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸ ì‹œ í˜¸ì¶œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.)
function updateFilenameConstants() {
    const filenameBase = `${instructorName}_${studentName}_${phoneLast4}`;
    currentFilenameBase = filenameBase.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\uAC00-\uD7A3]/g, '');
}

function pick(a){return a[Math.floor(Math.random()*a.length)];}

function downloadImage(dataUrl, filename='ìš¸ë¦¼_ë¯¸ì…˜.png') {
    const link = document.createElement('a');
    link.download = filename;
    link.href = dataUrl;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    alert("ì´ë¯¸ì§€ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!");
	}
	

function showLoading(message = "ì²˜ë¦¬ ì¤‘...") {
    let el = document.getElementById("loadingOverlay");
    if (!el) {
        el = document.createElement("div");
        el.id = "loadingOverlay";
        el.style.position = "fixed";
        el.style.top = "0";
        el.style.left = "0";
        el.style.width = "100%";
        el.style.height = "100%";
        el.style.background = "rgba(0,0,0,0.6)";
        el.style.display = "flex";
        el.style.alignItems = "center";
        el.style.justifyContent = "center";
        el.style.zIndex = "99999";
        el.style.color = "white";
        el.style.fontSize = "20px";
        document.body.appendChild(el);
    }
    el.textContent = message;
    el.style.display = "flex";
}

function hideLoading() {
    const el = document.getElementById("loadingOverlay");
    if (el) el.style.display = "none";
}

// --- [3. í•µì‹¬ ë¡œê·¸ì¸ ë° íƒ­ ì œì–´ ë¡œì§] ---

// [í•µì‹¬] ë©”ì¸ í™”ë©´ í‘œì‹œ ë° íƒ­ ì ‘ê·¼ ì œì–´ í•¨ìˆ˜
function showMainContent(isAuthenticated) {
    document.getElementById('loginOverlay').style.display = 'none';
    const wrapper = document.querySelector('.wrapper');
    wrapper.style.display = 'flex'; // ë©”ì¸ ì»¨í…ì¸  í‘œì‹œ
wrapper.style.flexDirection = 'column'; // ë©”ì¸ ì½˜í…ì¸ ê°€ ìˆ˜ì§ìœ¼ë¡œ ìŒ“ì´ë„ë¡ ë³´ì¥
    wrapper.style.alignItems = 'center'; // ì¤‘ì•™ ì •ë ¬ (margin: 0 autoì™€ í•¨ê»˜ ì‘ë™)
    const tabs = document.querySelectorAll('.tab');
    
    // íƒ­ 1 (ìƒí™©ê·¹)ì„ ê¸°ë³¸ í™œì„±í™”
    tabs[0].classList.add('active');
    document.getElementById('tab1').classList.add('active');

    // íƒ­ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¬ì •ì˜ (ì´ì „ íƒ­ ë¡œì§ì„ ì¬ì‚¬ìš©)
    const defaultTabClickHandler = (event) => {
        const clickedTab = event.currentTarget;
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        clickedTab.classList.add('active');
        document.getElementById(clickedTab.dataset.tab).classList.add('active');
    };

    for (let i = 1; i < tabs.length; i++) {
        const tabContent = document.getElementById(tabs[i].dataset.tab);
        tabs[i].onclick = null; // ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±°
        
        if (!isAuthenticated) {
            // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ: ë‚˜ë¨¸ì§€ íƒ­ ë¹„í™œì„±í™”
            tabs[i].onclick = () => alert("í•™ìƒ ì¸ì¦ í›„ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.");
            tabs[i].style.opacity = '0.5';
            tabs[i].style.pointerEvents = 'none';
            if(tabContent) tabContent.style.display = 'none';
        } else {
            // í•™ìƒ ëª¨ë“œ: ì •ìƒì ì¸ íƒ­ ì „í™˜ ê¸°ëŠ¥ ì¬í• ë‹¹
            tabs[i].onclick = defaultTabClickHandler;
            tabs[i].style.opacity = '1';
            tabs[i].style.pointerEvents = 'auto';
            if(tabContent) tabContent.style.display = 'none';
        }
    }
}

// ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ í•¨ìˆ˜
function guestLogin() {
    studentName = "ê²ŒìŠ¤íŠ¸";
    instructorName = "ê¸°ë³¸";
    phoneLast4 = "0000";
    localStorage.setItem('studentName', studentName);
    localStorage.setItem('instructorName', instructorName);
    localStorage.setItem('phoneLast4', phoneLast4);
    
    updateFilenameConstants();
    showMainContent(false); // ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ë©”ì¸ í™”ë©´ í‘œì‹œ
}

// GAS ì¸ì¦ ìš”ì²­ í•¨ìˆ˜
async function authenticate(name, phone) {
    showLoading("ì¸ì¦ ì •ë³´ í™•ì¸ ì¤‘...");
    const url = `${GET_API_URL}?name=${encodeURIComponent(name)}&phoneLast4=${phone}`;
    try {
        const response = await fetch(url);
        hideLoading();
        if (!response.ok) throw new Error(`GAS ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        const result = await response.json();

        if (result.status === 'success') {
            studentName = result.name;
            instructorName = result.instructor;
            phoneLast4 = result.phoneLast4;
            instructorFolderId = result.instructorFolderId;

            localStorage.setItem('studentName', studentName);
            localStorage.setItem('instructorName', instructorName);
            localStorage.setItem('phoneLast4', phoneLast4);
            localStorage.setItem('instructorFolderId', instructorFolderId && instructorFolderId.trim() !== "" ? instructorFolderId : 'ERROR_ID_NOT_FOUND');
            
            alert(`ì¸ì¦ ì„±ê³µ: ${studentName}ë‹˜ (${instructorName} ê°•ì‚¬)`);
            updateFilenameConstants();
            showMainContent(true); // í•™ìƒ ëª¨ë“œë¡œ ë©”ì¸ í™”ë©´ í‘œì‹œ
        } else {
            alert(`ì¸ì¦ ì‹¤íŒ¨: ${result.message}`);
        }
    } catch (e) {
        hideLoading();
        alert(`ì¸ì¦ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ: ${e.message}. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
    }
}

// ì¸í’‹ í•„ë“œì—ì„œ ê°’ì„ ê°€ì ¸ì™€ ì¸ì¦ì„ ì‹œë„í•˜ëŠ” í•¨ìˆ˜
async function authenticateStudentFromInputs() {
    const nameInput = document.getElementById('studentNameInput');
    const phoneInput = document.getElementById('phoneLast4Input');
    const name = nameInput.value.trim();
    const phone = phoneInput.value.trim();

    if (!name || !phone || phone.length !== 4) {
        alert("í•™ìƒ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }
    await authenticate(name, phone);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í•™ìƒ ì´ë¦„ ë° ì¸ì¦ í™•ì¸ ë¡œì§
async function checkStudentName() {
    const isValidStudent = studentName && phoneLast4 && instructorName !== 'ê¸°ë³¸';
    const isGuest = studentName === 'ê²ŒìŠ¤íŠ¸';
    
    if (isValidStudent) {
        updateFilenameConstants();
        showMainContent(true); 
    } else if (isGuest) {
        updateFilenameConstants();
        showMainContent(false);
    } else {
        document.getElementById('loginOverlay').style.display = 'flex';
        document.querySelector('.wrapper').style.display = 'none';
    }
}

// =========================================================================================
// â­ 4. GAS í†µì‹  í•¨ìˆ˜ (Base64 ì¸ì½”ë”© ë° ì—…ë¡œë“œ ë¡œì§ í¬í•¨) â­
// =========================================================================================

// Blob ë°ì´í„°ë¥¼ Base64 ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function blobToBase64(blob) {
Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.readAsDataURL(blob);
Â  Â  Â  Â  reader.onloadend = () => {
Â  Â  Â  Â  Â  Â  const base64String = reader.result.split(',')[1];
Â  Â  Â  Â  Â  Â  // GASëŠ” ì•½ 50MB ì œí•œ (Base64 ì¸ì½”ë”© í›„ í¬ê¸°)
Â  Â  Â  Â  Â  Â  if (base64String.length * 0.75 > 45 * 1024 * 1024) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error("File size is too large for GAS limit."));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  resolve(base64String);
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.onerror = reject;
Â  Â  });
}

// ë…¹ìŒ íŒŒì¼ì„ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œí•˜ê³  ì‹œíŠ¸ì— ë§í¬ë¥¼ ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜
async function uploadAudioToDriveAndLog(vocalId, sentenceText, base64Data, mimeType, action) {
Â  Â  if (!GOOGLE_APP_SCRIPT_URL || GOOGLE_APP_SCRIPT_URL.includes('YOUR_DEPLOYED_GAS_URL_HERE')) {
Â  Â  Â  Â  console.warn("Google Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ì´í„° ì „ì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // GASë¡œ ì „ì†¡í•  í˜ì´ë¡œë“œ êµ¬ì„±
Â  Â  const payload = {
Â  Â  Â  Â  name: studentName,
Â  Â  Â  Â  vocalId: vocalId,
Â  Â  Â  Â  sentence: sentenceText,
Â  Â  Â  Â  action: action,Â 
Â  Â  Â  Â  audioData: base64Data,Â 
Â  Â  Â  Â  mimeType: mimeType,
Â  Â  Â  Â  // â­ GASê°€ í´ë” ë° íŒŒì¼ëª… ìƒì„±ì„ ìœ„í•´ ì‚¬ìš©í•  ë°ì´í„° â­
Â  Â  Â  Â  fileNameBase: currentFilenameBase,Â 
Â  Â  Â  Â  instructor: instructorName,Â  Â  Â  Â 
		instructorFolderId: instructorFolderId
Â  Â  };

Â  Â  try {
Â  Â  Â  Â  await fetch(GOOGLE_APP_SCRIPT_URL, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  mode: 'no-cors',Â 
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log('Drive upload and Sheet logging attempted.');
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Drive upload failed:', error);
Â  Â  }
}

// íŒŒì¼ ì—…ë¡œë“œ ì—†ì´ ë©”íƒ€ë°ì´í„°ë§Œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜ (ì—°ìŠµ ì™„ë£Œ ë²„íŠ¼ ìš©)
async function sendToGoogleSheet(vocalId, sentenceText, action) {
Â  Â  if (!GOOGLE_APP_SCRIPT_URL || GOOGLE_APP_SCRIPT_URL.includes('YOUR_DEPLOYED_GAS_URL_HERE')) {
Â  Â  Â  Â  console.warn("Google Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ì´í„° ì „ì†¡ì„ ê±´ë„ˆí‚µë‹ˆë‹¤.");
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  const payload = {
Â  Â  Â  Â  name: studentName,
Â  Â  Â  Â  vocalId: vocalId,
Â  Â  Â  Â  sentence: sentenceText,
Â  Â  Â  Â  action: action,Â 
Â  Â  Â  Â  // ì˜¤ë””ì˜¤ ë°ì´í„°ëŠ” í¬í•¨í•˜ì§€ ì•ŠìŒ
Â  Â  };

Â  Â  try {
Â  Â  Â  Â  await fetch(GOOGLE_APP_SCRIPT_URL, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  mode: 'no-cors',Â 
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log('Google Sheet submission attempted.');
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Google Sheet submission failed:', error);
Â  Â  }
}


// =========================================================================================
// â­ 5. íƒ­ 1 (ìƒí™©ê·¹) ë¡œì§ â­
// =========================================================================================

const defaultEtude = { colors: [], places: [], emotions: [], relations: [], actions: [], lines: [] };
const eData = (typeof etudeData !== 'undefined') ? etudeData : defaultEtude;

let locks = {color:false, place:false, emotion:false, relation:false, action:false, line:false};
let currentData = {c:{name:"ìƒ‰ìƒ",code:"#ddd"}, p:"-", e:"-", r:"-", a:"-", l:"ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”"};
let missionCount = 0;

function toggleLock(key){
Â  Â  locks[key] = !locks[key];
Â  Â  const btn = document.getElementById('lock-'+key);
Â  Â  btn.textContent = locks[key] ? "ğŸ”’" : "ğŸ”“";
Â  Â  btn.classList.toggle("locked");
}

async function rollScene(){
Â  Â  const btn = document.getElementById('btnGen'); btn.disabled = true;
Â  Â  const newC = locks.color ? currentData.c : pick(eData.colors || []);
Â  Â  const newP = locks.place ? currentData.p : pick(eData.places || []);
Â  Â  const newE = locks.emotion ? currentData.e : pick(eData.emotions || []);
Â  Â  const newR = locks.relation ? currentData.r : pick(eData.relations || []);
Â  Â  const newA = locks.action ? currentData.a : pick(eData.actions || []);
Â  Â  const newL = locks.line ? currentData.l : pick(eData.lines || []);
Â  Â Â 
Â  Â  currentData = {c:newC, p:newP, e:newE, r:newR, a:newA, l:newL};

Â  Â  const promises = [];
Â  Â  if(!locks.color && eData.colors) promises.push(spinColor(newC, 600));
Â  Â  if(!locks.place && eData.places) promises.push(spinText('placeDisplay', eData.places, newP, 1000));
Â  Â  if(!locks.emotion && eData.emotions) promises.push(spinText('emotionDisplay', eData.emotions, newE, 1400));
Â  Â  if(!locks.relation && eData.relations) promises.push(spinText('relationDisplay', eData.relations, newR, 1800));
Â  Â  if(!locks.action && eData.actions) promises.push(spinText('actionDisplay', eData.actions, newA, 2200));
Â  Â  if(!locks.line && eData.lines) promises.push(spinText('lineDisplay', eData.lines, newL, 2600));
Â  Â Â 
Â  Â  await Promise.all(promises);
Â  Â  btn.disabled = false;
}

function spinText(id, arr, val, dur){
Â  Â  return new Promise(r => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  const start = Date.now();
Â  Â  Â  Â  const int = setInterval(()=>{
Â  Â  Â  Â  Â  Â  if(Date.now()-start > dur){ clearInterval(int); el.textContent=val; r(); }
Â  Â  Â  Â  Â  Â  else el.textContent = pick(arr);
Â  Â  Â  Â  }, 50);
Â  Â  });
}
function spinColor(val, dur){
Â  Â  return new Promise(r => {
Â  Â  Â  Â  const bg = document.getElementById('colorBg');
Â  Â  Â  Â  const text = document.getElementById('colorText');
Â  Â  Â  Â  const start = Date.now();
Â  Â  Â  Â  const int = setInterval(()=>{
Â  Â  Â  Â  Â  Â  if(Date.now()-start > dur){Â 
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(int);Â 
Â  Â  Â  Â  Â  Â  Â  Â  bg.style.backgroundColor=val.code;Â 
Â  Â  Â  Â  Â  Â  Â  Â  text.textContent=val.name;Â 
Â  Â  Â  Â  Â  Â  Â  Â  r();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const t=pick(eData.colors || []);Â 
Â  Â  Â  Â  Â  Â  Â  Â  bg.style.backgroundColor=t.code;Â 
Â  Â  Â  Â  Â  Â  Â  Â  text.textContent=t.name;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 50);
Â  Â  });
}

function saveScene(){
Â  Â  if(currentData.l === "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”") return alert("ë¨¼ì € ëœë¤ ë½‘ê¸°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!");
Â  Â  missionCount++;
Â  Â  const div = document.createElement("div"); div.className="mission-card";
Â  Â  div.innerHTML = `
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px;">
Â  Â  Â  Â  Â  Â  <input type="text" class="mission-title-input" value="ë¯¸ì…˜ ${missionCount}">
Â  Â  Â  Â  Â  Â  <span style="background:${currentData.c.code}; color:#fff; padding:4px 8px; border-radius:8px; font-size:12px; font-weight:bold;">${currentData.c.name}</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ì¥ì†Œ:</strong> ${currentData.p}</div>
Â  Â  Â  Â  <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ê°ì •:</strong> ${currentData.e}</div>
Â  Â  Â  Â  <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ê´€ê³„:</strong> ${currentData.r}</div>
Â  Â  Â  Â  <div style="font-size:14px; color:#555; margin-bottom:10px;"><strong>í–‰ë™:</strong> ${currentData.a}</div>
Â  Â  Â  Â  <div style="background:#f8f9fa; padding:10px; border-radius:8px; font-weight:800; color:#333; word-break:keep-all;">"${currentData.l}"</div>
Â  Â  `;
Â  Â  document.getElementById("missionGrid").prepend(div);
}

// ìƒí™©ê·¹ ë¯¸ì…˜ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥ ë° ê³µìœ í•˜ëŠ” í•¨ìˆ˜
function shareSceneAsImage() {
Â  Â  const targetElement = document.querySelector('.scene-main-card');

Â  Â  if (currentData.l === "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”") {
Â  Â  Â  Â  return alert("ë¨¼ì € 'ëœë¤ ë½‘ê¸°'ë¥¼ ì§„í–‰í•´ì•¼ ì´ë¯¸ì§€ ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
Â  Â  }

Â  Â  html2canvas(targetElement, {
Â  Â  Â  Â  allowTaint: true,
Â  Â  Â  Â  useCORS: true,
Â  Â  Â  Â  scale: 2
Â  Â  }).then(canvas => {
Â  Â  Â  Â  const imageURL = canvas.toDataURL("image/png");

Â  Â  Â  Â  if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], 'image.png', {type: 'image/png'})] })) {
Â  Â  Â  Â  Â  Â  canvas.toBlob(function(blob) {
Â  Â  Â  Â  Â  Â  Â  Â  const filesArray = [new File([blob], 'scene-mission.png', {type: 'image/png'})];
Â  Â  Â  Â  Â  Â  Â  Â  navigator.share({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  files: filesArray,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'ìš¸ë¦¼ì—°ê¸°í•™ì› ìƒí™©ê·¹ ë¯¸ì…˜',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'ì˜¤ëŠ˜ì˜ ìƒí™©ê·¹ ë¯¸ì…˜ì„ ê³µìœ í•©ë‹ˆë‹¤! ğŸ­'
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Sharing failed, attempting download:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadImage(imageURL, 'ìš¸ë¦¼_ìƒí™©ê·¹_ë¯¸ì…˜.png');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }, 'image/png');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  downloadImage(imageURL, 'ìš¸ë¦¼_ìƒí™©ê·¹_ë¯¸ì…˜.png');
Â  Â  Â  Â  }
Â  Â  });
}


// =========================================================================================
// â­ 6. íƒ­ 2 (ìºë¦­í„°) ë¡œì§ â­
// =========================================================================================

let currentChar = null;
function rollCharacter(gender) {
Â  Â  // ì„ì‹œ ë°ì´í„° (ì´ë¯¸ì§€ ì—†ì„ë•Œ ëŒ€ë¹„)
Â  Â  const list = gender === 'male' ? [{name:"ë‚¨ì„±ìºë¦­í„°", job:"ì§ì—…", desc:"ì„¤ëª…", id:1}] : [{name:"ì—¬ì„±ìºë¦­í„°", job:"ì§ì—…", desc:"ì„¤ëª…", id:1}];
Â  Â  const char = pick(list);Â 
Â  Â  currentChar = char; // ìºë¦­í„° ì •ë³´ ì €ì¥

Â  Â  const imgEl = document.getElementById("charImgDisplay");
Â  Â  const placeholderEl = document.querySelector(".char-placeholder");
Â  Â Â 
Â  Â  // ë¡œì»¬ ê²½ë¡œ í…ŒìŠ¤íŠ¸ìš© (ëœë¤ ì´ë¯¸ì§€ ê²½ë¡œ)
Â  Â  const folder = gender === 'male' ? 'male' : 'female';
Â  Â  const newSrc = `appdata/character/${folder}/${Math.floor(Math.random()*10)+1}.jpg`;Â 

Â  Â  // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ í›„ í‘œì‹œ
Â  Â  imgEl.onload = function(){
Â  Â  Â  Â  placeholderEl.style.display = 'none';
Â  Â  Â  Â  this.style.display = 'block';
Â  Â  };
Â  Â  imgEl.onerror = function(){
Â  Â  Â  Â  // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
Â  Â  Â  Â  this.style.display = 'none';
Â  Â  Â  Â  placeholderEl.style.display = 'block';
Â  Â  };
Â  Â Â 
Â  Â  imgEl.src = newSrc; // ìƒˆë¡œìš´ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
Â  Â Â 
Â  Â  // í…ìŠ¤íŠ¸ ëœë¤
Â  Â  document.getElementById("charNameDisplay").textContent = "ëœë¤ ìºë¦­í„°";
Â  Â  document.getElementById("charJobDisplay").textContent = "ëœë¤ ì§ì—…";
Â  Â  document.getElementById("charDescDisplay").textContent = "ìƒˆë¡œìš´ ìºë¦­í„°ê°€ ì†Œí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
}

// ìˆ˜ì •ëœ saveCharacter() í•¨ìˆ˜: ì´ë¯¸ì§€ì™€ ì´ë¦„ì„ ë³µì œí•˜ì—¬ ì €ì¥ ê·¸ë¦¬ë“œì— ì¶”ê°€
function saveCharacter(){
Â  Â  const charName = document.getElementById("charNameDisplay").textContent;
Â  Â  const charImgSrc = document.getElementById("charImgDisplay").src;
Â  Â  const isImageVisible = document.getElementById("charImgDisplay").style.display !== 'none';
Â  Â Â 
Â  Â  if (charName === "ìºë¦­í„° ì´ë¦„") {
Â  Â  Â  Â  return alert("ë¨¼ì € 'ë‚¨ì ë½‘ê¸°' ë˜ëŠ” 'ì—¬ì ë½‘ê¸°'ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!");
Â  Â  }
Â  Â Â 
Â  Â  const div = document.createElement("div"); div.className="mini-char-card";
Â  Â Â 
Â  Â  let imageHtml;
Â  Â  if (isImageVisible && charImgSrc && charImgSrc.includes('appdata/character')) {
Â  Â  Â  Â  // ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë  ë•Œë§Œ mini-char-imgë¥¼ ì‚¬ìš©
Â  Â  Â  Â  imageHtml = `<img src="${charImgSrc}" class="mini-char-img" alt="${charName}">`;
Â  Â  } else {
Â  Â  Â  Â  // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ë•ŒëŠ” íšŒìƒ‰ ë°°ê²½ ìœ ì§€
Â  Â  Â  Â  imageHtml = `<div class="mini-char-img" style="display:flex; justify-content:center; align-items:center; color:#fff; font-size:10px;">ì´ë¯¸ì§€ ì—†ìŒ</div>`;
Â  Â  }

Â  Â  div.innerHTML = `
Â  Â  Â  Â  ${imageHtml}
Â  Â  Â  Â  <div class="mini-char-info">
Â  Â  Â  Â  Â  Â  ${charName}
Â  Â  Â  Â  </div>
Â  Â  `;
Â  Â Â 
Â  Â  document.getElementById("charSaveGrid").prepend(div);
}

// ìºë¦­í„° ë¯¸ì…˜ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥ ë° ê³µìœ í•˜ëŠ” í•¨ìˆ˜
function shareCharacterAsImage() {
Â  Â  const targetElement = document.querySelector('#characterCard');
Â  Â  const charName = document.getElementById("charNameDisplay").textContent;

Â  Â  if (charName === "ìºë¦­í„° ì´ë¦„") {
Â  Â  Â  Â  return alert("ë¨¼ì € 'ë‚¨ì ë½‘ê¸°' ë˜ëŠ” 'ì—¬ì ë½‘ê¸°'ë¥¼ ì§„í–‰í•´ì•¼ ì´ë¯¸ì§€ ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
Â  Â  }
Â  Â Â 
Â  Â  const charImg = document.getElementById("charImgDisplay");
Â  Â Â 
Â  Â  // ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëŒ€ê¸° (ì•ˆì „ì„± ê°•í™”)
Â  Â  if(charImg.style.display === 'none' || !charImg.complete) {
Â  Â  Â  Â  return alert("ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
Â  Â  }
Â  Â Â 
Â  Â  // html2canvas ì‹¤í–‰
Â  Â  html2canvas(targetElement, {
Â  Â  Â  Â  allowTaint: true,
Â  Â  Â  Â  useCORS: true,
Â  Â  Â  Â  scale: 2
Â  Â  }).then(canvas => {
Â  Â  Â  Â  const imageURL = canvas.toDataURL("image/png");
Â  Â  Â  Â  const filename = `ìš¸ë¦¼_ìºë¦­í„°_ë¯¸ì…˜_${charName}.png`;

Â  Â  Â  Â  if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], filename, {type: 'image/png'})] })) {
Â  Â  Â  Â  Â  Â  // Web Share API ì§€ì› ì‹œ ê³µìœ 
Â  Â  Â  Â  Â  Â  canvas.toBlob(function(blob) {
Â  Â  Â  Â  Â  Â  Â  Â  const filesArray = [new File([blob], filename, {type: 'image/png'})];
Â  Â  Â  Â  Â  Â  Â  Â  navigator.share({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  files: filesArray,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'ìš¸ë¦¼ì—°ê¸°í•™ì› ìºë¦­í„° ë¯¸ì…˜',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: `ì˜¤ëŠ˜ì˜ ìºë¦­í„° ë¯¸ì…˜ (${charName})ì„ ê³µìœ í•©ë‹ˆë‹¤! ğŸ¨`
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Sharing failed, attempting download:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadImage(imageURL, filename);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }, 'image/png');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // ì§€ì›í•˜ì§€ ì•Šì„ ì‹œ ë‹¤ìš´ë¡œë“œ
Â  Â  Â  Â  Â  Â  downloadImage(imageURL, filename);
Â  Â  Â  Â  }
Â  Â  }).catch(error => {
Â  Â  Â  Â  console.error('HTML2Canvas Error:', error);
Â  Â  Â  Â  alert('ì´ë¯¸ì§€ ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì„œë²„ í™˜ê²½ì—ì„œ ì‹¤í–‰í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”)');
Â  Â  });
}


// =========================================================================================
// â­ 7. íƒ­ 3 (ë°œì„±í›ˆë ¨) ë¡œì§ â­
// =========================================================================================

let step=0, currentTrainObj=null;
let mediaRecorder, audioChunks = [], isRecording = false, startTime;
let recognition;
let recognitionResult = "";
let lastRecordedBlob = null; // ë…¹ìŒëœ ì˜¤ë””ì˜¤ Blob ì €ì¥ ë³€ìˆ˜

// 0. ì‹œìŠ¤í…œ ì§„ë‹¨ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const isSpeechSupported = ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window);

// 1. ìœ ì‚¬ë„ ê³„ì‚° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
function getSimilarity(s1, s2) {
Â  Â  const longer = s1.length > s2.length ? s1 : s2;
Â  Â  const shorter = s1.length > s2.length ? s2 : s1;
Â  Â  if (longer.length === 0) return 1.0;
Â  Â  return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
}
function editDistance(s1, s2) {
Â  Â  s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
Â  Â  const costs = new Array();
Â  Â  for (let i = 0; i <= s1.length; i++) {
Â  Â  Â  Â  let lastValue = i;
Â  Â  Â  Â  for (let j = 0; j <= s2.length; j++) {
Â  Â  Â  Â  Â  Â  if (i == 0) costs[j] = j;
Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  if (j > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let newValue = costs[j - 1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  costs[j - 1] = lastValue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if (i > 0) costs[s2.length] = lastValue;
Â  Â  }
Â  Â  return costs[s2.length];
}

// 2. ìŒì„±ì¸ì‹ ì´ˆê¸°í™” (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
if (isSpeechSupported && !isIOS) {
Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  recognition = new SpeechRecognition();
Â  Â  recognition.lang = 'ko-KR';
Â  Â  recognition.interimResults = false;
Â  Â  recognition.continuous = false;Â 

Â  Â  recognition.onresult = function(event) {
Â  Â  Â  Â  recognitionResult = event.results[0][0].transcript;
Â  Â  Â  Â  updateRecognitionUI();Â 
Â  Â  };
Â  Â  recognition.onerror = function(event) { console.log("STT error:", event.error); };
}

function updateRecognitionUI() {
Â  Â  if(recognitionResult) {
Â  Â  Â  Â  document.getElementById('sttResult').textContent = `"${recognitionResult}"`;
Â  Â  Â  Â  const targetClean = currentTrainObj.text.replace(/[^ê°€-í£]/g, '');
Â  Â  Â  Â  const inputClean = recognitionResult.replace(/[^ê°€-í£]/g, '');
Â  Â  Â  Â  const similarity = getSimilarity(targetClean, inputClean);
Â  Â  Â  Â  const badge = document.getElementById('accBadge');
Â  Â  Â  Â  if (similarity >= 0.7) {Â 
Â  Â  Â  Â  Â  Â  badge.className = 'accuracy-badge acc-good'; badge.textContent = 'ì™„ë²½í•©ë‹ˆë‹¤! (70%â†‘)';
Â  Â  Â  Â  } else if (similarity >= 0.3) {Â 
Â  Â  Â  Â  Â  Â  badge.className = 'accuracy-badge acc-soso'; badge.textContent = 'í†µê³¼ (30%â†‘)';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  badge.className = 'accuracy-badge acc-bad'; badge.textContent = 'ë‹¤ì‹œ ì‹œë„';
Â  Â  Â  Â  }
Â  Â  }
}

function extractVowels(s){
Â  Â  const V=["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
Â  Â  let out="";
Â  Â  for(let ch of s){
Â  Â  Â  Â  const code = ch.charCodeAt(0);
Â  Â  Â  Â  if(code<0xac00||code>0xd7a3) { out+=ch; continue; }
Â  Â  Â  Â  out+=V[Math.floor((code-0xac00)/28)%21];
Â  Â  }
Â  Â  return out;
}

// í›ˆë ¨ ë°ì´í„° ë° ë¡œì»¬ ì €ì¥ì†Œ ê´€ë ¨ í•¨ìˆ˜
const defaultVocalData = [{ id: 1, text: "ë°ì´í„° ë¡œë”©ì¤‘...", pron: "...", audio: "" }];
let trainDataList = (typeof vocalData !== 'undefined') ? vocalData : defaultVocalData;

// [1] ì €ì¥ëœ ë¬¸ì¥ IDë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜´
function getSavedVocalIds() {
Â  Â  const ids = localStorage.getItem('savedVocalIds');
Â  Â  return ids ? new Set(JSON.parse(ids)) : new Set();
}

// [2] ì¶œì„ ë° ë¬¸ì¥ ê¸°ë¡ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜´ (Map í˜•íƒœë¡œ ë°˜í™˜)
function getVocalRecords() {
Â  Â  const records = localStorage.getItem('vocalRecords');
Â  Â  return records ? new Map(JSON.parse(records)) : new Map();
}

// [3] ë¬¸ì¥ ì €ì¥ ë° ì—°ìŠµ ì™„ë£Œ ê¸°ë¡ (âœ… ì—°ìŠµ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ)
async function completeTraining() {
Â  Â  const btnComplete = document.getElementById('btnComplete');

Â  Â  if (step !== 7 || !currentTrainObj) {
Â  Â  Â  Â  return alert("STEP 7ì—ì„œ ë…¹ìŒì„ ì™„ë£Œí•´ì•¼ ì—°ìŠµì™„ë£Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
Â  Â  }

Â  Â  if (!lastRecordedBlob) {
Â  Â  Â  Â  return alert("ë…¹ìŒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. STEP 7ì—ì„œ ë…¹ìŒ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
Â  Â  }

Â  Â  // ë¡œë”© UI í‘œì‹œ
Â  Â  showLoading("ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ì¤‘...");

Â  Â  const today = new Date().toISOString().slice(0, 10);
Â  Â  const savedIds = getSavedVocalIds();
Â  Â  const records = getVocalRecords();
Â  Â  const truncatedText = currentTrainObj.text.substring(0, 30) + "...";

Â  Â  if (records.has(today)) {
Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  return alert("ì˜¤ëŠ˜ì€ ì´ë¯¸ ì—°ìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!");
Â  Â  }

Â  Â  // ë¡œì»¬ ê¸°ë¡ ì €ì¥
Â  Â  savedIds.add(currentTrainObj.id);
Â  Â  localStorage.setItem('savedVocalIds', JSON.stringify(Array.from(savedIds)));

Â  Â  records.set(today, {
Â  Â  Â  Â  id: currentTrainObj.id,
Â  Â  Â  Â  text: truncatedText,
Â  Â  Â  Â  completed: true
Â  Â  });
Â  Â  localStorage.setItem('vocalRecords', JSON.stringify(Array.from(records.entries())));

Â  Â  // ì‹œíŠ¸ ë©”íƒ€ë°ì´í„° ì €ì¥
Â  Â  await sendToGoogleSheet(currentTrainObj.id, truncatedText, "ì—°ìŠµ ì™„ë£Œ ì²´í¬");

Â  Â  // Blob â†’ Base64
Â  Â  const mimeType = lastRecordedBlob.type;
Â  Â  const base64Data = await blobToBase64(lastRecordedBlob).catch(err => {
Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  console.error("Base64 Encoding Error:", err);
Â  Â  Â  Â  alert("ë…¹ìŒ íŒŒì¼ ì¸ì½”ë”© ì‹¤íŒ¨. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
Â  Â  Â  Â  return null;
Â  Â  });
Â  Â  if (!base64Data) return;

Â  Â  // ì—…ë¡œë“œ + ì‹œíŠ¸ ë§í¬ ê¸°ë¡
Â  Â  await uploadAudioToDriveAndLog(
Â  Â  Â  Â  currentTrainObj.id,
Â  Â  Â  Â  truncatedText,
Â  Â  Â  Â  base64Data,
Â  Â  Â  Â  mimeType,
Â  Â  Â  Â  "ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ë° ë§í¬ ê¸°ë¡"
Â  Â  );

Â  Â  hideLoading();
Â  Â  alert("ì—°ìŠµ ì™„ë£Œ!ë§¤ì¼ë§¤ì¼ ê¾¸ì¤€íˆ í™”ì´íŒ…!");

Â  Â  // UI ì—…ë°ì´íŠ¸
Â  Â  const calendarArea = document.getElementById('calendarDisplayArea');
Â  Â  if (calendarArea.style.display === 'none') {
Â  Â  Â  Â  toggleCalendar();
Â  Â  } else {
Â  Â  Â  Â  renderCalendar();
Â  Â  }

Â  Â  btnComplete.style.display = 'none';
}



function trainNew(){
Â  Â  if(typeof vocalData !== 'undefined') trainDataList = vocalData;
Â  Â Â 
Â  Â  // ìƒˆ ë¬¸ì¥ ë½‘ì„ ë•Œ ë‹¬ë ¥ ìˆ¨ê¸°ê¸°
Â  Â  document.getElementById('calendarDisplayArea').style.display = 'none';Â 
Â  Â Â 
Â  Â  const savedIds = getSavedVocalIds();
Â  Â Â 
Â  Â  const availableData = trainDataList.filter(item => !savedIds.has(item.id));

Â  Â  if (availableData.length === 0) {
Â  Â  Â  Â  if (trainDataList.length > 0) {
Â  Â  Â  Â  Â  Â  return alert("ëª¨ë“  ë¬¸ì¥(" + trainDataList.length + "ê°œ)ì„ ì—°ìŠµí–ˆìŠµë‹ˆë‹¤! [F12] ê°œë°œì ë„êµ¬ > Application > Local Storage ì—ì„œ 'savedVocalIds'ë¥¼ ì‚­ì œí•´ì•¼ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.");
Â  Â  Â  Â  }
Â  Â  Â  Â  return alert("ë¬¸ì¥ ë°ì´í„°(appdata/vocalization/data.js)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  }
Â  Â Â 
Â  Â  currentTrainObj = pick(availableData); // ì œì™¸ëœ ë¬¸ì¥ ì¤‘ì—ì„œ ëœë¤ìœ¼ë¡œ ë½‘ê¸°
Â  Â  step=1;
Â  Â  // ìƒˆ ë¬¸ì¥ ë½‘ìœ¼ë©´ ë²„íŠ¼ í™œì„±í™” ë° UI ë Œë”ë§ ì‹œì‘
Â  Â  document.getElementById("btn_prev").disabled = true; // ì´ì „ ë²„íŠ¼ ë¹„í™œì„±í™” (STEP 1)
Â  Â  document.getElementById("btn_next").disabled = false; // ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
Â  Â Â 
Â  Â  document.getElementById("train_origin").textContent = currentTrainObj.text;Â 
Â  Â  document.getElementById("recordBox").style.display = 'none';
Â  Â  const proAudio = document.getElementById("proAudio");
Â  Â  proAudio.src = currentTrainObj.audio || "";Â 
Â  Â  proAudio.onloadedmetadata = function() {
Â  Â  Â  Â  document.getElementById("proTime").textContent = proAudio.duration.toFixed(1) + "s";
Â  Â  };
Â  Â  lastRecordedBlob = null; // ìƒˆ ë¬¸ì¥ ë½‘ì„ ë•Œ ë…¹ìŒ ì´ˆê¸°í™”
Â  Â  renderTrain();
}

// ë‹¨ê³„ ì´ë™ í•¨ìˆ˜
function trainPrev(){Â 
Â  Â  if(step>1) {
Â  Â  Â  Â  step--;Â 
Â  Â  Â  Â  renderTrain();
Â  Â  }Â 
}
function trainNext(){Â 
Â  Â  if(step<7) {
Â  Â  Â  Â  step++;Â 
Â  Â  Â  Â  renderTrain();
Â  Â  }
}

// ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë° UI ë Œë”ë§
function renderTrain(){
Â  Â  const box = document.getElementById("train_card");
Â  Â  const ind = document.getElementById("step_indicator");
Â  Â  const btnComplete = document.getElementById('btnComplete');Â 
Â  Â Â 
Â  Â  const btnPrev = document.getElementById("btn_prev");
Â  Â  const btnNext = document.getElementById("btn_next");

Â  Â  const T=["","STEP1 ëª¨ìŒì„ í˜¸í¡ìœ¼ë¡œ","STEP2 ëª¨ìŒì„ ì†Œë¦¬ë¡œ","STEP3 ììŒê³¼ í•¨ê»˜ í˜¸í¡ìœ¼ë¡œ ì½ê¸°","STEP4 ììŒê³¼ í•¨ê»˜ ì†Œë¦¬ë‚´ì–´ ì½ê¸°","STEP5 ìì—°ìŠ¤ëŸ½ê²Œ í˜¸í¡ìœ¼ë¡œ ì½ê¸°", "STEP6 ë°œìŒ AI ì²´í¬","STEP7 ìµœì¢… ë…¹ìŒ"];
Â  Â  const D=["","ëª¨ìŒ ì…ëª¨ì–‘ ì‹ ê²½ì“°ë©° í˜¸í¡ìœ¼ë¡œ í•œê¸€ìì”© ì½ê¸°","ëª¨ìŒ ì…ëª¨ì–‘ ì‹ ê²½ì“°ë©° ì†Œë¦¬ë‚´ì–´ í•œê¸€ìì”© ì½ê¸°","ììŒê³¼ í•¨ê»˜ ì…ëª¨ì–‘ì„ ì‹ ê²½ì“°ë©° í•œê¸€ìì”© í˜¸í¡ìœ¼ë¡œ ì½ê¸°","ììŒê³¼ í•¨ê»˜ ì…ëª¨ì–‘ì„ ì‹ ê²½ì“°ë©° í•œê¸€ìì”© ì†Œë¦¬ë‚´ì–´ë¡œ ì½ê¸°","ìì—°ìŠ¤ëŸ½ê²Œ í•œë¬¸ì¥ì„ í•œ í˜¸í¡ìœ¼ë¡œ ì½ê¸°","AIê°€ ë°œìŒ ì •í™•ë„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.","ìµœì¢… ê²°ê³¼ë¬¼ì„ ë…¹ìŒí•˜ê³  ë“¤ì–´ë³´ì„¸ìš”."];

Â  Â  if (!currentTrainObj) {
Â  Â  Â  Â  step = 0;
Â  Â  Â  Â  ind.textContent="STEP 0";
Â  Â  Â  Â  box.innerHTML=`<p style="color:#aaa;">'ìƒˆ ë¬¸ì¥ ë½‘ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>`;
Â  Â  Â  Â  btnPrev.disabled = true;
Â  Â  Â  Â  btnNext.disabled = true;
Â  Â  Â  Â  btnComplete.style.display = 'none';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  let showText = "";
Â  Â  if (step <= 2) { showText = extractVowels(currentTrainObj.text); }
Â  Â  else if (step <= 7) { showText = currentTrainObj.pron; }Â 

Â  Â  ind.textContent="STEP "+step;
Â  Â  box.innerHTML=
Â  Â  Â  Â  `<div style='font-size:20px; font-weight:900; margin-bottom:10px;'>${T[step]}</div>
Â  Â  Â  Â  Â <div style='color:#666; margin-bottom:20px; font-size:15px;'>${D[step]}</div>
Â  Â  Â  Â  Â <div class='train-main-text'>${showText}</div>`;

Â  Â  btnPrev.disabled = (step === 1);
Â  Â  btnNext.disabled = (step === 7);

Â  Â  const recBox = document.getElementById("recordBox");
Â  Â  const micBtn = document.getElementById("micBtn");
Â  Â  const recStatus = document.getElementById("recStatus");
Â  Â  const aiSection = document.getElementById("aiSection");
Â  Â  const recSection = document.getElementById("recSection");
Â  Â Â 
Â  Â  btnComplete.style.display = (step === 7) ? 'flex' : 'none';

Â  Â  if(step === 6) {
Â  Â  Â  Â  recBox.style.display = 'block';
Â  Â  Â  Â  micBtn.textContent = 'ğŸ—£ï¸';
Â  Â  Â  Â  recStatus.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ AI ì²´í¬ ì‹œì‘";
Â  Â  Â  Â  aiSection.style.display = 'block';
Â  Â  Â  Â  recSection.style.display = 'none';
Â  Â  Â  Â  document.getElementById("resultBox").style.display = 'none';
Â  Â  } else if (step === 7) {
Â  Â  Â  Â  recBox.style.display = 'block';
Â  Â  Â  Â  micBtn.textContent = 'ğŸ¤';
Â  Â  Â  Â  recStatus.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘";
Â  Â  Â  Â  aiSection.style.display = 'none';
Â  Â  Â  Â  recSection.style.display = 'block';
Â  Â  Â  Â  document.getElementById("resultBox").style.display = 'none';
Â  Â  } else {
Â  Â  Â  Â  recBox.style.display = 'none';
Â  Â  }
}

// ë‹¬ë ¥ í¼ì¹˜ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€ í•¨ìˆ˜
function toggleCalendar() {
Â  Â  const calendarArea = document.getElementById('calendarDisplayArea');
Â  Â  if (calendarArea.style.display === 'none') {
Â  Â  Â  Â  renderCalendar();Â 
Â  Â  Â  Â  calendarArea.style.display = 'block';
Â  Â  } else {
Â  Â  Â  Â  calendarArea.style.display = 'none';Â 
Â  Â  }
}


// ë‹¬ë ¥ ë Œë”ë§ ë¡œì§
function renderCalendar(year, month) {
Â  Â  const today = new Date();
Â  Â  const currentYear = year || today.getFullYear();
Â  Â  const currentMonth = month !== undefined ? month : today.getMonth();Â 
Â  Â Â 
Â  Â  const firstDay = new Date(currentYear, currentMonth, 1);
Â  Â  const lastDay = new Date(currentYear, currentMonth + 1, 0);
Â  Â  const numDays = lastDay.getDate();
Â  Â  const startDayOfWeek = firstDay.getDay();Â 
Â  Â Â 
Â  Â  const records = getVocalRecords();Â 
Â  Â  const container = document.getElementById('calendarContainer');
Â  Â  container.innerHTML = '';
Â  Â Â 
Â  Â  let table = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
Â  Â  Â  Â  <button onclick="renderCalendar(${currentYear}, ${currentMonth === 0 ? 11 : currentMonth - 1})" style="background:#ddd; border:none; padding:5px 10px; border-radius:5px;">â¬…</button>
Â  Â  Â  Â  <h2 style="font-size: 18px; margin: 0;">${currentYear}. ${currentMonth + 1}</h2>
Â  Â  Â  Â  <button onclick="renderCalendar(${currentYear}, ${currentMonth === 11 ? 0 : currentMonth + 1})" style="background:#ddd; border:none; padding:5px 10px; border-radius:5px;">â¡</button>
Â  Â  </div>`;

Â  Â  table += '<table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 15px;">';
Â  Â  table += '<thead><tr style="background: #eee; height: 35px;"><th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th></tr></thead><tbody><tr>';
Â  Â Â 
Â  Â  let day = 1;
Â  Â  let cellCount = 0;

Â  Â  for (let i = 0; i < startDayOfWeek; i++) {
Â  Â  Â  Â  table += '<td style="border: 1px solid #eee; padding: 5px;"></td>';
Â  Â  Â  Â  cellCount++;
Â  Â  }

Â  Â  for (day = 1; day <= numDays; day++) {
Â  Â  Â  Â  if (cellCount % 7 === 0 && cellCount !== 0) {
Â  Â  Â  Â  Â  Â  table += '</tr><tr>';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const currentDate = new Date(currentYear, currentMonth, day);
Â  Â  Â  Â  const todayKey = today.toISOString().slice(0, 10);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const isToday = dateKey === todayKey;
Â  Â  Â  Â  const isPastOrToday = currentDate <= today || isToday;Â 

Â  Â  Â  Â  let statusText = day;
Â  Â  Â  Â  let background = '#fff';
Â  Â  Â  Â  let title = dateKey;
Â  Â  Â  Â  let onClickEvent = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const record = records.get(dateKey);Â 

Â  Â  Â  Â  if (record) {
Â  Â  Â  Â  Â  Â  statusText = `<span style="font-weight:900; color:#2ecc71;">O</span>`;
Â  Â  Â  Â  Â  Â  background = '#e8f5e9';
Â  Â  Â  Â  Â  Â  title += `\n[ì™„ë£Œ] ë¬¸ì¥:\n${record.text}`;
Â  Â  Â  Â  Â  Â  onClickEvent = `onclick="displayDayRecord('${dateKey}', true)" style="cursor: pointer;"`;
Â  Â  Â  Â  } else if (isPastOrToday && !isToday) {
Â  Â  Â  Â  Â  Â  statusText = `<span style="font-weight:900; color:#ff6b6b;">X</span>`;
Â  Â  Â  Â  Â  Â  background = '#fde9e9';
Â  Â  Â  Â  Â  Â  title += '\n[ë¯¸ì™„ë£Œ]';
Â  Â  Â  Â  Â  Â  onClickEvent = `onclick="displayDayRecord('${dateKey}', false)" style="cursor: pointer;"`;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  if (isToday) {
Â  Â  Â  Â  Â  Â  background = record ? '#d0e9ff' : '#fffbe5';Â 
Â  Â  Â  Â  Â  Â  statusText = statusText === day ? `<span style="font-weight:900; color:#2980b9;">${day}</span>` : statusText;
Â  Â  Â  Â  Â  Â  onClickEvent = `onclick="displayDayRecord('${dateKey}', ${!!record})" style="cursor: pointer;"`;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  table += `<td ${onClickEvent} style="border: 1px solid #eee; padding: 5px; background: ${background};" title="${title}">`;
Â  Â  Â  Â  table += statusText;
Â  Â  Â  Â  table += '</td>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  cellCount++;
Â  Â  }

Â  Â  while (cellCount % 7 !== 0) {
Â  Â  Â  Â  table += '<td style="border: 1px solid #eee; padding: 5px;"></td>';
Â  Â  Â  Â  cellCount++;
Â  Â  }
Â  Â Â 
Â  Â  table += '</tr></tbody></table>';
Â  Â Â 
Â  Â  container.innerHTML = table;
}

// ë¬¸ì¥ ìƒì„¸ ê¸°ë¡ íŒì—…
function displayDayRecord(dateKey, isCompleted) {
Â  Â  const records = getVocalRecords();
Â  Â  const record = records.get(dateKey);
Â  Â  const box = document.getElementById('recordDisplayBox');
Â  Â  const dateEl = document.getElementById('recordDisplayDate');
Â  Â  const contentEl = document.getElementById('recordDisplayContent');
Â  Â Â 
Â  Â  dateEl.textContent = `${dateKey} ì—°ìŠµ ê¸°ë¡`;

Â  Â  if (isCompleted && record) {
Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <p style="font-weight: bold; color: #2ecc71;">âœ… ì—°ìŠµ ì™„ë£Œ</p>
Â  Â  Â  Â  Â  Â  <p><strong>ë¬¸ì¥ ë‚´ìš©:</strong> "${record.text}..."</p>
Â  Â  Â  Â  Â  Â  <p style="font-size: 13px; color: #777;">(ë…¹ìŒ íŒŒì¼ì€ ìµœì¢… ë…¹ìŒ ì‹œì—ë§Œ ì¼ì‹œì ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.)</p>
Â  Â  Â  Â  `;
Â  Â  } else {
Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <p style="font-weight: bold; color: #ff6b6b;">${isCompleted ? 'âŒ ê¸°ë¡ ì—†ìŒ' : 'âŒ ë¯¸ì™„ë£Œ'}</p>
Â  Â  Â  Â  Â  Â  <p>í•´ë‹¹ ë‚ ì§œì— ì—°ìŠµì„ ì™„ë£Œí•œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ${dateKey}ëŠ” ê±´ë„ˆë›°ê±°ë‚˜ ì—°ìŠµí•˜ì§€ ì•Šì€ ë‚ ì…ë‹ˆë‹¤.</p>
Â  Â  Â  Â  `;
Â  Â  }

Â  Â  box.style.display = 'flex'; // íŒì—… í‘œì‹œ
}

// AI ì²´í¬ ë˜ëŠ” ë…¹ìŒ ì‹¤í–‰ì„ ë¶„ê¸°í•˜ëŠ” í•¨ìˆ˜
async function handleAction() {
Â  Â  if(step === 6) { startRecognition(); }
Â  Â  else if (step === 7) { toggleRecord(); }
}
function startRecognition() {
Â  Â  if(!isSpeechSupported) return alert("ì´ ê¸°ê¸°ì—ì„œëŠ” AI ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
Â  Â  if(!isRecording) {
Â  Â  Â  Â  isRecording = true;
Â  Â  Â  Â  recognitionResult = "";
Â  Â  Â  Â  try { recognition.start(); } catch(e) { }
Â  Â  Â  Â  const btn = document.getElementById('micBtn');
Â  Â  Â  Â  btn.textContent = 'â¬›';
Â  Â  Â  Â  btn.classList.add('recording');
Â  Â  Â  Â  document.getElementById('recStatus').textContent = "ë“£ëŠ” ì¤‘...";
Â  Â  Â  Â  document.getElementById('resultBox').style.display='block';
Â  Â  Â  Â  document.getElementById('sttResult').textContent = "...";
Â  Â  Â  Â  document.getElementById('accBadge').className = 'accuracy-badge acc-wait';
Â  Â  Â  Â  document.getElementById('accBadge').textContent = 'ë¶„ì„ì¤‘...';
Â  Â  } else {
Â  Â  Â  Â  try { recognition.stop(); } catch(e) { }
Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  resetBtn();
Â  Â  }
}

function resetBtn() {
Â  Â  const btn = document.getElementById('micBtn');
Â  Â  btn.classList.remove('recording');
Â  Â  if(step === 6) {
Â  Â  Â  Â  btn.textContent = 'ğŸ—£ï¸';
Â  Â  Â  Â  document.getElementById('recStatus').textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ AI ì²´í¬ ì‹œì‘";
Â  Â  } else {
Â  Â  Â  Â  btn.textContent = 'ğŸ¤';
Â  Â  Â  Â  document.getElementById('recStatus').textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘";
Â  Â  }
}
async function toggleRecord() {
Â  Â  if(window.location.protocol === 'file:') return alert("ì„œë²„ í™˜ê²½(http/https)ì—ì„œë§Œ ë§ˆì´í¬ ì‚¬ìš© ë° íŒŒì¼ ê³µìœ ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
Â  Â  if (!isRecording) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const options = { mimeType: 'audio/mp4' };
Â  Â  Â  Â  Â  Â  if (!MediaRecorder.isTypeSupported(options.mimeType)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â options.mimeType = 'audio/webm';Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  mediaRecorder = new MediaRecorder(stream, options);

Â  Â  Â  Â  Â  Â  audioChunks = [];
Â  Â  Â  Â  Â  Â  mediaRecorder.start();
Â  Â  Â  Â  Â  Â  startTime = Date.now();
Â  Â  Â  Â  Â  Â  isRecording = true;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('micBtn');
Â  Â  Â  Â  Â  Â  btn.textContent = 'â¬›';Â 
Â  Â  Â  Â  Â  Â  btn.classList.add('recording');
Â  Â  Â  Â  Â  Â  document.getElementById('recStatus').textContent = "ë…¹ìŒ ì¤‘...";
Â  Â  Â  Â  Â  Â  document.getElementById('resultBox').style.display='none';Â 
Â  Â  Â  Â  Â  Â  mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
Â  Â  Â  Â  Â  Â  mediaRecorder.addEventListener("stop", () => {
Â  Â  Â  Â  Â  Â  Â  Â  const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
Â  Â  Â  Â  Â  Â  Â  Â  lastRecordedBlob = audioBlob;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const audioUrl = URL.createObjectURL(audioBlob);
Â  Â  Â  Â  Â  Â  Â  Â  const audio = document.getElementById('myAudio');
Â  Â  Â  Â  Â  Â  Â  Â  audio.src = audioUrl;
Â  Â  Â  Â  Â  Â  Â  Â  const duration = (Date.now() - startTime) / 1000;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('myTime').textContent = duration.toFixed(1) + "s";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('resultBox').style.display='block';Â 
Â  Â  Â  Â  Â  Â  Â  Â  stream.getTracks().forEach(track => track.stop());
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (e) { alert("ë§ˆì´í¬ ê¶Œí•œ í•„ìš”"); }
Â  Â  } else {
Â  Â  Â  Â  if(mediaRecorder) mediaRecorder.stop();
Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  resetBtn();
Â  Â  }
}
if (isSpeechSupported) { recognition.onend = function() { isRecording = false; resetBtn(); }; }

// ë°œì„±í›ˆë ¨ ë…¹ìŒ íŒŒì¼ ê³µìœ  í•¨ìˆ˜ (ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ í¬í•¨)
async function shareVocalResult() {
Â  Â  if (!lastRecordedBlob || !currentTrainObj) {
Â  Â  Â  Â  return alert("ë¨¼ì € STEP 7ì—ì„œ ë…¹ìŒì„ ì™„ë£Œí•˜ê³  ë¬¸ì¥ì„ ë½‘ì•„ì•¼ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
Â  Â  }
Â  Â Â 
Â  Â  // ì¸ì¦ í™•ì¸ ë° íŒŒì¼ëª… ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
Â  Â  if (!currentFilenameBase || instructorName === 'ê¸°ë³¸') {
Â  Â  Â  Â  Â await promptAndAuthenticate();
Â  Â  Â  Â  Â if (instructorName === 'ê¸°ë³¸') return alert("ì¸ì¦ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ì¸ì¦ ì—†ì´ëŠ” ë“œë¼ì´ë¸Œ ì—…ë¡œë“œê°€ ì œí•œë©ë‹ˆë‹¤.");
Â  Â  }

Â  Â  const originalText = document.getElementById('train_origin').textContent;
Â  Â  const mimeType = lastRecordedBlob.type;
Â  Â  let extension = mimeType.split('/')[1] || 'mp4'; // 1ì°¨ ì¶”ì¶œ
Â  Â  // ë¶€ê°€ ì •ë³´(ì˜ˆ: ;codecs=opus)ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ í•´ë‹¹ ë¶€ë¶„ë§Œ ì œê±°
Â  Â  if (extension.includes(';')) {
Â  Â  Â  Â  extension = extension.split(';')[0].trim();
Â  Â  }
Â  Â  const sanitizedFilenamePart = currentFilenameBase.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\uAC00-\uD7A3]/g, '');
Â  Â  const filename = `ìš¸ë¦¼_ë°œì„±í›ˆë ¨_${sanitizedFilenamePart}.${extension}`;
Â  Â Â 
Â  Â  // 1. ë…¹ìŒ íŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”© (GAS ì „ì†¡ ì¤€ë¹„)
Â  Â  const base64Data = await blobToBase64(lastRecordedBlob).catch(err => {
Â  Â  Â  Â  console.error("Base64 Encoding Failed:", err);
Â  Â  Â  Â  alert(`íŒŒì¼ ì¸ì½”ë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${err.message}) ì „ì†¡ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.`);
Â  Â  Â  Â  return null;
Â  Â  });

Â  Â  if (!base64Data) return;

Â  Â  // 2. êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œ ë° ì‹œíŠ¸ì— ë§í¬ ê¸°ë¡
Â  Â  await uploadAudioToDriveAndLog(
Â  Â  Â  Â  currentTrainObj.id,Â 
Â  Â  Â  Â  originalText.substring(0, 30) + "...",Â 
Â  Â  Â  Â  base64Data,Â 
Â  Â  Â  Â  mimeType,
Â  Â  Â  Â  "ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ë° ë§í¬ ê¸°ë¡"
Â  Â  );Â 

Â  Â  alert("ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ë° ì‹œíŠ¸ ê¸°ë¡ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤. ë“œë¼ì´ë¸Œ í´ë”ì™€ ì‹œíŠ¸(Fì—´)ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
Â  Â Â 
Â  Â  // 3. (ê¸°ì¡´) ì›¹ ê³µìœ  ë˜ëŠ” ë‹¤ìš´ë¡œë“œ ë¡œì§
Â  Â  if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], filename, {type: mimeType})] })) {
Â  Â  Â  Â Â 
Â  Â  Â  Â  const audioFile = new File([lastRecordedBlob], filename, { type: mimeType });

Â  Â  Â  Â  navigator.share({
Â  Â  Â  Â  Â  Â  files: [audioFile],
Â  Â  Â  Â  Â  Â  title: 'ìš¸ë¦¼ì—°ê¸°í•™ì› ë°œì„±í›ˆë ¨ ê²°ê³¼',
Â  Â  Â  Â  Â  Â  text: `[ìš¸ë¦¼ì—°ê¸°í•™ì› ë°œì„±í›ˆë ¨ ê²°ê³¼]\n\nğŸ“„ ì›ë³¸ ë¬¸ì¥:\n"${originalText}"\n\nğŸ¤ ë‚˜ì˜ ë…¹ìŒ íŒŒì¼ ì²¨ë¶€`,
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  console.error('Sharing failed:', error);
Â  Â  Â  Â  Â  Â  // ê³µìœ  ì‹¤íŒ¨ ì‹œ ë‹¤ìš´ë¡œë“œë¡œ ëŒ€ì²´
Â  Â  Â  Â  Â  Â  const audioUrl = URL.createObjectURL(lastRecordedBlob);
Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  link.download = filename;
Â  Â  Â  Â  Â  Â  link.href = audioUrl;
Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  Â  Â  alert(`Web Share API ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤: ${filename}`);
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  const audioUrl = URL.createObjectURL(lastRecordedBlob);
Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  link.download = filename;
Â  Â  Â  Â  link.href = audioUrl;
Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  link.click();
Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  }
}

/* --- [íƒ­ 4] ê¸°ì¶œë¬¸ì œ ë¡œì§ --- */
const defaultPast = { male: [], female: [] };
const pData = (typeof pastQuestionData !== 'undefined') ? pastQuestionData : defaultPast;

function rollPastQuestion(gender) {
Â  Â  if (!pData[gender] || pData[gender].length === 0) {
Â  Â  Â  Â  return alert("í•´ë‹¹ ì„±ë³„ì˜ ê¸°ì¶œë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  }
Â  Â  const q = pick(pData[gender]);
Â  Â  document.getElementById("pastRoleDisplay").textContent = q.role;
Â  Â  document.getElementById("pastLinesDisplay").textContent = q.lines;
}
/* --- [íƒ­ 4] ê¸°ì¶œë¬¸ì œ ë…¹ìŒ ê¸°ëŠ¥ --- */
let pastMediaRecorder, pastAudioChunks = [], isPastRecording = false, pastStartTime;

async function togglePastRecord() {
Â  Â  if(window.location.protocol === 'file:') return alert("ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ ì„œë²„ í™˜ê²½(http/https)ì—ì„œë§Œ ë§ˆì´í¬ ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
Â  Â Â 
Â  Â  const btn = document.getElementById('pastMicBtn');
Â  Â  const status = document.getElementById('pastRecStatus');
Â  Â  const resultBox = document.getElementById('pastResultBox');
Â  Â  const timeDisplay = document.getElementById('pastTime');
Â  Â  const audioEl = document.getElementById('pastAudio');

Â  Â  if (!isPastRecording) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const options = { mimeType: 'audio/mp4' };
Â  Â  Â  Â  Â  Â  if (!MediaRecorder.isTypeSupported(options.mimeType)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â options.mimeType = 'audio/webm';Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  pastMediaRecorder = new MediaRecorder(stream, options);

Â  Â  Â  Â  Â  Â  pastAudioChunks = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  pastMediaRecorder.start();
Â  Â  Â  Â  Â  Â  pastStartTime = Date.now();
Â  Â  Â  Â  Â  Â  isPastRecording = true;

Â  Â  Â  Â  Â  Â  btn.textContent = 'â¬›';Â 
Â  Â  Â  Â  Â  Â  btn.classList.add('recording');
Â  Â  Â  Â  Â  Â  status.textContent = "ë…¹ìŒ ì¤‘...";
Â  Â  Â  Â  Â  Â  resultBox.style.display = 'none';Â 

Â  Â  Â  Â  Â  Â  pastMediaRecorder.addEventListener("dataavailable", e => pastAudioChunks.push(e.data));

Â  Â  Â  Â  Â  Â  pastMediaRecorder.addEventListener("stop", () => {
Â  Â  Â  Â  Â  Â  Â  Â  const audioBlob = new Blob(pastAudioChunks, { type: pastMediaRecorder.mimeType });
Â  Â  Â  Â  Â  Â  Â  Â  const audioUrl = URL.createObjectURL(audioBlob);
Â  Â  Â  Â  Â  Â  Â  Â  audioEl.src = audioUrl;

Â  Â  Â  Â  Â  Â  Â  Â  const duration = (Date.now() - pastStartTime) / 1000;
Â  Â  Â  Â  Â  Â  Â  Â  timeDisplay.textContent = duration.toFixed(1) + "s";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  resultBox.style.display = 'block';Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  stream.getTracks().forEach(track => track.stop());
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  if(pastMediaRecorder) pastMediaRecorder.stop();
Â  Â  Â  Â  isPastRecording = false;

Â  Â  Â  Â  btn.textContent = 'ğŸ¤';
Â  Â  Â  Â  btn.classList.remove('recording');
Â  Â  Â  Â  status.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘";
Â  Â  }
}
// í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¬ë ¥ê³¼ í˜„ì¬ ë¬¸ì¥ ì´ˆê¸°í™”


function showLoading(message = "ì²˜ë¦¬ ì¤‘...") {
Â  Â  let el = document.getElementById("loadingOverlay");
Â  Â  if (!el) {
Â  Â  Â  Â  el = document.createElement("div");
Â  Â  Â  Â  el.id = "loadingOverlay";
Â  Â  Â  Â  el.style.position = "fixed";
Â  Â  Â  Â  el.style.top = "0";
Â  Â  Â  Â  el.style.left = "0";
Â  Â  Â  Â  el.style.width = "100%";
Â  Â  Â  Â  el.style.height = "100%";
Â  Â  Â  Â  el.style.background = "rgba(0,0,0,0.6)";
Â  Â  Â  Â  el.style.display = "flex";
Â  Â  Â  Â  el.style.alignItems = "center";
Â  Â  Â  Â  el.style.justifyContent = "center";
Â  Â  Â  Â  el.style.zIndex = "99999";
Â  Â  Â  Â  el.style.color = "white";
Â  Â  Â  Â  el.style.fontSize = "20px";
Â  Â  Â  Â  document.body.appendChild(el);
Â  Â  }
Â  Â  el.textContent = message;
Â  Â  el.style.display = "flex";
}

function hideLoading() {
Â  Â  const el = document.getElementById("loadingOverlay");
Â  Â  if (el) el.style.display = "none";
}

if ("serviceWorker" in navigator) {
Â  window.addEventListener("load", function () {
Â  Â  // ì´ ê²½ë¡œëŠ” í˜„ì¬ ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œ êµ¬ì¡°ì™€ ì¼ì¹˜í•©ë‹ˆë‹¤.
Â  Â  navigator.serviceWorker.register("/ulimvoice/service-worker.js")Â 
Â  Â  Â  .then(() => console.log("Service Worker Registered"))
Â  Â  Â  .catch(err => console.error("SW registration failed:", err));
Â  });
}
window.onload = async function() {
Â  Â  await checkStudentName();Â  // ì¸ì¦ ë¨¼ì € ì™„ë£Œ (ì—¬ê¸°ì„œ showMainContentê°€ í˜¸ì¶œë©ë‹ˆë‹¤)

Â  Â  renderCalendar();
};
</script>
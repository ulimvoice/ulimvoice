<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìš¸ë¦¼ ì„±ìš°Â·ìŠ¤í”¼ì¹˜Â·ì—°ê¸°í•™ì› í†µí•© ì—°ìŠµ í”„ë¡œê·¸ë¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="/ulimvoice/appdata/etude/data.js"></script>
<script src="/ulimvoice/appdata/vocalization/data.js"></script>
<script src="/ulimvoice/appdata/past_questions/data.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
/* ===========================
   ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ì „ì²´ ìœ ì§€)
   =========================== */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f5f7fb; margin: 0; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
.wrapper { max-width: 1200px; width: 95%; margin: 0 auto; flex: 1; padding: 20px 0; }
header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
.header-content { max-width: 1200px; width: 100%; display: flex; align-items: center; }
.logo-img { height: 45px; width: auto; margin-right: 12px; }
.header-title { font-size: 20px; font-weight: 800; color: #2ecc71; margin: 0; word-break: keep-all; }
footer { background: #333; color: #aaa; padding: 30px 20px; text-align: center; font-size: 13px; line-height: 1.6; margin-top: 40px; }
footer b { color: #fff; font-weight: 700; }
.tabs { display: flex; gap: 5px; border-bottom: 2px solid #ddd; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
.tab { padding: 12px 16px; cursor: pointer; font-weight: 700; color: #666; font-size: 15px; transition: 0.2s; flex-shrink: 0; }
.tab.active { background: #fff; color: #2ecc71; border: 1px solid #ddd; border-bottom: none; border-radius: 10px 10px 0 0; }
.tab-content { display: none; animation: fadeIn 0.3s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.section { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
.btn-row { display: flex; gap: 10px; margin-top: 20px; }
.btn-row button { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 17px; font-weight: 800; cursor: pointer; color: white; transition: 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); white-space: nowrap; }
.btn-row button:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
.btn-gen { background: #2ecc71; } .btn-save { background: #3498db; } .btn-male { background: #3498db; } .btn-female { background: #ff7979; }
.btn-share { background: #e67e22; }
.lock-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.05); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; z-index: 10; }
.lock-btn.locked { background: #ff4757; color: white; opacity: 1; }
.scene-main-card { border: 2px solid #f0f0f0; border-radius: 20px; padding: 30px 20px; background: #fff; text-align: center; margin-bottom: 30px; }
.color-badge-box { width: 100%; height: 80px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 20px; position: relative; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; text-align: left; }
.info-item { background: #f9f9f9; padding: 15px; border-radius: 14px; position: relative; min-height: 50px; display: flex; flex-direction: column; justify-content: center; }
.info-label { font-size: 12px; color: #888; font-weight: 700; margin-bottom: 4px; display:block; }
.info-value { font-size: 17px; font-weight: 700; color: #333; word-break: keep-all; }
.line-area { padding: 25px; background: #f0fdf4; border-radius: 16px; border: 2px solid #dcfce7; margin-bottom: 20px; position: relative; }
.line-text { font-size: 24px; font-weight: 900; color: #166534; word-break: keep-all; line-height: 1.4; }
.mission-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
.mission-card { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.mission-title-input { border: none; border-bottom: 1px dashed #ccc; font-size: 16px; font-weight: 800; color: #333; width: 150px; padding: 2px; background: transparent; }
.mission-title-input:focus { outline: none; border-bottom: 2px solid #2ecc71; }
.char-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
.char-img-frame { width: 100%; max-width: 300px; aspect-ratio: 1/1; border-radius: 20px; overflow: hidden; background: #f0f0f0; border: 5px solid #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; position: relative; }
.char-img { width: 100%; height: 100%; object-fit: cover; }
.char-placeholder { color: #aaa; text-align: center; font-size: 14px; padding: 20px; }
.char-info-box { text-align: center; width: 100%; }
.char-name { font-size: 26px; font-weight: 900; color: #333; margin-bottom: 5px; }
.char-job { font-size: 17px; color: #2ecc71; font-weight: 700; margin-bottom: 15px; }
.char-desc { background: #f8f9fa; padding: 20px; border-radius: 14px; font-size: 16px; color: #555; line-height: 1.6; border: 1px solid #eee; word-break: keep-all; }
.char-save-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 30px; }
.mini-char-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; font-size: 13px; border:1px solid #eee; }
.mini-char-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background:#ddd; }
.mini-char-info { padding: 10px; }
.train-origin-text { 
    font-size: 20px; font-weight: 700; color: #333; text-align: center; 
    margin-bottom: 25px; word-break: keep-all; line-height: 1.5; 
    min-height: 30px; padding: 15px; background: #e8f5e9; border-radius: 12px; border: 1px solid #c8e6c9;
}
.train-card { background: #fff; border: 2px solid #eee; border-radius: 20px; padding: 30px 15px; text-align: center; margin-bottom: 20px; }
.train-main-text { font-size: 32px; font-weight: 900; color: #2ecc71; word-break: keep-all; line-height: 1.3; margin: 20px 0; }
.train-nav { display: flex; justify-content: space-between; align-items: center; gap:10px; margin-top:20px;}
.train-nav button { background: #333; color: #fff; padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; }
.train-nav button:disabled { background: #ddd; cursor: not-allowed; }
.record-box { margin-top: 10px; padding-top: 20px; border-top: 2px dashed #eee; display: none; }
.pro-player-box { background: #f0fdf4; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; }
.player-label { font-size: 12px; font-weight: 800; color: #2ecc71; margin-bottom: 5px; display: block; }
audio { width: 100%; height: 40px; }
.mic-btn {
    width: 80px; height: 80px; border-radius: 50%; background: #ff4757; color: white; border: none;
    font-size: 34px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.5); display: flex; align-items: center; justify-content: center; margin: 0 auto;
    transition: transform 0.1s;
}
.mic-btn:active { transform: scale(0.95); }
.mic-btn.recording { animation: pulse 1.5s infinite; background: #333; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }
.result-box { margin-top: 20px; background: #fff; border-radius: 15px; border: 1px solid #e0e0e0; display: none; overflow:hidden; }
.result-section { padding: 20px; border-bottom: 1px solid #f0f0f0; }
.result-section:last-child { border-bottom: none; }
.section-title { font-size: 14px; font-weight: 800; color: #555; margin-bottom: 10px; display: flex; align-items:center; gap:5px; }
.time-info { margin-top:8px; font-size:14px; color:#555; font-weight:bold; }
.time-val { color: #ff4757; font-weight:900; }
.stt-text { font-size: 18px; color: #333; line-height: 1.4; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:10px; font-weight:500; min-height: 40px;}
.accuracy-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 13px; color: white; font-weight:bold; }
.acc-good { background: #2ecc71; } .acc-bad { background: #ff6b6b; } .acc-soso { background: #f1c40f; } .acc-wait { background: #aaa; }
.guide-text { font-size:12px; color:#999; margin-top:5px; }
.past-display-card { border: 2px solid #ddd; border-radius: 20px; padding: 30px; background: #fff; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; word-break: keep-all; margin-bottom:20px; }
.past-role { font-size: 20px; font-weight: 900; color: #2ecc71; margin-bottom: 20px; }
.past-lines { font-size: 18px; line-height: 1.8; color: #333; white-space: pre-wrap; font-family: 'KoPub Batang', serif; }
@media (max-width: 600px) {
    .section { padding: 20px; }
    .info-grid { grid-template-columns: 1fr; }
    .line-text { font-size: 22px; }
    .train-main-text { font-size: 28px; }
    .header-title { font-size: 18px; }
    .logo-img { height: 35px; }
    .btn-row { flex-wrap: wrap; }
    .btn-row button { min-width: 45%; }
}
</style>
</head>
<body>

<header>
    <div class="header-content">
        <img src="/ulimvoice/appdata/logo.png" class="logo-img" alt="ìš¸ë¦¼ì—°ê¸°í•™ì›" onerror="this.style.display='none';">
        <h1 class="header-title">ìš¸ë¦¼ì—°ê¸°í•™ì› ì—°ìŠµ í”„ë¡œê·¸ë¨</h1>
    </div>
</header>

<main class="wrapper">
  <div class="tabs">
    <div class="tab active" data-tab="tab1">ğŸ­ ìƒí™©ê·¹</div>
    <div class="tab" data-tab="tab2">ğŸ¨ ìºë¦­í„°</div>
    <div class="tab" data-tab="tab3">ğŸ¤ ë°œì„±í›ˆë ¨</div>
    <div class="tab" data-tab="tab4">ğŸ“„ ê¸°ì¶œë¬¸ì œ</div>
  </div>

  <div class="tab-content active" id="tab1">
    <div class="section">
      <div class="scene-main-card">
        <div class="color-badge-box" id="colorBg" style="background:#ddd;">
            <span id="colorText">ìƒ‰ìƒ</span>
            <button class="lock-btn" id="lock-color" onclick="toggleLock('color')">ğŸ”“</button>
        </div>
        <div class="info-grid">
            <div class="info-item"><span class="info-label">ì¥ì†Œ</span><span class="info-value" id="placeDisplay">-</span><button class="lock-btn" id="lock-place" onclick="toggleLock('place')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">ê°ì •</span><span class="info-value" id="emotionDisplay">-</span><button class="lock-btn" id="lock-emotion" onclick="toggleLock('emotion')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">ê´€ê³„</span><span class="info-value" id="relationDisplay">-</span><button class="lock-btn" id="lock-relation" onclick="toggleLock('relation')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">í–‰ë™</span><span class="info-value" id="actionDisplay">-</span><button class="lock-btn" id="lock-action" onclick="toggleLock('action')">ğŸ”“</button></div>
        </div>
        <div class="line-area">
            <div class="line-text" id="lineDisplay">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
            <button class="lock-btn" id="lock-line" onclick="toggleLock('line')">ğŸ”“</button>
        </div>
        <div class="btn-row">
            <button class="btn-gen" id="btnGen" onclick="rollScene()">ğŸ² ëœë¤ ë½‘ê¸°</button>
            <button class="btn-save" onclick="saveScene()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            <button class="btn-share" id="btnShare" onclick="shareSceneAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€/ê³µìœ </button>
        </div>
      </div>
      <h3 style="margin-top:30px; color:#555;">ğŸ“‹ ì €ì¥ëœ ë¯¸ì…˜</h3>
      <div id="missionGrid" class="mission-grid"></div>
    </div>
  </div>

  <div class="tab-content" id="tab2">
    <div class="section">
      <div class="scene-main-card" id="characterCard">
        <div class="char-container">
            <div class="char-img-frame">
                <span class="char-placeholder">ë½‘ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</span>
                <img id="charImgDisplay" class="char-img" src="" style="display:none;" onerror="this.style.display='none'; this.previousElementSibling.style.display='block';">
            </div>
            <div class="char-info-box">
                <div id="charNameDisplay" class="char-name">ìºë¦­í„° ì´ë¦„</div>
                <div id="charJobDisplay" class="char-job">ì§ì—…</div>
                <div id="charDescDisplay" class="char-desc">ë²„íŠ¼ì„ ëˆŒëŸ¬ ìºë¦­í„°ë¥¼ ì†Œí™˜í•˜ì„¸ìš”.</div>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn-male" onclick="rollCharacter('male')">ğŸ‘±â€â™‚ï¸ ë‚¨ì ë½‘ê¸°</button>
            <button class="btn-female" onclick="rollCharacter('female')">ğŸ‘© ì—¬ì ë½‘ê¸°</button>
            <button class="btn-save" onclick="saveCharacter()">â­ ì €ì¥í•˜ê¸°</button>
            <button class="btn-share" onclick="shareCharacterAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€/ê³µìœ </button>
        </div>
      </div>
      <div id="charSaveGrid" class="char-save-grid"></div>
    </div>
  </div>

 <div class="tab-content" id="tab3">
    <div class="section">
      <div class="train-origin-text" id="train_origin">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¬¸ì¥ì„ ë½‘ì•„ì£¼ì„¸ìš”</div>

      <div class="btn-row" style="margin-bottom: 20px;">
        <button class="btn-gen" style="flex: 2;" onclick="trainNew()">âœ¨ ìƒˆ ë¬¸ì¥ ë½‘ê¸°</button>
        <button class="btn-save" id="btnComplete" style="flex: 1; background: #2980b9; display: none;" onclick="completeTraining()">âœ… ì—°ìŠµ ì™„ë£Œ</button>
      </div>
      
      <button onclick="toggleCalendar()" style="width:100%; padding:10px; margin-top:5px; background:#ddd; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">
        ğŸ“… ì—°ìŠµ ê¸°ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°
      </button>

      <div id="calendarDisplayArea" style="display: none;">
        <h3 style="margin-top:20px; color:#555;">ğŸ“… ì—°ìŠµ ê¸°ë¡</h3>
        <div id="calendarContainer" style="display: flex; justify-content: center; margin-top: 15px;">
          </div>
        <p style="font-size:12px; color:#aaa; text-align:center; margin-top:10px;">(O: ì™„ë£Œ, X: ë¯¸ì™„ë£Œ)</p>
      </div>
      
      <div id="train_card" class="train-card">
        <p style="color:#aaa;">'ìƒˆ ë¬¸ì¥ ë½‘ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
      </div>

      <div class="record-box" id="recordBox">
        <div class="pro-player-box">
            <span class="player-label">ğŸ§ í”„ë¡œ ì„±ìš° ì˜ˆì‹œ ë“£ê¸°</span>
            <audio id="proAudio" controls src=""></audio>
        </div>

        <div style="text-align:center; margin: 30px 0;">
            <button id="micBtn" class="mic-btn" onclick="handleAction()">ğŸ¤</button>
            <p id="recStatus" style="font-size:14px; color:#555; margin-top:10px; font-weight:bold;">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘</p>
        </div>

        <div class="result-box" id="resultBox">
            <div class="result-section" id="aiSection" style="display:none;">
                <span class="section-title">ğŸ¤– AI ë°œìŒ ì²´í¬</span>
                <div class="stt-result-box">
                    <div id="sttResult" class="stt-text">...</div>
                    <span id="accBadge" class="accuracy-badge acc-wait">ë¶„ì„ ëŒ€ê¸°ì¤‘</span>
                </div>
                <p class="guide-text">* ì •í™•ë„ 30% ì´ìƒì´ë©´ í†µê³¼ì…ë‹ˆë‹¤.</p>
            </div>

            <div class="result-section" id="recSection" style="display:none;">
                <span class="section-title">ğŸ“‚ ë‚´ ë…¹ìŒ í™•ì¸</span>
                <audio id="myAudio" controls src="" style="width:100%;"></audio>
                <div class="time-info">
                    ë‚´ ì‹œê°„: <span id="myTime" class="time-val">0.0s</span> 
                    <span style="font-weight:normal; color:#aaa; margin-left:10px;">(í”„ë¡œ: <span id="proTime">0.0s</span>)</span>
                </div>
                <button class="btn-save" style="width:100%; margin-top:15px; background:#4CAF50;" onclick="shareVocalResult()">ğŸ”— ë…¹ìŒ íŒŒì¼ ê³µìœ í•˜ê¸°</button>
            </div>
        </div>
      </div>
      
      <div class="train-nav" style="margin-top:20px;">
        <button id="btn_prev" onclick="trainPrev()" disabled>â¬… ì´ì „</button>
        <div id="step_indicator" style="font-weight:bold; color:#2ecc71; font-size:18px;">STEP 0</div>
        <button id="btn_next" onclick="trainNext()" disabled>ë‹¤ìŒ â¡</button>
      </div>
    </div>
  </div>

<div id="recordDisplayBox" style="
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.7); display: none; justify-content: center; 
    align-items: center; z-index: 9999;
">
    <div style="
        background: white; padding: 30px; border-radius: 20px; max-width: 400px; 
        width: 90%; box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    ">
        <h3 id="recordDisplayDate" style="color: #2980b9; margin-top: 0;">ê¸°ë¡ ìƒì„¸</h3>
        <p id="recordDisplayContent" style="
            background: #f8f8f8; padding: 15px; border-radius: 10px; 
            font-size: 16px; line-height: 1.5; word-break: break-all;
        ">ì„ íƒëœ ë‚ ì§œì˜ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        <button onclick="document.getElementById('recordDisplayBox').style.display='none';" style="
            width: 100%; padding: 10px; background: #e74c3c; color: white; border: none; 
            border-radius: 10px; margin-top: 20px; cursor: pointer; font-weight: bold;
        ">ë‹«ê¸°</button>
    </div>
</div>
<div class="tab-content" id="tab4">
    <div class="section">
      <div class="past-display-card">
        <div id="pastRoleDisplay" class="past-role">ë²„íŠ¼ì„ ëˆŒëŸ¬ ëŒ€ë³¸ì„ ë½‘ì•„ì£¼ì„¸ìš”</div>
        <div id="pastLinesDisplay" class="past-lines">-</div>
      </div>

      <div class="btn-row">
        <button class="btn-male" onclick="rollPastQuestion('male')">ğŸ‘±â€â™‚ï¸ ë‚¨ì ê¸°ì¶œ ë½‘ê¸°</button>
        <button class="btn-female" onclick="rollPastQuestion('female')">ğŸ‘© ì—¬ì ê¸°ì¶œ ë½‘ê¸°</button>
      </div>

      <div class="record-box" id="pastRecordBox" style="display:block; margin-top:30px; border-top:2px dashed #eee; padding-top:20px;">
        <div style="text-align:center; margin-bottom: 20px;">
            <p style="font-size:16px; font-weight:800; color:#333; margin-bottom:15px;">ğŸ™ï¸ ì‹¤ì „ ë…¹ìŒ ì—°ìŠµ</p>
            <button id="pastMicBtn" class="mic-btn" onclick="togglePastRecord()">ğŸ¤</button>
            <p id="pastRecStatus" style="font-size:14px; color:#555; margin-top:10px; font-weight:bold;">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘</p>
        </div>

        <div class="result-box" id="pastResultBox" style="display:none;">
            <div class="result-section">
                <span class="section-title">ğŸ“‚ ë‚´ ë…¹ìŒ í™•ì¸</span>
                <audio id="pastAudio" controls src="" style="width:100%;"></audio>
                <div class="time-info">
                    ë…¹ìŒ ì‹œê°„: <span id="pastTime" class="time-val">0.0s</span>
                </div>
            </div>
        </div>
      </div>

    </div>
  </div>
</main>

<footer>
    <b>ìƒë‹´ì „í™”</b> : 010-7372-5875 <br>
    <b>ì£¼ì†Œ</b> : ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ì²­ëª…ë‚¨ë¡œ 28ë²ˆê¸¸ 2 ì•„ì´í…í…ë¹Œë”© 502í˜¸ <br>
    Copyright Â© ìš¸ë¦¼ì—°ê¸°í•™ì›. All rights reserved.
</footer>

<script>
// =========================================================================================
// â­ 1. GAS URL ì •ì˜ (ìµœì‹  ì£¼ì†Œë¡œ ì„¤ì • ì™„ë£Œ) â­
// =========================================================================================

// í•™ìƒë¶€ GAS URL (ì¸ì¦ ë° ê°•ì‚¬ ì •ë³´ ì¡°íšŒ)
const GET_API_URL = 'https://script.google.com/macros/s/AKfycbz5M-B0ogXDLiiV86KVPqRkmrIYJlSgWFf973t7MbPWM0wxjF5L8ubDWSZdlZazhe04sQ/exec'; 

// â­â­ ì—°ìŠµì¼ì§€ GAS URL (ì‚¬ìš©ìë‹˜ì´ ìµœì¢… ì œê³µí•œ ìµœì‹  ì£¼ì†Œë¡œ êµì²´) â­â­
const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyilq7vdKPcd1AphhPUFPE8Xmezr1Gq_GHK_9W3bcXka9kVQb2L5WrsVccRqkHLITmVjg/exec';


// =========================================================================================
// â­ 2. í•™ìƒ/ê°•ì‚¬ ì •ë³´ ë° ê³µí†µ ìœ í‹¸ë¦¬í‹° â­
// =========================================================================================

let studentName = localStorage.getItem('studentName') || 'ê²ŒìŠ¤íŠ¸';
let instructorName = localStorage.getItem('instructorName') || 'ê¸°ë³¸';
let phoneLast4 = localStorage.getItem('phoneLast4') || '';
// â­ instructorFolderId ë³€ìˆ˜ ì´ˆê¸°í™” (ì¸ì¦ ì„±ê³µ ì‹œ ì—¬ê¸°ì— í´ë” ID ì €ì¥) â­
let instructorFolderId = localStorage.getItem('instructorFolderId') || '13rOhOoNZv3s0n0UWmSx2U9_1lSXaH4_z';
let currentFilenameBase = `${instructorName}_${studentName}_${phoneLast4}`; 

function pick(a){return a[Math.floor(Math.random()*a.length)];}

// ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
function downloadImage(dataUrl, filename='ìš¸ë¦¼_ë¯¸ì…˜.png') {
    const link = document.createElement('a');
    link.download = filename;
    link.href = dataUrl;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    alert("ì´ë¯¸ì§€ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!");
}

// íƒ­ ë¡œì§ (ìƒëµ)
document.querySelectorAll('.tab').forEach(t => {
    t.onclick = () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.tab).classList.add('active');
    };
});


// =========================================================================================
// â­ 3. í•™ìƒ ì¸ì¦ ë¡œì§ (checkStudentName, promptAndAuthenticate) â­
// =========================================================================================

// í˜ì´ì§€ ë¡œë“œ ì‹œ í•™ìƒ ì´ë¦„ ë° ì¸ì¦ í™•ì¸
async function checkStudentName() {
    if (!studentName || !phoneLast4 || instructorName === 'ê¸°ë³¸') {
        await promptAndAuthenticate();
    }
    // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ëª…ì„ ì—…ë°ì´íŠ¸
    updateFilenameConstants();
}

// ì¸ì¦ í”„ë¡¬í”„íŠ¸ ë° GAS ì¸ì¦ ìš”ì²­ í•¨ìˆ˜
async function promptAndAuthenticate() {
    let name = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    let phone = prompt("ì¶œê²°ë²ˆí˜¸ (íœ´ëŒ€í° ë²ˆí˜¸ ë’¤ ë„¤ ìë¦¬)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    if (!name || !phone || phone.length !== 4) {
        alert("ì¸ì¦ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤. (íŒŒì¼ ì´ë¦„: ê²ŒìŠ¤íŠ¸_ê¸°ë³¸_0000)");
        studentName = "ê²ŒìŠ¤íŠ¸";
        instructorName = "ê¸°ë³¸";
        phoneLast4 = "0000";
        // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ì§„ì… ì‹œ instructorFolderIdë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì • ë° ì €ì¥
        instructorFolderId = '13rOhOoNZv3s0n0UWmSx2U9_1lSXaH4_z'; // ê¸°ë³¸ í´ë” ID (GASì™€ ë™ì¼)
        localStorage.setItem('studentName', studentName);
        localStorage.setItem('instructorName', instructorName);
        localStorage.setItem('phoneLast4', phoneLast4);
        localStorage.setItem('instructorFolderId', instructorFolderId); 
        return;
    }
    
    // GAS ì¸ì¦ API í˜¸ì¶œ (GET_API_URL ì‚¬ìš©)
    const url = `${GET_API_URL}?name=${encodeURIComponent(name)}&phoneLast4=${phone}`;
    try {
        const response = await fetch(url);
        
        // GASê°€ 404ê°€ ì•„ë‹Œ ë‹¤ë¥¸ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ response.ok ì²´í¬
        if (!response.ok) throw new Error(`GAS ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        
        const result = await response.json();

        if (result.status === 'success') {
            studentName = result.name;
            instructorName = result.instructor;
            phoneLast4 = result.phoneLast4;
            
            // â­â­â­ [í•µì‹¬ ì¶”ê°€] í´ë” ID ë³€ìˆ˜ ë° localStorage ì €ì¥ â­â­â­
            instructorFolderId = result.instructorFolderId; 
            
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('instructorName', instructorName);
            localStorage.setItem('phoneLast4', phoneLast4);
            localStorage.setItem('instructorFolderId', instructorFolderId); // í´ë” ID ì €ì¥
            
            alert(`ì¸ì¦ ì„±ê³µ: ${studentName}ë‹˜ (${instructorName} ê°•ì‚¬)`);
        } else {
            alert(`ì¸ì¦ ì‹¤íŒ¨: ${result.message}\nê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.`);
            studentName = "ê²ŒìŠ¤íŠ¸"; instructorName = "ê¸°ë³¸"; phoneLast4 = "0000";
            // ì¸ì¦ ì‹¤íŒ¨ ì‹œì—ë„ ê¸°ë³¸ í´ë” ID ì €ì¥
            instructorFolderId = '13rOhOoNZv3s0n0UWmSx2U9_1lSXaH4_z'; 
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('instructorName', instructorName);
            localStorage.setItem('phoneLast4', phoneLast4);
            localStorage.setItem('instructorFolderId', instructorFolderId); 
        }
    } catch (e) {
        alert(`ì¸ì¦ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ: ${e.message}. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
        studentName = "ê²ŒìŠ¤íŠ¸"; instructorName = "ê¸°ë³¸"; phoneLast4 = "0000";
        // í†µì‹  ì˜¤ë¥˜ ì‹œì—ë„ ê¸°ë³¸ í´ë” ID ì €ì¥
        instructorFolderId = '13rOhOoNZv3s0n0UWmSx2U9_1lSXaH4_z'; 
        localStorage.setItem('studentName', studentName);
        localStorage.setItem('instructorName', instructorName);
        localStorage.setItem('phoneLast4', phoneLast4);
        localStorage.setItem('instructorFolderId', instructorFolderId); 
    }
}

// íŒŒì¼ëª… ë² ì´ìŠ¤ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ê°•ì‚¬ì´ë¦„_í•™ìƒì´ë¦„_ì¶œê²°4ìë¦¬)
function updateFilenameConstants() {
    const filenameBase = `${instructorName}_${studentName}_${phoneLast4}`;
    
    // ìµœì¢… íŒŒì¼ëª… ë² ì´ìŠ¤ ì„¤ì • (íŠ¹ìˆ˜ë¬¸ì ë° ê³µë°± ì œê±°)
    currentFilenameBase = filenameBase.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\uAC00-\uD7A3]/g, '');
}


// =========================================================================================
// â­ 4. GAS í†µì‹  í•¨ìˆ˜ (Base64 ì¸ì½”ë”© ë° ì—…ë¡œë“œ ë¡œì§ í¬í•¨ - ìµœì¢… ìˆ˜ì •) â­
// =========================================================================================

// Blob ë°ì´í„°ë¥¼ Base64 ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            const base64String = reader.result.split(',')[1];
            // GASëŠ” ì•½ 50MB ì œí•œ (Base64 ì¸ì½”ë”© í›„ í¬ê¸°)
            if (base64String.length * 0.75 > 45 * 1024 * 1024) { 
                reject(new Error("File size is too large for GAS limit."));
            }
            resolve(base64String);
        };
        reader.onerror = reject;
    });
}

// ë…¹ìŒ íŒŒì¼ì„ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œí•˜ê³  ì‹œíŠ¸ì— ë§í¬ë¥¼ ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜
async function uploadAudioToDriveAndLog(vocalId, sentenceText, base64Data, mimeType, action, instructorFolderId) {
    if (!GOOGLE_APP_SCRIPT_URL || GOOGLE_APP_SCRIPT_URL.includes('YOUR_DEPLOYED_GAS_URL_HERE')) {
        console.warn("Google Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ì´í„° ì „ì†¡ì„ ê±´ë„ˆë›°ê² ìŠµë‹ˆë‹¤.");
        return;
    }
    
    // GASë¡œ ì „ì†¡í•  í˜ì´ë¡œë“œ êµ¬ì„±
    const payload = {
        name: studentName,
        vocalId: vocalId,
        sentence: sentenceText,
        action: action, 
        audioData: base64Data, 
        mimeType: mimeType,
        fileNameBase: currentFilenameBase, 
        instructor: instructorName,
        // â­â­ [í•µì‹¬] í´ë” IDë¥¼ POST í˜ì´ë¡œë“œì— í¬í•¨í•˜ì—¬ GASë¡œ ì „ì†¡ â­â­
        instructorFolderId: instructorFolderId 
    };

    try {
        await fetch(GOOGLE_APP_SCRIPT_URL, {
            method: 'POST',
            // â­ no-cors ì˜µì…˜ ì œê±° (GAS í†µì‹  ì•ˆì •í™”) â­
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        console.log('Drive upload and Sheet logging attempted.');
    } catch (error) {
        console.error('Drive upload failed:', error);
    }
}

// íŒŒì¼ ì—…ë¡œë“œ ì—†ì´ ë©”íƒ€ë°ì´í„°ë§Œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜ (ì—°ìŠµ ì™„ë£Œ ë²„íŠ¼ ìš©)
async function sendToGoogleSheet(vocalId, sentenceText, action) {
    if (!GOOGLE_APP_SCRIPT_URL || GOOGLE_APP_SCRIPT_URL.includes('YOUR_DEPLOYED_GAS_URL_HERE')) {
        console.warn("Google Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ì´í„° ì „ì†¡ì„ ê±´ë„ˆë›°ê² ìŠµë‹ˆë‹¤.");
        return;
    }
    
    const payload = {
        name: studentName,
        vocalId: vocalId,
        sentence: sentenceText,
        action: action, 
        instructor: instructorName, // ì‹œíŠ¸ íƒ­ ì´ë¦„ ì „ë‹¬
        instructorFolderId: instructorFolderId // í´ë” ID ì „ë‹¬
    };

    try {
        await fetch(GOOGLE_APP_SCRIPT_URL, {
            method: 'POST',
            // â­ no-cors ì˜µì…˜ ì œê±° â­
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        console.log('Google Sheet submission attempted.');
    } catch (error) {
        console.error('Google Sheet submission failed:', error);
    }
}


// =========================================================================================
// â­ 5. íƒ­ 1 (ìƒí™©ê·¹) ë¡œì§ (RollScene, SaveScene, ShareSceneAsImage) â­
// =========================================================================================

const defaultEtude = { colors: [], places: [], emotions: [], relations: [], actions: [], lines: [] };
const eData = (typeof etudeData !== 'undefined') ? etudeData : defaultEtude;

let locks = {color:false, place:false, emotion:false, relation:false, action:false, line:false};
let currentData = {c:{name:"ìƒ‰ìƒ",code:"#ddd"}, p:"-", e:"-", r:"-", a:"-", l:"ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”"};
let missionCount = 0;

function toggleLock(key){
    locks[key] = !locks[key];
    const btn = document.getElementById('lock-'+key);
    btn.textContent = locks[key] ? "ğŸ”’" : "ğŸ”“";
    btn.classList.toggle("locked");
}

async function rollScene(){
    // â­â­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê²½ê³  â­â­
    if (eData.lines.length === 0) return alert("ìƒí™©ê·¹ ë°ì´í„°(data.js)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

    const btn = document.getElementById('btnGen'); btn.disabled = true;
    const newC = locks.color ? currentData.c : pick(eData.colors || []);
    const newP = locks.place ? currentData.p : pick(eData.places || []);
    const newE = locks.emotion ? currentData.e : pick(eData.emotions || []);
    const newR = locks.relation ? currentData.r : pick(eData.relations || []);
    const newA = locks.action ? currentData.a : pick(eData.actions || []);
    const newL = locks.line ? currentData.l : pick(eData.lines || []);
    
    currentData = {c:newC, p:newP, e:newE, r:newR, a:newA, l:newL};

    const promises = [];
    if(!locks.color && eData.colors) promises.push(spinColor(newC, 600));
    if(!locks.place && eData.places) promises.push(spinText('placeDisplay', eData.places, newP, 1000));
    if(!locks.emotion && eData.emotions) promises.push(spinText('emotionDisplay', eData.emotions, newE, 1400));
    if(!locks.relation && eData.relations) promises.push(spinText('relationDisplay', eData.relations, newR, 1800));
    if(!locks.action && eData.actions) promises.push(spinText('actionDisplay', eData.actions, newA, 2200));
    if(!locks.line && eData.lines) promises.push(spinText('lineDisplay', eData.lines, newL, 2600));
    
    await Promise.all(promises);
    btn.disabled = false;
}

function spinText(id, arr, val, dur){
    return new Promise(r => {
        const el = document.getElementById(id);
        const start = Date.now();
        const int = setInterval(()=>{
            if(Date.now()-start > dur){ clearInterval(int); el.textContent=val; r(); }
            else el.textContent = pick(arr);
        }, 50);
    });
}
function spinColor(val, dur){
    return new Promise(r => {
        const bg = document.getElementById('colorBg');
        const text = document.getElementById('colorText');
        const start = Date.now();
        const int = setInterval(()=>{
            if(Date.now()-start > dur){ 
                clearInterval(int); 
                bg.style.backgroundColor=val.code; 
                text.textContent=val.name; 
                r(); 
            }
            else { 
                const t=pick(eData.colors || []); 
                bg.style.backgroundColor=t.code; 
                text.textContent=t.name; 
            }
        }, 50);
    });
}

function saveScene(){
    if(currentData.l === "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”") return alert("ë¨¼ì € ëœë¤ ë½‘ê¸°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!");
    missionCount++;
    const div = document.createElement("div"); div.className="mission-card";
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px;">
            <input type="text" class="mission-title-input" value="ë¯¸ì…˜ ${missionCount}">
            <span style="background:${currentData.c.code}; color:#fff; padding:4px 8px; border-radius:8px; font-size:12px; font-weight:bold;">${currentData.c.name}</span>
        </div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ì¥ì†Œ:</strong> ${currentData.p}</div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ê°ì •:</strong> ${currentData.e}</div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ê´€ê³„:</strong> ${currentData.r}</div>
        <div style="font-size:14px; color:#555; margin-bottom:10px;"><strong>í–‰ë™:</strong> ${currentData.a}</div>
        <div style="background:#f8f9fa; padding:10px; border-radius:8px; font-weight:800; color:#333; word-break:keep-all;">"${currentData.l}"</div>
    `;
    document.getElementById("missionGrid").prepend(div);
}

// ìƒí™©ê·¹ ë¯¸ì…˜ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥ ë° ê³µìœ í•˜ëŠ” í•¨ìˆ˜
function shareSceneAsImage() {
    const targetElement = document.querySelector('.scene-main-card');

    if (currentData.l === "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”") {
        return alert("ë¨¼ì € 'ëœë¤ ë½‘ê¸°'ë¥¼ ì§„í–‰í•´ì•¼ ì´ë¯¸ì§€ ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
    }

    html2canvas(targetElement, {
        allowTaint: true,
        useCORS: true,
        scale: 2
    }).then(canvas => {
        const imageURL = canvas.toDataURL("image/png");

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], 'image.png', {type: 'image/png'})] })) {
            canvas.toBlob(function(blob) {
                const filesArray = [new File([blob], 'scene-mission.png', {type: 'image/png'})];
                navigator.share({
                    files: filesArray,
                    title: 'ìš¸ë¦¼ì—°ê¸°í•™ì› ìƒí™©ê·¹ ë¯¸ì…˜',
                    text: 'ì˜¤ëŠ˜ì˜ ìƒí™©ê·¹ ë¯¸ì…˜ì„ ê³µìœ í•©ë‹ˆë‹¤! ğŸ­'
                })
                .catch(error => {
                    console.warn('Sharing failed, attempting download:', error);
                    downloadImage(imageURL, 'ìš¸ë¦¼_ìƒí™©ê·¹_ë¯¸ì…˜.png');
                });
            }, 'image/png');
        } else {
            downloadImage(imageURL, 'ìš¸ë¦¼_ìƒí™©ê·¹_ë¯¸ì…˜.png');
        }
    });
}


// =========================================================================================
// â­ 6. íƒ­ 2 (ìºë¦­í„°) ë¡œì§ â­
// =========================================================================================

let currentChar = null;
const defaultCharData = { male: [], female: [] };
const charData = (typeof characterData !== 'undefined') ? characterData : defaultCharData;

function rollCharacter(gender) {
    // â­â­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê²½ê³  â­â­
    if (charData.male.length === 0 && charData.female.length === 0) return alert("ìºë¦­í„° ë°ì´í„°(data.js)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

    const list = charData[gender] || defaultCharData[gender];
    const char = pick(list); 
    currentChar = char; 

    const imgEl = document.getElementById("charImgDisplay");
    const placeholderEl = document.querySelector(".char-placeholder");
    
    const folder = gender === 'male' ? 'male' : 'female';
    // ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ ìˆ˜ì • (GitHub Pages)
    const newSrc = `/ulimvoice/appdata/character/${folder}/${char.id}.jpg`; 

    imgEl.onload = function(){
        placeholderEl.style.display = 'none';
        this.style.display = 'block';
    };
    imgEl.onerror = function(){
        this.style.display = 'none';
        placeholderEl.style.display = 'block';
        alert("ìºë¦­í„° ì´ë¯¸ì§€ íŒŒì¼ì„ ë¡œë“œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    };
    
    imgEl.src = newSrc; 
    
    document.getElementById("charNameDisplay").textContent = char.name;
    document.getElementById("charJobDisplay").textContent = char.job;
    document.getElementById("charDescDisplay").textContent = char.desc;
}

// ... (saveCharacter, shareCharacterAsImage ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ...


// =========================================================================================
// â­ 7. íƒ­ 3 (ë°œì„±í›ˆë ¨) ë¡œì§ (shareVocalResult í˜¸ì¶œ ìˆ˜ì •) â­
// =========================================================================================

let step=0, currentTrainObj=null;
let mediaRecorder, audioChunks = [], isRecording = false, startTime;
let recognition;
let recognitionResult = "";
let lastRecordedBlob = null; 

// ... (ê¸°ì¡´ì˜ ëª¨ë“  ë°œì„±í›ˆë ¨ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ...

// [3] ë¬¸ì¥ ì €ì¥ ë° ì—°ìŠµ ì™„ë£Œ ê¸°ë¡ (âœ… ì—°ìŠµ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ)
function completeTraining() {
    const btnComplete = document.getElementById('btnComplete');

    if (step !== 7 || !currentTrainObj) {
        return alert("STEP 7(ìµœì¢… ë…¹ìŒ)ê¹Œì§€ ì§„í–‰í•˜ê³  ë¬¸ì¥ì„ ë½‘ì€ ìƒíƒœì—ì„œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    }
    
    // ... (ë¡œì»¬ ì €ì¥ì†Œ ê¸°ë¡ ë¡œì§ ìœ ì§€) ...
    
    // â­ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì—°ìŠµ ì™„ë£Œ ì •ë³´ ì „ì†¡ â­
    sendToGoogleSheet(currentTrainObj.id, currentTrainObj.text.substring(0, 30) + "...", "ì—°ìŠµ ì™„ë£Œ ì²´í¬"); 

    alert(`[${today}] ì—°ìŠµì„ ì™„ë£Œí•˜ê³  ë¬¸ì¥ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤! (ë‹¤ìŒ ë½‘ê¸° ì‹œ ì œì™¸ë¨)`);
    
    // ... (ë‚˜ë¨¸ì§€ ë¡œì§ ìœ ì§€) ...
}

function trainNew(){
    if(typeof vocalData !== 'undefined') trainDataList = vocalData;
    
    // â­â­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê²½ê³  â­â­
    if (trainDataList.length === 1 && trainDataList[0].text === "ë°ì´í„° ë¡œë”©ì¤‘...") {
        return alert("ë¬¸ì¥ ë°ì´í„°(data.js)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
    
    // ... (ë‚˜ë¨¸ì§€ trainNew ë¡œì§ ìœ ì§€) ...
}

// ë°œì„±í›ˆë ¨ ë…¹ìŒ íŒŒì¼ ê³µìœ  í•¨ìˆ˜ (ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ í¬í•¨)
async function shareVocalResult() {
    // ... (ìƒë‹¨ í•„ìˆ˜ ê²€ì¦ ë¡œì§ ìœ ì§€) ...
    
    if (!base64Data) return;

    // 2. êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œ ë° ì‹œíŠ¸ì— ë§í¬ ê¸°ë¡
    await uploadAudioToDriveAndLog(
        currentTrainObj.id, 
        originalText.substring(0, 30) + "...", 
        base64Data, 
        mimeType,
        "ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ë° ë§í¬ ê¸°ë¡",
        // â­â­ [ìµœì¢… ìˆ˜ì •] í´ë” IDë¥¼ ì¸ìˆ˜ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. â­â­
        instructorFolderId 
    ); 

    alert("ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ë° ì‹œíŠ¸ ê¸°ë¡ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤. ë“œë¼ì´ë¸Œ í´ë”ì™€ ì‹œíŠ¸(Fì—´)ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    
    // ... (í•˜ë‹¨ ê³µìœ  ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ...
}
// ... (ë‚˜ë¨¸ì§€ ëª¨ë“  JS ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ...


// â­ window.onload í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©°, ì´ì „ì— ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„ë“¤ë§Œ ìƒë‹¨ì— ë³´ê°•í–ˆìŠµë‹ˆë‹¤. â­
window.onload = function() {
    checkStudentName();

    document.querySelectorAll('.tab').forEach(t => {
        t.onclick = () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            document.getElementById(t.dataset.tab).classList.add('active');
        };
    });
    
    renderCalendar();
};
</script>
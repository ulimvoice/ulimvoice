<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìš¸ë¦¼ ì„±ìš°Â·ìŠ¤í”¼ì¹˜Â·ì—°ê¸°í•™ì› í†µí•© ì—°ìŠµ í”„ë¡œê·¸ë¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="appdata/etude/data.js"></script>
<script src="appdata/vocalization/data.js"></script>

<style>
/* ===========================
   ê¸°ë³¸ ìŠ¤íƒ€ì¼
   =========================== */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f5f7fb; margin: 0; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
.wrapper { max-width: 1200px; width: 95%; margin: 0 auto; flex: 1; padding: 20px 0; }

/* í—¤ë” & í‘¸í„° */
header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
.header-content { max-width: 1200px; width: 100%; display: flex; align-items: center; }
.logo-img { height: 45px; width: auto; margin-right: 12px; }
.header-title { font-size: 20px; font-weight: 800; color: #2ecc71; margin: 0; word-break: keep-all; }
footer { background: #333; color: #aaa; padding: 30px 20px; text-align: center; font-size: 13px; line-height: 1.6; margin-top: 40px; }
footer b { color: #fff; font-weight: 700; }

/* íƒ­ ë° ê³µí†µ UI */
.tabs { display: flex; gap: 5px; border-bottom: 2px solid #ddd; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
.tab { padding: 12px 16px; cursor: pointer; font-weight: 700; color: #666; font-size: 15px; transition: 0.2s; flex-shrink: 0; }
.tab.active { background: #fff; color: #2ecc71; border: 1px solid #ddd; border-bottom: none; border-radius: 10px 10px 0 0; }
.tab-content { display: none; animation: fadeIn 0.3s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.section { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }

/* ë²„íŠ¼ ê³µí†µ */
.btn-row { display: flex; gap: 10px; margin-top: 20px; }
.btn-row button { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 17px; font-weight: 800; cursor: pointer; color: white; transition: 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); white-space: nowrap; }
.btn-row button:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
.btn-gen { background: #2ecc71; } .btn-save { background: #3498db; } .btn-male { background: #3498db; } .btn-female { background: #ff7979; }

/* ì ê¸ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.lock-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.05); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; z-index: 10; transition: all 0.2s; }
.lock-btn:hover { background: rgba(0,0,0,0.1); transform: scale(1.1); }
.lock-btn.locked { background: #ff4757; color: white; opacity: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

/* íƒ­ 1: ìƒí™©ê·¹ UI */
.scene-main-card { border: 2px solid #f0f0f0; border-radius: 20px; padding: 30px 20px; background: #fff; text-align: center; margin-bottom: 30px; }
.color-badge-box { width: 100%; height: 80px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 20px; position: relative; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; text-align: left; }
.info-item { background: #f9f9f9; padding: 15px; border-radius: 14px; position: relative; min-height: 50px; display: flex; flex-direction: column; justify-content: center; border: 1px solid #eee; }
.info-label { font-size: 12px; color: #888; font-weight: 700; margin-bottom: 4px; display:block; }
.info-value { font-size: 17px; font-weight: 700; color: #333; word-break: keep-all; }
.line-area { padding: 25px; background: #f0fdf4; border-radius: 16px; border: 2px solid #dcfce7; margin-bottom: 20px; position: relative; }
.line-text { font-size: 24px; font-weight: 900; color: #166534; word-break: keep-all; line-height: 1.4; }

/* ì €ì¥ëœ ë¯¸ì…˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.mission-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
.mission-card { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
.mission-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
/* ë¯¸ì…˜ ì œëª© ì…ë ¥ì°½ */
.mission-title-input { border: none; border-bottom: 1px dashed #ccc; font-size: 16px; font-weight: 800; color: #333; width: 140px; background: transparent; padding: 2px; outline: none; transition: border 0.2s; }
.mission-title-input:focus { border-bottom: 2px solid #2ecc71; }

/* íƒ­ 2: ìºë¦­í„° UI */
.char-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
.char-img-frame { width: 100%; max-width: 300px; aspect-ratio: 1/1; border-radius: 20px; overflow: hidden; background: #f0f0f0; border: 5px solid #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; position: relative; }
.char-img { width: 100%; height: 100%; object-fit: cover; }
.char-placeholder { color: #aaa; text-align: center; font-size: 14px; padding: 20px; }
.char-info-box { text-align: center; width: 100%; }
.char-name { font-size: 26px; font-weight: 900; color: #333; margin-bottom: 5px; }
.char-job { font-size: 17px; color: #2ecc71; font-weight: 700; margin-bottom: 15px; }
.char-desc { background: #f8f9fa; padding: 20px; border-radius: 14px; font-size: 16px; color: #555; line-height: 1.6; border: 1px solid #eee; word-break: keep-all; }
.char-save-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 30px; }
.mini-char-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; font-size: 13px; border:1px solid #eee; }
.mini-char-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background:#ddd; }
.mini-char-info { padding: 10px; }

/* íƒ­ 3: ë°œì„±í›ˆë ¨ UI */
.train-origin-text { 
    font-size: 20px; font-weight: 700; color: #333; text-align: center; 
    margin-bottom: 25px; word-break: keep-all; line-height: 1.5; 
    min-height: 30px; padding: 15px; background: #e8f5e9; border-radius: 12px; border: 1px solid #c8e6c9;
}
.train-card { background: #fff; border: 2px solid #eee; border-radius: 20px; padding: 30px 15px; text-align: center; margin-bottom: 20px; }
.train-main-text { font-size: 32px; font-weight: 900; color: #2ecc71; word-break: keep-all; line-height: 1.3; margin: 20px 0; }
.train-nav { display: flex; justify-content: space-between; align-items: center; gap:10px; margin-top:20px;}
.train-nav button { background: #333; color: #fff; padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; }
.train-nav button:disabled { background: #ddd; cursor: not-allowed; }

.record-box { margin-top: 10px; padding-top: 20px; border-top: 2px dashed #eee; display: none; }
.pro-player-box { background: #f0fdf4; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; }
.player-label { font-size: 12px; font-weight: 800; color: #2ecc71; margin-bottom: 5px; display: block; }
audio { width: 100%; height: 40px; }

.mic-btn {
    width: 80px; height: 80px; border-radius: 50%; background: #ff4757; color: white; border: none;
    font-size: 34px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.5); display: flex; align-items: center; justify-content: center; margin: 0 auto;
    transition: transform 0.1s;
}
.mic-btn:active { transform: scale(0.95); }
.mic-btn.recording { animation: pulse 1.5s infinite; background: #333; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }

/* ê²°ê³¼ ë°•ìŠ¤ */
.result-box { margin-top: 20px; background: #fff; border-radius: 15px; border: 1px solid #e0e0e0; display: none; overflow:hidden; }
.result-section { padding: 15px; border-bottom: 1px solid #f0f0f0; }
.result-section:last-child { border-bottom: none; }
.section-title { font-size: 13px; font-weight: 800; color: #888; margin-bottom: 8px; display: block; }
.time-info { margin-top:5px; font-size:14px; color:#555; font-weight:bold; }
.time-val { color: #ff4757; font-weight:900; }
.stt-text { font-size: 18px; color: #333; line-height: 1.4; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:10px; font-weight:500; min-height: 40px;}
.accuracy-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 13px; color: white; font-weight:bold; }
.acc-good { background: #2ecc71; } .acc-bad { background: #ff6b6b; } .acc-soso { background: #f1c40f; } .acc-wait { background: #aaa; }
.guide-text { font-size:12px; color:#999; margin-top:5px; }

@media (max-width: 600px) {
    .section { padding: 20px; }
    .info-grid { grid-template-columns: 1fr; }
    .line-text { font-size: 22px; }
    .train-main-text { font-size: 28px; }
    .header-title { font-size: 18px; }
    .logo-img { height: 35px; }
    .btn-row { flex-wrap: wrap; }
    .btn-row button { min-width: 45%; }
}
</style>
</head>
<body>

<header>
    <div class="header-content">
        <img src="appdata/logo.png" class="logo-img" alt="ìš¸ë¦¼ì—°ê¸°í•™ì›" onerror="this.style.display='none';">
        <h1 class="header-title">ìš¸ë¦¼ì—°ê¸°í•™ì› ì—°ìŠµ í”„ë¡œê·¸ë¨</h1>
    </div>
</header>

<main class="wrapper">
  <div class="tabs">
    <div class="tab active" data-tab="tab1">ğŸ­ ìƒí™©ê·¹</div>
    <div class="tab" data-tab="tab2">ğŸ¨ ìºë¦­í„°</div>
    <div class="tab" data-tab="tab3">ğŸ¤ ë°œì„±í›ˆë ¨</div>
    <div class="tab" data-tab="tab4">ğŸ“„ ê¸°ì¶œë¬¸ì œ</div>
  </div>

  <div class="tab-content active" id="tab1">
    <div class="section">
      <div class="scene-main-card">
        <div class="color-badge-box" id="colorDisplay" style="background:#ddd;">
            ìƒ‰ìƒ <button class="lock-btn" id="lock-color" onclick="toggleLock('color')">ğŸ”“</button>
        </div>
        <div class="info-grid">
            <div class="info-item"><span class="info-label">ì¥ì†Œ</span><span class="info-value" id="placeDisplay">-</span><button class="lock-btn" id="lock-place" onclick="toggleLock('place')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">ê°ì •</span><span class="info-value" id="emotionDisplay">-</span><button class="lock-btn" id="lock-emotion" onclick="toggleLock('emotion')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">ê´€ê³„</span><span class="info-value" id="relationDisplay">-</span><button class="lock-btn" id="lock-relation" onclick="toggleLock('relation')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">í–‰ë™</span><span class="info-value" id="actionDisplay">-</span><button class="lock-btn" id="lock-action" onclick="toggleLock('action')">ğŸ”“</button></div>
        </div>
        <div class="line-area">
            <div class="line-text" id="lineDisplay">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
            <button class="lock-btn" id="lock-line" onclick="toggleLock('line')">ğŸ”“</button>
        </div>
        <div class="btn-row">
            <button class="btn-gen" id="btnGen" onclick="rollScene()">ğŸ² ëœë¤ ë½‘ê¸°</button>
            <button class="btn-save" onclick="saveScene()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
      </div>
      <h3 style="margin-top:40px; margin-bottom:15px; color:#444;">ğŸ“‹ ì €ì¥ëœ ë¯¸ì…˜ (ì œëª© ìˆ˜ì • ê°€ëŠ¥)</h3>
      <div id="missionGrid" class="mission-grid"></div>
    </div>
  </div>

  <div class="tab-content" id="tab2">
    <div class="section">
      <div class="scene-main-card">
        <div class="char-container">
            <div class="char-img-frame">
                <span class="char-placeholder">ì´ë¯¸ì§€ ì¤€ë¹„ì¤‘<br>(appdata í´ë” í™•ì¸)</span>
                <img id="charImgDisplay" class="char-img" src="" style="display:none;" onerror="this.style.display='none'; this.previousElementSibling.style.display='block';">
            </div>
            <div class="char-info-box">
                <div id="charNameDisplay" class="char-name">ìºë¦­í„° ì´ë¦„</div>
                <div id="charJobDisplay" class="char-job">ì§ì—…</div>
                <div id="charDescDisplay" class="char-desc">ë²„íŠ¼ì„ ëˆŒëŸ¬ ìºë¦­í„°ë¥¼ ì†Œí™˜í•˜ì„¸ìš”.</div>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn-male" onclick="rollCharacter('male')">ğŸ‘±â€â™‚ï¸ ë‚¨ì ë½‘ê¸°</button>
            <button class="btn-female" onclick="rollCharacter('female')">ğŸ‘© ì—¬ì ë½‘ê¸°</button>
            <button class="btn-save" onclick="saveCharacter()">â­ ì €ì¥í•˜ê¸°</button>
        </div>
      </div>
      <div id="charSaveGrid" class="char-save-grid"></div>
    </div>
  </div>

  <div class="tab-content" id="tab3">
    <div class="section">
      <div class="train-origin-text" id="train_origin">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¬¸ì¥ì„ ë½‘ì•„ì£¼ì„¸ìš”</div>

      <button class="btn-gen" style="width:100%; padding:15px; font-size:18px; font-weight:bold; border-radius:12px; border:none; color:white; cursor:pointer; margin-bottom:20px;" onclick="trainNew()">âœ¨ ìƒˆ ë¬¸ì¥ ë½‘ê¸°</button>
      
      <div id="train_card" class="train-card">
        <p style="color:#aaa;">'ìƒˆ ë¬¸ì¥ ë½‘ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
      </div>

      <div class="record-box" id="recordBox">
        <div class="pro-player-box">
            <span class="player-label">ğŸ§ í”„ë¡œ ì„±ìš° ì˜ˆì‹œ ë“£ê¸°</span>
            <audio id="proAudio" controls src=""></audio>
        </div>

        <div style="text-align:center; margin: 30px 0;">
            <button id="micBtn" class="mic-btn" onclick="handleAction()">ğŸ¤</button>
            <p id="recStatus" style="font-size:14px; color:#555; margin-top:10px; font-weight:bold;">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘</p>
        </div>

        <div class="result-box" id="resultBox">
            
            <div class="result-section" id="aiSection" style="display:none;">
                <span class="section-title">ğŸ¤– AI ë°œìŒ ì²´í¬</span>
                <div class="stt-result-box">
                    <div id="sttResult" class="stt-text">...</div>
                    <span id="accBadge" class="accuracy-badge acc-wait">ë¶„ì„ ëŒ€ê¸°ì¤‘</span>
                </div>
                <p class="guide-text">* ì •í™•ë„ 30% ì´ìƒì´ë©´ í†µê³¼ì…ë‹ˆë‹¤.</p>
            </div>

            <div class="result-section" id="recSection" style="display:none;">
                <span class="section-title">ğŸ“‚ ë‚´ ë…¹ìŒ í™•ì¸</span>
                <audio id="myAudio" controls src="" style="width:100%;"></audio>
                <div class="time-info">
                    ë‚´ ì‹œê°„: <span id="myTime" class="time-val">0.0s</span> 
                    <span style="font-weight:normal; color:#aaa; margin-left:10px;">(í”„ë¡œ: <span id="proTime">0.0s</span>)</span>
                </div>
            </div>

        </div>
      </div>

      <div class="train-nav" style="margin-top:20px;">
        <button id="btn_prev" onclick="trainPrev()" disabled>â¬… ì´ì „</button>
        <div id="step_indicator" style="font-weight:bold; color:#2ecc71; font-size:18px;">STEP 0</div>
        <button id="btn_next" onclick="trainNext()" disabled>ë‹¤ìŒ â¡</button>
      </div>
    </div>
  </div>

  <div class="tab-content" id="tab4">
    <div class="section">
      <h2>ê¸°ì¶œë¬¸ì œ</h2>
      <p>ì¶”ê°€ ì˜ˆì •</p>
    </div>
  </div>
</main>

<footer>
    <b>ìƒë‹´ì „í™”</b> : 010-7372-5875 <br>
    <b>ì£¼ì†Œ</b> : ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ì²­ëª…ë‚¨ë¡œ 28ë²ˆê¸¸ 2 ì•„ì´í…í…ë¹Œë”© 502í˜¸ <br>
    Copyright Â© ìš¸ë¦¼ì—°ê¸°í•™ì›. All rights reserved.
</footer>

<script>
// --- íƒ­ ë¡œì§ ---
document.querySelectorAll('.tab').forEach(t => {
    t.onclick = () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.tab).classList.add('active');
    };
});

function pick(a){return a[Math.floor(Math.random()*a.length)];}

// --- [íƒ­ 1] ìƒí™©ê·¹ ë¡œì§ (ì™¸ë¶€ ë°ì´í„° ì°¸ì¡°) ---
const defaultEtude = {
    colors: [{name:"ë¹¨ê°•",code:"#e74c3c"}], emotions: ["ê¸°ì¨"], actions: ["í•œìˆ¨"], places: ["í•™êµ"], relations: ["ì¹œêµ¬"], lines: ["ì•ˆë…•?"]
};
const eData = (typeof etudeData !== 'undefined') ? etudeData : defaultEtude;

let locks = {color:false, place:false, emotion:false, relation:false, action:false, line:false};
let currentData = {c:{name:"ìƒ‰ìƒ",code:"#ddd"}, p:"-", e:"-", r:"-", a:"-", l:"ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”"};
let missionCount = 0;

function toggleLock(key){
    locks[key] = !locks[key];
    const btn = document.getElementById('lock-'+key);
    btn.textContent = locks[key] ? "ğŸ”’" : "ğŸ”“";
    btn.classList.toggle("locked");
}

async function rollScene(){
    const btn = document.getElementById('btnGen'); btn.disabled = true;
    const newC = locks.color ? currentData.c : pick(eData.colors);
    const newP = locks.place ? currentData.p : pick(eData.places);
    const newE = locks.emotion ? currentData.e : pick(eData.emotions);
    const newR = locks.relation ? currentData.r : pick(eData.relations);
    const newA = locks.action ? currentData.a : pick(eData.actions);
    const newL = locks.line ? currentData.l : pick(eData.lines);
    
    currentData = {c:newC, p:newP, e:newE, r:newR, a:newA, l:newL};

    const promises = [];
    if(!locks.color) promises.push(spinColor(newC, 600));
    if(!locks.place) promises.push(spinText('placeDisplay', eData.places, newP, 1000));
    if(!locks.emotion) promises.push(spinText('emotionDisplay', eData.emotions, newE, 1400));
    if(!locks.relation) promises.push(spinText('relationDisplay', eData.relations, newR, 1800));
    if(!locks.action) promises.push(spinText('actionDisplay', eData.actions, newA, 2200));
    if(!locks.line) promises.push(spinText('lineDisplay', eData.lines, newL, 2600));
    
    await Promise.all(promises);
    btn.disabled = false;
}

function spinText(id, arr, val, dur){
    return new Promise(r => {
        const el = document.getElementById(id);
        const start = Date.now();
        const int = setInterval(()=>{
            if(Date.now()-start > dur){ clearInterval(int); el.textContent=val; r(); }
            else el.textContent = pick(arr);
        }, 50);
    });
}
function spinColor(val, dur){
    return new Promise(r => {
        const el = document.getElementById('colorDisplay');
        const start = Date.now();
        const int = setInterval(()=>{
            if(Date.now()-start > dur){ clearInterval(int); el.style.backgroundColor=val.code; el.textContent=val.name; r(); }
            else { const t=pick(eData.colors); el.style.backgroundColor=t.code; el.textContent=t.name; }
        }, 50);
    });
}

// ë¯¸ì…˜ ì €ì¥í•˜ê¸° (ì œëª© ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€)
function saveScene(){
    if(currentData.l === "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”") return alert("ë¨¼ì € ëœë¤ ë½‘ê¸°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!");
    missionCount++;
    const div = document.createElement("div"); div.className="mission-card";
    
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px;">
            <input type="text" class="mission-title-input" value="ë¯¸ì…˜ ${missionCount}">
            <span style="background:${currentData.c.code}; color:#fff; padding:4px 8px; border-radius:8px; font-size:12px; font-weight:bold;">${currentData.c.name}</span>
        </div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ì¥ì†Œ:</strong> ${currentData.p}</div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ê°ì •:</strong> ${currentData.e}</div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ê´€ê³„:</strong> ${currentData.r}</div>
        <div style="font-size:14px; color:#555; margin-bottom:10px;"><strong>í–‰ë™:</strong> ${currentData.a}</div>
        <div style="background:#f8f9fa; padding:10px; border-radius:8px; font-weight:800; color:#333; word-break:keep-all;">"${currentData.l}"</div>
    `;
    document.getElementById("missionGrid").prepend(div); // ìµœì‹ ìˆœìœ¼ë¡œ ìœ„ë¡œ ì¶”ê°€
}

/* [íƒ­ 2] ìºë¦­í„° ë¡œì§ (ë¡œì»¬ ê²½ë¡œ ë°©ì‹) */
const maleCharacters = [
    {id:10, name:"ì¹´ì´ì—”", job:"ì™•êµ­ ê¸°ì‚¬ë‹¨ì¥", desc:"ì •ì˜ë¡­ê³  ì—´í˜ˆì ì¸ ë¦¬ë”."},
    {id:1, name:"ë ˆì´ë¸", job:"ê¶ì • ìˆ˜ì„ ë§ˆë²•ì‚¬", desc:"ëƒ‰ì² í•˜ê³  ì´ì„±ì ì¸ ë‘ë‡ŒíŒŒ."},
    {id:2, name:"ì§„", job:"ë’·ê³¨ëª© í•´ê²°ì‚¬", desc:"ëŠ¥ê¸€ë§ê³  ììœ ë¶„ë°©í•œ í˜„ì‹¤ì£¼ì˜ì."},
    {id:4, name:"ë…¸ì•„", job:"ì¹˜ìœ ì˜ ì„±ì§ì", desc:"ì˜¨í™”í•˜ê³  ì„±ìŠ¤ëŸ¬ìš´ ì™¸ëª¨."},
    {id:3, name:"ë¥˜", job:"ì—´í˜ˆ ìš”ë¦¬ì‚¬", desc:"ìš”ë¦¬ì— ëª©ìˆ¨ ê±´ ì •ì—´ë‚¨."},
    {id:5, name:"ì• ì‰¬", job:"ì²œì¬ ë©”ì¹´ë‹‰", desc:"ì‚¬ëŒë³´ë‹¤ ê¸°ê³„ë¥¼ í¸í•´í•˜ëŠ” ê¸°ìˆ  ì˜¤íƒ€ì¿ ."},
    {id:6, name:"ì‹œìš°", job:"í†± ì•„ì´ëŒ ì„¼í„°", desc:"íƒ€ê³ ë‚œ ë¼ì™€ íŒ¬ ì„œë¹„ìŠ¤."},
    {id:7, name:"ë¹…í„°", job:"ëƒ‰í˜¹í•œ CEO", desc:"ëª¨ë“  ê²ƒì„ ìˆ˜ì¹˜ë¡œ ê³„ì‚°í•˜ëŠ” ì—˜ë¦¬íŠ¸."},
    {id:8, name:"í•œìš¸", job:"ì‚¬ì—° ìˆëŠ” íƒì •", desc:"í‰ì†Œì—” ì˜ìš• ì—†ëŠ” ë² ì§±ì´, ì‚¬ê±´ í„°ì§€ë©´ ë‚ ì¹´ë¡œìš´ ì¶”ë¦¬ë ¥."},
    {id:9, name:"ê·¸ë¦¼", job:"ê³¼ë¬µí•œ ì•”ì‚´ì", desc:"ê°ì •ì„ ë°°ì œí•œ ì„ë¬´ ìˆ˜í–‰ ê¸°ê³„."}
];
const femaleCharacters = [
    {id:10, name:"ì„¸ë¼í”¼ë‚˜", job:"í™©ì‹¤ ê·¼ìœ„ëŒ€ì¥", desc:"ë¹ˆí‹ˆì—†ëŠ” ì›ì¹™ì£¼ì˜ì 'ì–¼ìŒ ë§ˆë…€'."},
    {id:2, name:"ë£¨ë‚˜", job:"ê´´ì§œ ë§ˆë…€", desc:"ì¥ë‚œê¸° ë„˜ì¹˜ê³  ììœ ë¡œìš´ ì˜í˜¼."},
    {id:9, name:"ìœ ë‚˜", job:"ëœë ì´ ì„±ë…€ë‹˜", desc:"ì‹ ì„±ë ¥ì€ ìµœê³ ì§€ë§Œ ëœë ì´."},
    {id:1, name:"ë²¨ë¼", job:"íŒ¬í…€ ì‹œí”„", desc:"ìš°ì•„í•˜ê³  ìš”ì—¼í•œ ê´´ë„."},
    {id:8, name:"ì„œì—°", job:"ì™„ë²½ì£¼ì˜ ë¹„ì„œ", desc:"ê±¸ì–´ ë‹¤ë‹ˆëŠ” ì»´í“¨í„°."},
    {id:7, name:"ë¦¬ë‚˜", job:"ì‹ ì¸ ì•„ì´ëŒ", desc:"ì§€ì¹˜ì§€ ì•ŠëŠ” ê¸ì • ì—ë„ˆì§€."},
    {id:6, name:"ì•¨ë¦¬ìŠ¤", job:"í•™ìƒíšŒì¥", desc:"ì „í˜•ì ì¸ ì¸¤ë°ë ˆ."},
    {id:3, name:"íë‹¤", job:"ëŒ€ì¥ì¥ì´", desc:"í„¸í„¸í•œ ì„±ê²©ì˜ ì¥ì¸."},
    {id:4, name:"í•˜ë‚˜", job:"ë§¤ë“œ ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸", desc:"ìƒì‹ì„ ë²—ì–´ë‚œ ê´´ì§œ ë°œëª…ê°€."},
    {id:5, name:"ì¹´ì˜¤ë¦¬", job:"ì‹¬ì•¼ ì‹ë‹¹ ì£¼ì¸", desc:"ë‚˜ê¸‹ë‚˜ê¸‹í•˜ê³  í¬ìš©ë ¥ ìˆëŠ” ì–´ë¥¸."}
];

let currentChar = null;
function rollCharacter(gender) {
    const list = gender === 'male' ? maleCharacters : femaleCharacters;
    const char = pick(list);
    currentChar = {...char, gender: gender==='male'?'ë‚¨ì„±':'ì—¬ì„±'};
    const folder = gender === 'male' ? 'male' : 'female';
    const localPath = `appdata/character/${folder}/${char.id}.jpg`;
    currentChar.fullPath = localPath;

    document.getElementById("charNameDisplay").textContent = char.name;
    document.getElementById("charJobDisplay").textContent = char.job;
    document.getElementById("charDescDisplay").textContent = char.desc;
    
    const imgEl = document.getElementById("charImgDisplay");
    imgEl.style.display = 'none';
    document.querySelector(".char-placeholder").style.display = 'block';
    
    imgEl.src = localPath;
    imgEl.onload = function(){
        this.style.display = 'block';
        document.querySelector(".char-placeholder").style.display = 'none';
    };
}
function saveCharacter(){
    if(!currentChar) return alert("ë¨¼ì € ìºë¦­í„°ë¥¼ ì†Œí™˜í•´ì£¼ì„¸ìš”!");
    const div = document.createElement("div"); div.className="mini-char-card";
    div.innerHTML = `<img src="${currentChar.fullPath}" class="mini-char-img"><div class="mini-char-info"><div>${currentChar.name}</div><div style="color:#aaa; font-size:12px;">${currentChar.job}</div></div>`;
    document.getElementById("charSaveGrid").appendChild(div);
}

/* --- [íƒ­ 3] ë°œì„±í›ˆë ¨ (ì™¸ë¶€ ë°ì´í„° + ë‹¨ê³„ë³„ ë¶„ë¦¬) --- */
let step=0, currentTrainObj=null;
let mediaRecorder, audioChunks = [], isRecording = false, startTime;
let recognition;
let recognitionResult = "";

// 0. ì‹œìŠ¤í…œ ì§„ë‹¨
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const isSpeechSupported = ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window);

// 1. ìœ ì‚¬ë„ ê³„ì‚° (Levenshtein)
function getSimilarity(s1, s2) {
    const longer = s1.length > s2.length ? s1 : s2;
    const shorter = s1.length > s2.length ? s2 : s1;
    if (longer.length === 0) return 1.0;
    return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
}
function editDistance(s1, s2) {
    s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
    const costs = new Array();
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i == 0) costs[j] = j;
            else {
                if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}

// 2. ìŒì„±ì¸ì‹ ì´ˆê¸°í™”
if (isSpeechSupported && !isIOS) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ko-KR';
    recognition.interimResults = false;
    recognition.continuous = false; 

    recognition.onresult = function(event) {
        recognitionResult = event.results[0][0].transcript;
        updateRecognitionUI(); 
    };
    recognition.onerror = function(event) {
        console.log("STT error:", event.error);
        if(!recognitionResult) {
            document.getElementById('sttResult').textContent = "(ì¸ì‹ ë¶ˆê°€ / ë‹¤ì‹œ ì‹œë„)";
            document.getElementById('accBadge').className = 'accuracy-badge acc-wait';
            document.getElementById('accBadge').textContent = 'ì‹¤íŒ¨';
        }
    };
}

function updateRecognitionUI() {
    if(recognitionResult) {
        document.getElementById('sttResult').textContent = `"${recognitionResult}"`;
        
        const targetClean = currentTrainObj.text.replace(/[^ê°€-í£]/g, '');
        const inputClean = recognitionResult.replace(/[^ê°€-í£]/g, '');
        const similarity = getSimilarity(targetClean, inputClean);

        const badge = document.getElementById('accBadge');
        // [íŒì • ê¸°ì¤€ ëŒ€í­ ì™„í™”]
        if (similarity >= 0.7) { 
            badge.className = 'accuracy-badge acc-good';
            badge.textContent = 'ì™„ë²½í•©ë‹ˆë‹¤! (70%â†‘)';
        } else if (similarity >= 0.3) { 
            badge.className = 'accuracy-badge acc-soso';
            badge.textContent = 'í†µê³¼ (30%â†‘)';
        } else {
            badge.className = 'accuracy-badge acc-bad';
            badge.textContent = 'ë‹¤ì‹œ ì‹œë„';
        }
    }
}

function extractVowels(s){
    const V=["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
    let out="";
    for(let ch of s){
        const code = ch.charCodeAt(0);
        if(code<0xac00||code>0xd7a3) { out+=ch; continue; }
        out+=V[Math.floor((code-0xac00)/28)%21];
    }
    return out;
}

// í›ˆë ¨ ì‹œì‘ (vocalData ì‚¬ìš©)
// ê¸°ì¡´ í•˜ë“œì½”ë”© ë°°ì—´ ì‚­ì œí•˜ê³ , ì™¸ë¶€ ë°ì´í„° ë³€ìˆ˜(vocalData)ë¥¼ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤.
// ë§Œì•½ ë¡œë”© ì‹¤íŒ¨ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
const defaultVocalData = [
    { id: 1, text: "ë°ì´í„°ê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", pron: "ë°ì´í„°ê°€ ë¡œë”©ë˜ì§€ ì•„ë‚¬ìŠµë‹ˆë‹¤", audio: "" }
];
let trainDataList = (typeof vocalData !== 'undefined') ? vocalData : defaultVocalData;

function trainNew(){
    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (í˜¹ì‹œ ëŠ¦ê²Œ ë¡œë“œë˜ì—ˆì„ ê²½ìš°)
    if(typeof vocalData !== 'undefined') trainDataList = vocalData;

    currentTrainObj = pick(trainDataList); 
    step=1;
    document.getElementById("train_origin").textContent = currentTrainObj.text; 
    document.getElementById("recordBox").style.display = 'none';

    const proAudio = document.getElementById("proAudio");
    // ì™¸ë¶€ ë°ì´í„° ê²½ë¡œ ì ìš©
    proAudio.src = currentTrainObj.audio || ""; 
    proAudio.onloadedmetadata = function() {
        document.getElementById("proTime").textContent = proAudio.duration.toFixed(1) + "s";
    };
    renderTrain();
}

function trainPrev(){ if(step>1) {step--; renderTrain();} }
function trainNext(){ if(step<7) {step++; renderTrain();} }

function renderTrain(){
    const box = document.getElementById("train_card");
    const ind = document.getElementById("step_indicator");
    // ì´ 7ë‹¨ê³„ë¡œ ë³€ê²½
    const T=["","STEP1 ëª¨ìŒì„ í˜¸í¡ìœ¼ë¡œ","STEP2 ëª¨ìŒ ì†Œë¦¬","STEP3 ì›ë¬¸ í˜¸í¡","STEP4 ì›ë¬¸ ì†Œë¦¬","STEP5 ìì—° í˜¸í¡","STEP6 ë°œìŒ AI ì²´í¬","STEP7 ìµœì¢… ë…¹ìŒ"];
    const D=["","ëª¨ìŒ ì…ëª¨ì–‘ ì‹ ê²½ì“°ë©° í˜¸í¡ìœ¼ë¡œ ì½ê¸°","ì†Œë¦¬ë‚´ê¸°","(ë°œìŒëŒ€ë¡œ) í˜¸í¡","(ë°œìŒëŒ€ë¡œ) ì†Œë¦¬","ìì—° í˜¸í¡","AIê°€ ë°œìŒ ì •í™•ë„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.","ìµœì¢… ê²°ê³¼ë¬¼ì„ ë…¹ìŒí•˜ê³  ë“¤ì–´ë³´ì„¸ìš”."];

    let showText = "";
    if (step <= 2) { showText = extractVowels(currentTrainObj.text); }
    else if (step <= 7) { showText = currentTrainObj.pron; } // Step 3ë¶€í„° ëê¹Œì§€ ë°œìŒëŒ€ë¡œ í‘œê¸°

    ind.textContent="STEP "+step;
    box.innerHTML=
        `<div style='font-size:20px; font-weight:900; margin-bottom:10px;'>${T[step]}</div>
         <div style='color:#666; margin-bottom:20px; font-size:15px;'>${D[step]}</div>
         <div class='train-main-text'>${showText}</div>`;

    document.getElementById("btn_prev").disabled = step===1;
    document.getElementById("btn_next").disabled = step===7;

    // í•˜ë‹¨ ë°•ìŠ¤ í‘œì‹œ ì œì–´
    const recBox = document.getElementById("recordBox");
    const micBtn = document.getElementById("micBtn");
    const recStatus = document.getElementById("recStatus");
    const aiSection = document.getElementById("aiSection");
    const recSection = document.getElementById("recSection");

    if(step === 6) {
        // Step 6: AI ì²´í¬ ëª¨ë“œ
        recBox.style.display = 'block';
        recBox.scrollIntoView({behavior: "smooth"});
        micBtn.textContent = 'ğŸ—£ï¸';
        recStatus.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ AI ì²´í¬ ì‹œì‘";
        aiSection.style.display = 'block';
        recSection.style.display = 'none'; // ë…¹ìŒ ê²°ê³¼ ìˆ¨ê¹€
        // ê²°ê³¼ ì´ˆê¸°í™”
        document.getElementById("resultBox").style.display = 'none';
    } else if (step === 7) {
        // Step 7: ë…¹ìŒ ëª¨ë“œ
        recBox.style.display = 'block';
        recBox.scrollIntoView({behavior: "smooth"});
        micBtn.textContent = 'ğŸ¤';
        recStatus.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘";
        aiSection.style.display = 'none'; // AI ê²°ê³¼ ìˆ¨ê¹€
        recSection.style.display = 'block';
        // ê²°ê³¼ ì´ˆê¸°í™”
        document.getElementById("resultBox").style.display = 'none';
    } else {
        recBox.style.display = 'none';
    }
}

// ê³µí†µ í•¸ë“¤ëŸ¬ (ë‹¨ê³„ë³„ ê¸°ëŠ¥ ë¶„ê¸°)
async function handleAction() {
    if(step === 6) {
        // AI ì²´í¬
        startRecognition();
    } else if (step === 7) {
        // ë…¹ìŒ
        toggleRecord();
    }
}

/* --- Step 6: AI ì¸ì‹ ê¸°ëŠ¥ --- */
function startRecognition() {
    if(!isSpeechSupported) return alert("ì´ ê¸°ê¸°ì—ì„œëŠ” AI ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    
    if(!isRecording) {
        // ì‹œì‘
        isRecording = true;
        recognitionResult = "";
        try { recognition.start(); } catch(e) { console.log(e); }
        
        const btn = document.getElementById('micBtn');
        btn.textContent = 'â¬›';
        btn.classList.add('recording');
        document.getElementById('recStatus').textContent = "ë“£ëŠ” ì¤‘...";
        
        // UI ì´ˆê¸°í™”
        document.getElementById('resultBox').style.display='block';
        document.getElementById('sttResult').textContent = "...";
        document.getElementById('accBadge').className = 'accuracy-badge acc-wait';
        document.getElementById('accBadge').textContent = 'ë¶„ì„ì¤‘...';

    } else {
        // ì •ì§€ (ìˆ˜ë™) -> ë³´í†µì€ ìë™ ì¢…ë£Œë¨
        try { recognition.stop(); } catch(e) { }
        isRecording = false;
        resetBtn();
    }
}

function resetBtn() {
    const btn = document.getElementById('micBtn');
    btn.classList.remove('recording');
    if(step === 6) {
        btn.textContent = 'ğŸ—£ï¸';
        document.getElementById('recStatus').textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ AI ì²´í¬ ì‹œì‘";
    } else {
        btn.textContent = 'ğŸ¤';
        document.getElementById('recStatus').textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘";
    }
}


/* --- Step 7: ë…¹ìŒ ê¸°ëŠ¥ --- */
async function toggleRecord() {
    if(window.location.protocol === 'file:') {
        alert("ì£¼ì˜: ë¡œì»¬ íŒŒì¼ì—ì„œëŠ” ë§ˆì´í¬ê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    if (!isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.start();
            
            startTime = Date.now();
            isRecording = true;
            
            const btn = document.getElementById('micBtn');
            btn.textContent = 'â¬›'; 
            btn.classList.add('recording');
            document.getElementById('recStatus').textContent = "ë…¹ìŒ ì¤‘...";
            document.getElementById('resultBox').style.display='none'; 

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks);
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = document.getElementById('myAudio');
                audio.src = audioUrl;
                
                const duration = (Date.now() - startTime) / 1000;
                document.getElementById('myTime').textContent = duration.toFixed(1) + "s";
                document.getElementById('resultBox').style.display='block'; 
                stream.getTracks().forEach(track => track.stop());
            });
        } catch (e) {
            alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\nì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.");
        }
    } else {
        if(mediaRecorder) mediaRecorder.stop();
        isRecording = false;
        resetBtn();
    }
}

if (isSpeechSupported) {
    recognition.onend = function() {
        isRecording = false;
        resetBtn();
    };
}
</script>
</body>
</html>
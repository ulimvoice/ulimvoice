<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìš¸ë¦¼ ì„±ìš°Â·ìŠ¤í”¼ì¹˜Â·ì—°ê¸°í•™ì› í†µí•© ì—°ìŠµ í”„ë¡œê·¸ë¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="appdata/etude/data.js"></script>
<script src="appdata/vocalization/data.js"></script>
<script src="appdata/past_questions/data.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
/* ===========================
   ê¸°ë³¸ ìŠ¤íƒ€ì¼
   =========================== */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f5f7fb; margin: 0; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
.wrapper { max-width: 1200px; width: 95%; margin: 0 auto; flex: 1; padding: 20px 0; }

/* í—¤ë” & í‘¸í„° */
header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
.header-content { max-width: 1200px; width: 100%; display: flex; align-items: center; }
.logo-img { height: 45px; width: auto; margin-right: 12px; }
.header-title { font-size: 20px; font-weight: 800; color: #2ecc71; margin: 0; word-break: keep-all; }
footer { background: #333; color: #aaa; padding: 30px 20px; text-align: center; font-size: 13px; line-height: 1.6; margin-top: 40px; }
footer b { color: #fff; font-weight: 700; }

/* íƒ­ ë° ê³µí†µ UI */
.tabs { display: flex; gap: 5px; border-bottom: 2px solid #ddd; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
.tab { padding: 12px 16px; cursor: pointer; font-weight: 700; color: #666; font-size: 15px; transition: 0.2s; flex-shrink: 0; }
.tab.active { background: #fff; color: #2ecc71; border: 1px solid #ddd; border-bottom: none; border-radius: 10px 10px 0 0; }
.tab-content { display: none; animation: fadeIn 0.3s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.section { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }

/* ë²„íŠ¼ ê³µí†µ */
.btn-row { display: flex; gap: 10px; margin-top: 20px; }
.btn-row button { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 17px; font-weight: 800; cursor: pointer; color: white; transition: 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); white-space: nowrap; }
.btn-row button:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
.btn-gen { background: #2ecc71; } .btn-save { background: #3498db; } .btn-male { background: #3498db; } .btn-female { background: #ff7979; }
.btn-share { background: #e67e22; }
.lock-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.05); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; z-index: 10; }
.lock-btn.locked { background: #ff4757; color: white; opacity: 1; }

/* íƒ­ 1 */
.scene-main-card { border: 2px solid #f0f0f0; border-radius: 20px; padding: 30px 20px; background: #fff; text-align: center; margin-bottom: 30px; }
.color-badge-box { width: 100%; height: 80px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 20px; position: relative; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; text-align: left; }
.info-item { background: #f9f9f9; padding: 15px; border-radius: 14px; position: relative; min-height: 50px; display: flex; flex-direction: column; justify-content: center; }
.info-label { font-size: 12px; color: #888; font-weight: 700; margin-bottom: 4px; display:block; }
.info-value { font-size: 17px; font-weight: 700; color: #333; word-break: keep-all; }
.line-area { padding: 25px; background: #f0fdf4; border-radius: 16px; border: 2px solid #dcfce7; margin-bottom: 20px; position: relative; }
.line-text { font-size: 24px; font-weight: 900; color: #166534; word-break: keep-all; line-height: 1.4; }
.mission-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
.mission-card { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.mission-title-input { border: none; border-bottom: 1px dashed #ccc; font-size: 16px; font-weight: 800; color: #333; width: 150px; padding: 2px; background: transparent; }
.mission-title-input:focus { outline: none; border-bottom: 2px solid #2ecc71; }

/* íƒ­ 2 */
.char-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
.char-img-frame { width: 100%; max-width: 300px; aspect-ratio: 1/1; border-radius: 20px; overflow: hidden; background: #f0f0f0; border: 5px solid #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; position: relative; }
.char-img { width: 100%; height: 100%; object-fit: cover; }
.char-placeholder { color: #aaa; text-align: center; font-size: 14px; padding: 20px; }
.char-info-box { text-align: center; width: 100%; }
.char-name { font-size: 26px; font-weight: 900; color: #333; margin-bottom: 5px; }
.char-job { font-size: 17px; color: #2ecc71; font-weight: 700; margin-bottom: 15px; }
.char-desc { background: #f8f9fa; padding: 20px; border-radius: 14px; font-size: 16px; color: #555; line-height: 1.6; border: 1px solid #eee; word-break: keep-all; }
.char-save-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 30px; }
.mini-char-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; font-size: 13px; border:1px solid #eee; }
.mini-char-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background:#ddd; }
.mini-char-info { padding: 10px; }

/* íƒ­ 3 */
.train-origin-text { 
    font-size: 20px; font-weight: 700; color: #333; text-align: center; 
    margin-bottom: 25px; word-break: keep-all; line-height: 1.5; 
    min-height: 30px; padding: 15px; background: #e8f5e9; border-radius: 12px; border: 1px solid #c8e6c9;
}
.train-card { background: #fff; border: 2px solid #eee; border-radius: 20px; padding: 30px 15px; text-align: center; margin-bottom: 20px; }
.train-main-text { font-size: 32px; font-weight: 900; color: #2ecc71; word-break: keep-all; line-height: 1.3; margin: 20px 0; }
.train-nav { display: flex; justify-content: space-between; align-items: center; gap:10px; margin-top:20px;}
.train-nav button { background: #333; color: #fff; padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; }
.train-nav button:disabled { background: #ddd; cursor: not-allowed; }

.record-box { margin-top: 10px; padding-top: 20px; border-top: 2px dashed #eee; display: none; }
.pro-player-box { background: #f0fdf4; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; }
.player-label { font-size: 12px; font-weight: 800; color: #2ecc71; margin-bottom: 5px; display: block; }
audio { width: 100%; height: 40px; }

.mic-btn {
    width: 80px; height: 80px; border-radius: 50%; background: #ff4757; color: white; border: none;
    font-size: 34px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.5); display: flex; align-items: center; justify-content: center; margin: 0 auto;
    transition: transform 0.1s;
}
.mic-btn:active { transform: scale(0.95); }
.mic-btn.recording { animation: pulse 1.5s infinite; background: #333; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }

/* í†µí•© ê²°ê³¼ ë°•ìŠ¤ */
.result-box { margin-top: 20px; background: #fff; border-radius: 15px; border: 1px solid #e0e0e0; display: none; overflow:hidden; }
.result-section { padding: 20px; border-bottom: 1px solid #f0f0f0; }
.result-section:last-child { border-bottom: none; }
.section-title { font-size: 14px; font-weight: 800; color: #555; margin-bottom: 10px; display: flex; align-items:center; gap:5px; }
.time-info { margin-top:8px; font-size:14px; color:#555; font-weight:bold; }
.time-val { color: #ff4757; font-weight:900; }
.stt-text { font-size: 18px; color: #333; line-height: 1.4; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:10px; font-weight:500; min-height: 40px;}
.accuracy-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 13px; color: white; font-weight:bold; }
.acc-good { background: #2ecc71; } .acc-bad { background: #ff6b6b; } .acc-soso { background: #f1c40f; } .acc-wait { background: #aaa; }
.guide-text { font-size:12px; color:#999; margin-top:5px; }

/* íƒ­ 4: ê¸°ì¶œë¬¸ì œ UI */
.past-display-card { border: 2px solid #ddd; border-radius: 20px; padding: 30px; background: #fff; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; word-break: keep-all; margin-bottom:20px; }
.past-role { font-size: 20px; font-weight: 900; color: #2ecc71; margin-bottom: 20px; }
.past-lines { font-size: 18px; line-height: 1.8; color: #333; white-space: pre-wrap; font-family: 'KoPub Batang', serif; }

@media (max-width: 600px) {
    .section { padding: 20px; }
    .info-grid { grid-template-columns: 1fr; }
    .line-text { font-size: 22px; }
    .train-main-text { font-size: 28px; }
    .header-title { font-size: 18px; }
    .logo-img { height: 35px; }
    .btn-row { flex-wrap: wrap; }
    .btn-row button { min-width: 45%; }
}
</style>
</head>
<body>

<header>
    <div class="header-content">
        <img src="appdata/logo.png" class="logo-img" alt="ìš¸ë¦¼ì—°ê¸°í•™ì›" onerror="this.style.display='none';">
        <h1 class="header-title">ìš¸ë¦¼ì—°ê¸°í•™ì› ì—°ìŠµ í”„ë¡œê·¸ë¨</h1>
    </div>
</header>

<main class="wrapper">
  <div class="tabs">
    <div class="tab active" data-tab="tab1">ğŸ­ ìƒí™©ê·¹</div>
    <div class="tab" data-tab="tab2">ğŸ¨ ìºë¦­í„°</div>
    <div class="tab" data-tab="tab3">ğŸ¤ ë°œì„±í›ˆë ¨</div>
    <div class="tab" data-tab="tab4">ğŸ“„ ê¸°ì¶œë¬¸ì œ</div>
  </div>

  <div class="tab-content active" id="tab1">
    <div class="section">
      <div class="scene-main-card">
        <div class="color-badge-box" id="colorBg" style="background:#ddd;">
            <span id="colorText">ìƒ‰ìƒ</span>
            <button class="lock-btn" id="lock-color" onclick="toggleLock('color')">ğŸ”“</button>
        </div>
        <div class="info-grid">
            <div class="info-item"><span class="info-label">ì¥ì†Œ</span><span class="info-value" id="placeDisplay">-</span><button class="lock-btn" id="lock-place" onclick="toggleLock('place')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">ê°ì •</span><span class="info-value" id="emotionDisplay">-</span><button class="lock-btn" id="lock-emotion" onclick="toggleLock('emotion')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">ê´€ê³„</span><span class="info-value" id="relationDisplay">-</span><button class="lock-btn" id="lock-relation" onclick="toggleLock('relation')">ğŸ”“</button></div>
            <div class="info-item"><span class="info-label">í–‰ë™</span><span class="info-value" id="actionDisplay">-</span><button class="lock-btn" id="lock-action" onclick="toggleLock('action')">ğŸ”“</button></div>
        </div>
        <div class="line-area">
            <div class="line-text" id="lineDisplay">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
            <button class="lock-btn" id="lock-line" onclick="toggleLock('line')">ğŸ”“</button>
        </div>
        <div class="btn-row">
            <button class="btn-gen" id="btnGen" onclick="rollScene()">ğŸ² ëœë¤ ë½‘ê¸°</button>
            <button class="btn-save" onclick="saveScene()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            <button class="btn-share" id="btnShare" onclick="shareSceneAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€/ê³µìœ </button>
        </div>
      </div>
      <h3 style="margin-top:30px; color:#555;">ğŸ“‹ ì €ì¥ëœ ë¯¸ì…˜</h3>
      <div id="missionGrid" class="mission-grid"></div>
    </div>
  </div>

  <div class="tab-content" id="tab2">
    <div class="section">
      <div class="scene-main-card" id="characterCard">
        <div class="char-container">
            <div class="char-img-frame">
                <span class="char-placeholder">ë½‘ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</span>
                <img id="charImgDisplay" class="char-img" src="" style="display:none;" onerror="this.style.display='none'; this.previousElementSibling.style.display='block';">
            </div>
            <div class="char-info-box">
                <div id="charNameDisplay" class="char-name">ìºë¦­í„° ì´ë¦„</div>
                <div id="charJobDisplay" class="char-job">ì§ì—…</div>
                <div id="charDescDisplay" class="char-desc">ë²„íŠ¼ì„ ëˆŒëŸ¬ ìºë¦­í„°ë¥¼ ì†Œí™˜í•˜ì„¸ìš”.</div>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn-male" onclick="rollCharacter('male')">ğŸ‘±â€â™‚ï¸ ë‚¨ì ë½‘ê¸°</button>
            <button class="btn-female" onclick="rollCharacter('female')">ğŸ‘© ì—¬ì ë½‘ê¸°</button>
            <button class="btn-save" onclick="saveCharacter()">â­ ì €ì¥í•˜ê¸°</button>
            <button class="btn-share" onclick="shareCharacterAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€/ê³µìœ </button>
        </div>
      </div>
      <div id="charSaveGrid" class="char-save-grid"></div>
    </div>
  </div>

 <div class="tab-content" id="tab3">
    <div class="section">
      <div class="train-origin-text" id="train_origin">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¬¸ì¥ì„ ë½‘ì•„ì£¼ì„¸ìš”</div>

      <div class="btn-row" style="margin-bottom: 20px;">
        <button class="btn-gen" style="flex: 2;" onclick="trainNew()">âœ¨ ìƒˆ ë¬¸ì¥ ë½‘ê¸°</button>
        <button class="btn-save" id="btnComplete" style="flex: 1; background: #2980b9; display: none;" onclick="completeTraining()">âœ… ì—°ìŠµ ì™„ë£Œ</button>
      </div>
      
      <button onclick="toggleCalendar()" style="width:100%; padding:10px; margin-top:5px; background:#ddd; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">
        ğŸ“… ì—°ìŠµ ê¸°ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°
      </button>

      <div id="calendarDisplayArea" style="display: none;">
        <h3 style="margin-top:20px; color:#555;">ğŸ“… ì—°ìŠµ ê¸°ë¡</h3>
        <div id="calendarContainer" style="display: flex; justify-content: center; margin-top: 15px;">
          </div>
        <p style="font-size:12px; color:#aaa; text-align:center; margin-top:10px;">(O: ì™„ë£Œ, X: ë¯¸ì™„ë£Œ)</p>
      </div>
      
      <div id="train_card" class="train-card">
        <p style="color:#aaa;">'ìƒˆ ë¬¸ì¥ ë½‘ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
      </div>

      <div class="record-box" id="recordBox">
        <div class="pro-player-box">
            <span class="player-label">ğŸ§ í”„ë¡œ ì„±ìš° ì˜ˆì‹œ ë“£ê¸°</span>
            <audio id="proAudio" controls src=""></audio>
        </div>

        <div style="text-align:center; margin: 30px 0;">
            <button id="micBtn" class="mic-btn" onclick="handleAction()">ğŸ¤</button>
            <p id="recStatus" style="font-size:14px; color:#555; margin-top:10px; font-weight:bold;">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘</p>
        </div>

        <div class="result-box" id="resultBox">
            <div class="result-section" id="aiSection" style="display:none;">
                <span class="section-title">ğŸ¤– AI ë°œìŒ ì²´í¬</span>
                <div class="stt-result-box">
                    <div id="sttResult" class="stt-text">...</div>
                    <span id="accBadge" class="accuracy-badge acc-wait">ë¶„ì„ ëŒ€ê¸°ì¤‘</span>
                </div>
                <p class="guide-text">* ì •í™•ë„ 30% ì´ìƒì´ë©´ í†µê³¼ì…ë‹ˆë‹¤.</p>
            </div>

            <div class="result-section" id="recSection" style="display:none;">
                <span class="section-title">ğŸ“‚ ë‚´ ë…¹ìŒ í™•ì¸</span>
                <audio id="myAudio" controls src="" style="width:100%;"></audio>
                <div class="time-info">
                    ë‚´ ì‹œê°„: <span id="myTime" class="time-val">0.0s</span> 
                    <span style="font-weight:normal; color:#aaa; margin-left:10px;">(í”„ë¡œ: <span id="proTime">0.0s</span>)</span>
                </div>
                <button class="btn-save" style="width:100%; margin-top:15px; background:#4CAF50;" onclick="shareVocalResult()">ğŸ”— ë…¹ìŒ íŒŒì¼ ê³µìœ í•˜ê¸°</button>
            </div>
        </div>
      </div>
      
      <div class="train-nav" style="margin-top:20px;">
        <button id="btn_prev" onclick="trainPrev()" disabled>â¬… ì´ì „</button>
        <div id="step_indicator" style="font-weight:bold; color:#2ecc71; font-size:18px;">STEP 0</div>
        <button id="btn_next" onclick="trainNext()" disabled>ë‹¤ìŒ â¡</button>
      </div>
    </div>
  </div>

<div id="recordDisplayBox" style="
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.7); display: none; justify-content: center; 
    align-items: center; z-index: 9999;
">
    <div style="
        background: white; padding: 30px; border-radius: 20px; max-width: 400px; 
        width: 90%; box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    ">
        <h3 id="recordDisplayDate" style="color: #2980b9; margin-top: 0;">ê¸°ë¡ ìƒì„¸</h3>
        <p id="recordDisplayContent" style="
            background: #f8f8f8; padding: 15px; border-radius: 10px; 
            font-size: 16px; line-height: 1.5; word-break: break-all;
        ">ì„ íƒëœ ë‚ ì§œì˜ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        <button onclick="document.getElementById('recordDisplayBox').style.display='none';" style="
            width: 100%; padding: 10px; background: #e74c3c; color: white; border: none; 
            border-radius: 10px; margin-top: 20px; cursor: pointer; font-weight: bold;
        ">ë‹«ê¸°</button>
    </div>
</div>
<div class="tab-content" id="tab4">
    <div class="section">
      <div class="past-display-card">
        <div id="pastRoleDisplay" class="past-role">ë²„íŠ¼ì„ ëˆŒëŸ¬ ëŒ€ë³¸ì„ ë½‘ì•„ì£¼ì„¸ìš”</div>
        <div id="pastLinesDisplay" class="past-lines">-</div>
      </div>

      <div class="btn-row">
        <button class="btn-male" onclick="rollPastQuestion('male')">ğŸ‘±â€â™‚ï¸ ë‚¨ì ê¸°ì¶œ ë½‘ê¸°</button>
        <button class="btn-female" onclick="rollPastQuestion('female')">ğŸ‘© ì—¬ì ê¸°ì¶œ ë½‘ê¸°</button>
      </div>

      <div class="record-box" id="pastRecordBox" style="display:block; margin-top:30px; border-top:2px dashed #eee; padding-top:20px;">
        <div style="text-align:center; margin-bottom: 20px;">
            <p style="font-size:16px; font-weight:800; color:#333; margin-bottom:15px;">ğŸ™ï¸ ì‹¤ì „ ë…¹ìŒ ì—°ìŠµ</p>
            <button id="pastMicBtn" class="mic-btn" onclick="togglePastRecord()">ğŸ¤</button>
            <p id="pastRecStatus" style="font-size:14px; color:#555; margin-top:10px; font-weight:bold;">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘</p>
        </div>

        <div class="result-box" id="pastResultBox" style="display:none;">
            <div class="result-section">
                <span class="section-title">ğŸ“‚ ë‚´ ë…¹ìŒ í™•ì¸</span>
                <audio id="pastAudio" controls src="" style="width:100%;"></audio>
                <div class="time-info">
                    ë…¹ìŒ ì‹œê°„: <span id="pastTime" class="time-val">0.0s</span>
                </div>
            </div>
        </div>
      </div>

    </div>
  </div>
</main>

<footer>
    <b>ìƒë‹´ì „í™”</b> : 010-7372-5875 <br>
    <b>ì£¼ì†Œ</b> : ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ì²­ëª…ë‚¨ë¡œ 28ë²ˆê¸¸ 2 ì•„ì´í…í…ë¹Œë”© 502í˜¸ <br>
    Copyright Â© ìš¸ë¦¼ì—°ê¸°í•™ì›. All rights reserved.
</footer>
<script>

// â­ 1. ìƒˆë¡œìš´ GAS ì¸ì¦ API URL (1ë‹¨ê³„ì—ì„œ ë³µì‚¬í•œ URLë¡œ êµì²´) â­
const GET_API_URL = 'https://script.google.com/macros/s/AKfycbwF5bgM15euvMN0mxQOi_B3q6YQnDIbMHr0G1lGGeIuqQ2gJAzN2giQ5cBzrB82Dt24XQ/exec'; 

// â­ 2. ê¸°ì¡´ ë°ì´í„° ì „ì†¡ GAS URLì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ë®ì–´ì“°ê¸° ê¸ˆì§€) â­
const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzUZ5JUmeRTz3HU7r8fX4urykKE-wNH9VTwSsoovIJfBJOFOFIxOJvp6cfHikexZoI0Xg/exec';

// í˜ì´ì§€ ë¡œë“œ ì‹œ í•™ìƒ ì´ë¦„ ë° ì¸ì¦ í™•ì¸
async function checkStudentName() {
    if (!studentName || !phoneLast4 || instructorName === 'ê¸°ë³¸') {
        await promptAndAuthenticate();
    }
    // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ëª…ì„ ì—…ë°ì´íŠ¸í•  ì¤€ë¹„
    updateFilenameConstants();
}

// â­ ìƒˆë¡œ ì¶”ê°€/ìˆ˜ì •: ì¸ì¦ í”„ë¡¬í”„íŠ¸ ë° GAS ì¸ì¦ ìš”ì²­ í•¨ìˆ˜ â­
async function promptAndAuthenticate() {
    let name = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    let phone = prompt("ì¶œê²°ë²ˆí˜¸ (íœ´ëŒ€í° ë²ˆí˜¸ ë’¤ ë„¤ ìë¦¬)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    if (!name || !phone || phone.length !== 4) {
        alert("ì¸ì¦ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤. (íŒŒì¼ ì´ë¦„: ê²ŒìŠ¤íŠ¸_ê¸°ë³¸_0000)");
        studentName = "ê²ŒìŠ¤íŠ¸";
        instructorName = "ê¸°ë³¸";
        phoneLast4 = "0000";
        localStorage.setItem('studentName', studentName);
        localStorage.setItem('instructorName', instructorName);
        localStorage.setItem('phoneLast4', phoneLast4);
        return;
    }
    
    // GAS ì¸ì¦ API í˜¸ì¶œ
    const url = `${GET_API_URL}?name=${encodeURIComponent(name)}&phoneLast4=${phone}`;
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” GAS ì„œë²„ ì˜¤ë¥˜.");
        
        const result = await response.json();

        if (result.status === 'success') {
            studentName = result.name;
            instructorName = result.instructor;
            phoneLast4 = result.phoneLast4;
            
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('instructorName', instructorName);
            localStorage.setItem('phoneLast4', phoneLast4);
            alert(`ì¸ì¦ ì„±ê³µ: ${studentName}ë‹˜ (${instructorName} ê°•ì‚¬)`);
        } else {
            alert(`ì¸ì¦ ì‹¤íŒ¨: ${result.message}\nê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.`);
            studentName = "ê²ŒìŠ¤íŠ¸"; instructorName = "ê¸°ë³¸"; phoneLast4 = "0000";
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('instructorName', instructorName);
            localStorage.setItem('phoneLast4', phoneLast4);
        }
    } catch (e) {
        alert(`ì¸ì¦ ì‹œìŠ¤í…œ ì˜¤ë¥˜. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
        studentName = "ê²ŒìŠ¤íŠ¸"; instructorName = "ê¸°ë³¸"; phoneLast4 = "0000";
        localStorage.setItem('studentName', studentName);
        localStorage.setItem('instructorName', instructorName);
    }
}

// â­ ìƒˆë¡œ ì¶”ê°€: íŒŒì¼ëª… ë² ì´ìŠ¤ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì¸ì¦ í›„ í˜¸ì¶œë¨) â­
function updateFilenameConstants() {
    // ìµœì¢… íŒŒì¼ëª… í˜•ì‹: ê°•ì‚¬ì´ë¦„_í•™ìƒì´ë¦„_ì¶œê²°ë²ˆí˜¸.mp4
    const filenameBase = `${instructorName}_${studentName}_${phoneLast4}`;
    
    // íŠ¹ìˆ˜ë¬¸ì ë° ê³µë°± ì œê±°
    currentFilenameBase = filenameBase.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\uAC00-\uD7A3]/g, '');
}
// --- [íƒ­ 1] ìƒí™©ê·¹ ë¡œì§ (ê³µí†µ í•¨ìˆ˜ í¬í•¨) ---
const defaultEtude = { colors: [], places: [], emotions: [], relations: [], actions: [], lines: [] };
const eData = (typeof etudeData !== 'undefined') ? etudeData : defaultEtude;

let locks = {color:false, place:false, emotion:false, relation:false, action:false, line:false};
let currentData = {c:{name:"ìƒ‰ìƒ",code:"#ddd"}, p:"-", e:"-", r:"-", a:"-", l:"ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”"};
let missionCount = 0;

function toggleLock(key){
    locks[key] = !locks[key];
    const btn = document.getElementById('lock-'+key);
    btn.textContent = locks[key] ? "ğŸ”’" : "ğŸ”“";
    btn.classList.toggle("locked");
}

async function rollScene(){
    const btn = document.getElementById('btnGen'); btn.disabled = true;
    const newC = locks.color ? currentData.c : pick(eData.colors || []);
    const newP = locks.place ? currentData.p : pick(eData.places || []);
    const newE = locks.emotion ? currentData.e : pick(eData.emotions || []);
    const newR = locks.relation ? currentData.r : pick(eData.relations || []);
    const newA = locks.action ? currentData.a : pick(eData.actions || []);
    const newL = locks.line ? currentData.l : pick(eData.lines || []);
    
    currentData = {c:newC, p:newP, e:newE, r:newR, a:newA, l:newL};

    const promises = [];
    if(!locks.color && eData.colors) promises.push(spinColor(newC, 600));
    if(!locks.place && eData.places) promises.push(spinText('placeDisplay', eData.places, newP, 1000));
    if(!locks.emotion && eData.emotions) promises.push(spinText('emotionDisplay', eData.emotions, newE, 1400));
    if(!locks.relation && eData.relations) promises.push(spinText('relationDisplay', eData.relations, newR, 1800));
    if(!locks.action && eData.actions) promises.push(spinText('actionDisplay', eData.actions, newA, 2200));
    if(!locks.line && eData.lines) promises.push(spinText('lineDisplay', eData.lines, newL, 2600));
    
    await Promise.all(promises);
    btn.disabled = false;
}

function spinText(id, arr, val, dur){
    return new Promise(r => {
        const el = document.getElementById(id);
        const start = Date.now();
        const int = setInterval(()=>{
            if(Date.now()-start > dur){ clearInterval(int); el.textContent=val; r(); }
            else el.textContent = pick(arr);
        }, 50);
    });
}
function spinColor(val, dur){
    return new Promise(r => {
        const bg = document.getElementById('colorBg');
        const text = document.getElementById('colorText');
        const start = Date.now();
        const int = setInterval(()=>{
            if(Date.now()-start > dur){ 
                clearInterval(int); 
                bg.style.backgroundColor=val.code; 
                text.textContent=val.name; 
                r(); 
            }
            else { 
                const t=pick(eData.colors || []); 
                bg.style.backgroundColor=t.code; 
                text.textContent=t.name; 
            }
        }, 50);
    });
}

function saveScene(){
    if(currentData.l === "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”") return alert("ë¨¼ì € ëœë¤ ë½‘ê¸°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!");
    missionCount++;
    const div = document.createElement("div"); div.className="mission-card";
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px;">
            <input type="text" class="mission-title-input" value="ë¯¸ì…˜ ${missionCount}">
            <span style="background:${currentData.c.code}; color:#fff; padding:4px 8px; border-radius:8px; font-size:12px; font-weight:bold;">${currentData.c.name}</span>
        </div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ì¥ì†Œ:</strong> ${currentData.p}</div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ê°ì •:</strong> ${currentData.e}</div>
        <div style="font-size:14px; color:#555; margin-bottom:4px;"><strong>ê´€ê³„:</strong> ${currentData.r}</div>
        <div style="font-size:14px; color:#555; margin-bottom:10px;"><strong>í–‰ë™:</strong> ${currentData.a}</div>
        <div style="background:#f8f9fa; padding:10px; border-radius:8px; font-weight:800; color:#333; word-break:keep-all;">"${currentData.l}"</div>
    `;
    document.getElementById("missionGrid").prepend(div);
}

// ìƒí™©ê·¹ ë¯¸ì…˜ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥ ë° ê³µìœ í•˜ëŠ” í•¨ìˆ˜
function shareSceneAsImage() {
    const targetElement = document.querySelector('.scene-main-card');

    if (currentData.l === "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”") {
        return alert("ë¨¼ì € 'ëœë¤ ë½‘ê¸°'ë¥¼ ì§„í–‰í•´ì•¼ ì´ë¯¸ì§€ ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
    }

    html2canvas(targetElement, {
        allowTaint: true,
        useCORS: true,
        scale: 2
    }).then(canvas => {
        const imageURL = canvas.toDataURL("image/png");

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], 'image.png', {type: 'image/png'})] })) {
            canvas.toBlob(function(blob) {
                const filesArray = [new File([blob], 'scene-mission.png', {type: 'image/png'})];
                navigator.share({
                    files: filesArray,
                    title: 'ìš¸ë¦¼ì—°ê¸°í•™ì› ìƒí™©ê·¹ ë¯¸ì…˜',
                    text: 'ì˜¤ëŠ˜ì˜ ìƒí™©ê·¹ ë¯¸ì…˜ì„ ê³µìœ í•©ë‹ˆë‹¤! ğŸ­'
                })
                .catch(error => {
                    console.warn('Sharing failed, attempting download:', error);
                    downloadImage(imageURL, 'ìš¸ë¦¼_ìƒí™©ê·¹_ë¯¸ì…˜.png');
                });
            }, 'image/png');
        } else {
            downloadImage(imageURL, 'ìš¸ë¦¼_ìƒí™©ê·¹_ë¯¸ì…˜.png');
        }
    });
}


/* [íƒ­ 2] ìºë¦­í„° ë¡œì§ */
let currentChar = null;
function rollCharacter(gender) {
    // ì„ì‹œ ë°ì´í„° (ì´ë¯¸ì§€ ì—†ì„ë•Œ ëŒ€ë¹„)
    const list = gender === 'male' ? [{name:"ë‚¨ì„±ìºë¦­í„°", job:"ì§ì—…", desc:"ì„¤ëª…", id:1}] : [{name:"ì—¬ì„±ìºë¦­í„°", job:"ì§ì—…", desc:"ì„¤ëª…", id:1}];
    const char = pick(list); 
    currentChar = char; // ìºë¦­í„° ì •ë³´ ì €ì¥

    const imgEl = document.getElementById("charImgDisplay");
    const placeholderEl = document.querySelector(".char-placeholder");
    
    // ë¡œì»¬ ê²½ë¡œ í…ŒìŠ¤íŠ¸ìš© (ëœë¤ ì´ë¯¸ì§€ ê²½ë¡œ)
    const folder = gender === 'male' ? 'male' : 'female';
    const newSrc = `appdata/character/${folder}/${Math.floor(Math.random()*10)+1}.jpg`; 

    // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ í›„ í‘œì‹œ
    imgEl.onload = function(){
        placeholderEl.style.display = 'none';
        this.style.display = 'block';
    };
    imgEl.onerror = function(){
        // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
        this.style.display = 'none';
        placeholderEl.style.display = 'block';
    };
    
    imgEl.src = newSrc; // ìƒˆë¡œìš´ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
    
    // í…ìŠ¤íŠ¸ ëœë¤
    document.getElementById("charNameDisplay").textContent = "ëœë¤ ìºë¦­í„°";
    document.getElementById("charJobDisplay").textContent = "ëœë¤ ì§ì—…";
    document.getElementById("charDescDisplay").textContent = "ìƒˆë¡œìš´ ìºë¦­í„°ê°€ ì†Œí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
}

// ìˆ˜ì •ëœ saveCharacter() í•¨ìˆ˜: ì´ë¯¸ì§€ì™€ ì´ë¦„ì„ ë³µì œí•˜ì—¬ ì €ì¥ ê·¸ë¦¬ë“œì— ì¶”ê°€
function saveCharacter(){
    const charName = document.getElementById("charNameDisplay").textContent;
    const charImgSrc = document.getElementById("charImgDisplay").src;
    const isImageVisible = document.getElementById("charImgDisplay").style.display !== 'none';
    
    if (charName === "ìºë¦­í„° ì´ë¦„") {
        return alert("ë¨¼ì € 'ë‚¨ì ë½‘ê¸°' ë˜ëŠ” 'ì—¬ì ë½‘ê¸°'ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!");
    }
    
    const div = document.createElement("div"); div.className="mini-char-card";
    
    let imageHtml;
    if (isImageVisible && charImgSrc && charImgSrc.includes('appdata/character')) {
        // ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë  ë•Œë§Œ mini-char-imgë¥¼ ì‚¬ìš©
        imageHtml = `<img src="${charImgSrc}" class="mini-char-img" alt="${charName}">`;
    } else {
        // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ë•ŒëŠ” íšŒìƒ‰ ë°°ê²½ ìœ ì§€
        imageHtml = `<div class="mini-char-img" style="display:flex; justify-content:center; align-items:center; color:#fff; font-size:10px;">ì´ë¯¸ì§€ ì—†ìŒ</div>`;
    }

    div.innerHTML = `
        ${imageHtml}
        <div class="mini-char-info">
            ${charName}
        </div>
    `;
    
    document.getElementById("charSaveGrid").prepend(div);
}

// ìºë¦­í„° ë¯¸ì…˜ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥ ë° ê³µìœ í•˜ëŠ” í•¨ìˆ˜
function shareCharacterAsImage() {
    const targetElement = document.querySelector('#characterCard');
    const charName = document.getElementById("charNameDisplay").textContent;

    if (charName === "ìºë¦­í„° ì´ë¦„") {
        return alert("ë¨¼ì € 'ë‚¨ì ë½‘ê¸°' ë˜ëŠ” 'ì—¬ì ë½‘ê¸°'ë¥¼ ì§„í–‰í•´ì•¼ ì´ë¯¸ì§€ ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
    }
    
    const charImg = document.getElementById("charImgDisplay");
    
    // ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëŒ€ê¸° (ì•ˆì „ì„± ê°•í™”)
    if(charImg.style.display === 'none' || !charImg.complete) {
        return alert("ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
    
    // html2canvas ì‹¤í–‰
    html2canvas(targetElement, {
        allowTaint: true,
        useCORS: true,
        scale: 2
    }).then(canvas => {
        const imageURL = canvas.toDataURL("image/png");
        const filename = `ìš¸ë¦¼_ìºë¦­í„°_ë¯¸ì…˜_${charName}.png`;

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], filename, {type: 'image/png'})] })) {
            // Web Share API ì§€ì› ì‹œ ê³µìœ 
            canvas.toBlob(function(blob) {
                const filesArray = [new File([blob], filename, {type: 'image/png'})];
                navigator.share({
                    files: filesArray,
                    title: 'ìš¸ë¦¼ì—°ê¸°í•™ì› ìºë¦­í„° ë¯¸ì…˜',
                    text: `ì˜¤ëŠ˜ì˜ ìºë¦­í„° ë¯¸ì…˜ (${charName})ì„ ê³µìœ í•©ë‹ˆë‹¤! ğŸ¨`
                })
                .catch(error => {
                    console.warn('Sharing failed, attempting download:', error);
                    downloadImage(imageURL, filename);
                });
            }, 'image/png');
        } else {
            // ì§€ì›í•˜ì§€ ì•Šì„ ì‹œ ë‹¤ìš´ë¡œë“œ
            downloadImage(imageURL, filename);
        }
    }).catch(error => {
        console.error('HTML2Canvas Error:', error);
        alert('ì´ë¯¸ì§€ ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì„œë²„ í™˜ê²½ì—ì„œ ì‹¤í–‰í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”)');
    });
}
/* --- [íƒ­ 3] ë°œì„±í›ˆë ¨ --- */
let step=0, currentTrainObj=null;
let mediaRecorder, audioChunks = [], isRecording = false, startTime;
let recognition;
let recognitionResult = "";
let lastRecordedBlob = null; // ë…¹ìŒëœ ì˜¤ë””ì˜¤ Blob ì €ì¥ ë³€ìˆ˜

// 0. ì‹œìŠ¤í…œ ì§„ë‹¨ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const isSpeechSupported = ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window);

// 1. ìœ ì‚¬ë„ ê³„ì‚° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
function getSimilarity(s1, s2) {
    const longer = s1.length > s2.length ? s1 : s2;
    const shorter = s1.length > s2.length ? s2 : s1;
    if (longer.length === 0) return 1.0;
    return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
}
function editDistance(s1, s2) {
    s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
    const costs = new Array();
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i == 0) costs[j] = j;
            else {
                if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}

// 2. ìŒì„±ì¸ì‹ ì´ˆê¸°í™” (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
if (isSpeechSupported && !isIOS) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ko-KR';
    recognition.interimResults = false;
    recognition.continuous = false; 

    recognition.onresult = function(event) {
        recognitionResult = event.results[0][0].transcript;
        updateRecognitionUI(); 
    };
    recognition.onerror = function(event) { console.log("STT error:", event.error); };
}

function updateRecognitionUI() {
    if(recognitionResult) {
        document.getElementById('sttResult').textContent = `"${recognitionResult}"`;
        const targetClean = currentTrainObj.text.replace(/[^ê°€-í£]/g, '');
        const inputClean = recognitionResult.replace(/[^ê°€-í£]/g, '');
        const similarity = getSimilarity(targetClean, inputClean);
        const badge = document.getElementById('accBadge');
        if (similarity >= 0.7) { 
            badge.className = 'accuracy-badge acc-good'; badge.textContent = 'ì™„ë²½í•©ë‹ˆë‹¤! (70%â†‘)';
        } else if (similarity >= 0.3) { 
            badge.className = 'accuracy-badge acc-soso'; badge.textContent = 'í†µê³¼ (30%â†‘)';
        } else {
            badge.className = 'accuracy-badge acc-bad'; badge.textContent = 'ë‹¤ì‹œ ì‹œë„';
        }
    }
}

function extractVowels(s){
    const V=["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
    let out="";
    for(let ch of s){
        const code = ch.charCodeAt(0);
        if(code<0xac00||code>0xd7a3) { out+=ch; continue; }
        out+=V[Math.floor((code-0xac00)/28)%21];
    }
    return out;
}

// í›ˆë ¨ ë°ì´í„° ë° ë¡œì»¬ ì €ì¥ì†Œ ê´€ë ¨ í•¨ìˆ˜
const defaultVocalData = [{ id: 1, text: "ë°ì´í„° ë¡œë”©ì¤‘...", pron: "...", audio: "" }];
let trainDataList = (typeof vocalData !== 'undefined') ? vocalData : defaultVocalData;

// [1] ì €ì¥ëœ ë¬¸ì¥ IDë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜´
function getSavedVocalIds() {
    const ids = localStorage.getItem('savedVocalIds');
    return ids ? new Set(JSON.parse(ids)) : new Set();
}

// [2] ì¶œì„ ë° ë¬¸ì¥ ê¸°ë¡ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜´ (Map í˜•íƒœë¡œ ë°˜í™˜)
function getVocalRecords() {
    const records = localStorage.getItem('vocalRecords');
    return records ? new Map(JSON.parse(records)) : new Map();
}

// [3] ë¬¸ì¥ ì €ì¥ ë° ì—°ìŠµ ì™„ë£Œ ê¸°ë¡ (âœ… ì—°ìŠµ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ)
function completeTraining() {
    const btnComplete = document.getElementById('btnComplete');

    if (step !== 7 || !currentTrainObj) {
        return alert("STEP 7(ìµœì¢… ë…¹ìŒ)ê¹Œì§€ ì§„í–‰í•˜ê³  ë¬¸ì¥ì„ ë½‘ì€ ìƒíƒœì—ì„œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    }
    
    // 1. ë¬¸ì¥ IDë¥¼ ì €ì¥ (ë‹¤ìŒ ë½‘ê¸° ì‹œ ì œì™¸)
    const savedIds = getSavedVocalIds();
    const currentId = currentTrainObj.id;
    savedIds.add(currentId);
    localStorage.setItem('savedVocalIds', JSON.stringify(Array.from(savedIds)));
    
    // 2. ì¶œì„ ë° ë¬¸ì¥ ê¸°ë¡ ì €ì¥ (ë‚ ì§œ: ë¬¸ì¥)
    const records = getVocalRecords();
    const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    if (records.has(today)) {
        alert("ì˜¤ëŠ˜ì€ ì´ë¯¸ ì—°ìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!");
        return;
    }

 records.set(today, { 
        id: currentTrainObj.id, 
        text: currentTrainObj.text.substring(0, 30) + "...", 
        completed: true 
    });
    localStorage.setItem('vocalRecords', JSON.stringify(Array.from(records.entries())));

    // â­ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì—°ìŠµ ì™„ë£Œ ì •ë³´ ì „ì†¡ â­
    sendToGoogleSheet(currentTrainObj.id, currentTrainObj.text.substring(0, 30) + "...", "ì—°ìŠµ ì™„ë£Œ ì²´í¬"); 

    alert(`[${today}] ì—°ìŠµì„ ì™„ë£Œí•˜ê³  ë¬¸ì¥ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤! (ë‹¤ìŒ ë½‘ê¸° ì‹œ ì œì™¸ë¨)`);
    
    // â­ ìˆ˜ì •: ì™„ë£Œ í›„ ë‹¬ë ¥ í¼ì¹˜ê¸° (toggleCalendar í•¨ìˆ˜ ì‚¬ìš©) â­
    const calendarArea = document.getElementById('calendarDisplayArea');
    if (calendarArea.style.display === 'none') {
        toggleCalendar(); // ë‹¬ë ¥ì´ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ í¼ì¹¨
    } else {
        renderCalendar(); // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë Œë”ë§ë§Œ ë‹¤ì‹œ í•¨
    }
    
    // ì™„ë£Œ í›„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    btnComplete.style.display = 'none';
}


function trainNew(){
    if(typeof vocalData !== 'undefined') trainDataList = vocalData;
    
    // â­ ì¶”ê°€: ìƒˆ ë¬¸ì¥ ë½‘ì„ ë•Œ ë‹¬ë ¥ ìˆ¨ê¸°ê¸° â­
    document.getElementById('calendarDisplayArea').style.display = 'none'; 
    
    const savedIds = getSavedVocalIds();
    
    // ... (ë‚˜ë¨¸ì§€ ë¬¸ì¥ ë½‘ê¸° ë¡œì§ ìœ ì§€) ...
    
    const availableData = trainDataList.filter(item => !savedIds.has(item.id));

    if (availableData.length === 0) {
        if (trainDataList.length > 0) {
            return alert("ëª¨ë“  ë¬¸ì¥(" + trainDataList.length + "ê°œ)ì„ ì—°ìŠµí–ˆìŠµë‹ˆë‹¤! [F12] ê°œë°œì ë„êµ¬ > Application > Local Storage ì—ì„œ 'savedVocalIds'ë¥¼ ì‚­ì œí•´ì•¼ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.");
        }
        return alert("ë¬¸ì¥ ë°ì´í„°(appdata/vocalization/data.js)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    
    currentTrainObj = pick(availableData); // ì œì™¸ëœ ë¬¸ì¥ ì¤‘ì—ì„œ ëœë¤ìœ¼ë¡œ ë½‘ê¸°
    step=1;
    // â­ ì¶”ê°€: ìƒˆ ë¬¸ì¥ ë½‘ìœ¼ë©´ ë²„íŠ¼ í™œì„±í™” ë° UI ë Œë”ë§ ì‹œì‘ â­
    document.getElementById("btn_prev").disabled = true; // ì´ì „ ë²„íŠ¼ ë¹„í™œì„±í™” (STEP 1)
    document.getElementById("btn_next").disabled = false; // ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
    
    document.getElementById("train_origin").textContent = currentTrainObj.text; 
    document.getElementById("recordBox").style.display = 'none';
    const proAudio = document.getElementById("proAudio");
    proAudio.src = currentTrainObj.audio || ""; 
    proAudio.onloadedmetadata = function() {
        document.getElementById("proTime").textContent = proAudio.duration.toFixed(1) + "s";
    };
    lastRecordedBlob = null; // ìƒˆ ë¬¸ì¥ ë½‘ì„ ë•Œ ë…¹ìŒ ì´ˆê¸°í™”
    renderTrain();
}

// â­ ìˆ˜ì •: ë‹¨ê³„ ì´ë™ í•¨ìˆ˜ trainPrev/trainNextëŠ” renderTrainì„ í˜¸ì¶œí•©ë‹ˆë‹¤. â­
function trainPrev(){ 
    if(step>1) {
        step--; 
        renderTrain();
    } 
}
function trainNext(){ 
    if(step<7) {
        step++; 
        renderTrain();
    }
}

// â­ ìˆ˜ì •ëœ renderTrain ë¡œì§ (ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë¡œì§ ì¶”ê°€) â­
function renderTrain(){
    const box = document.getElementById("train_card");
    const ind = document.getElementById("step_indicator");
    const btnComplete = document.getElementById('btnComplete'); 
    
    // â­ ì¶”ê°€: ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° â­
    const btnPrev = document.getElementById("btn_prev");
    const btnNext = document.getElementById("btn_next");

    const T=["","STEP1 ëª¨ìŒì„ í˜¸í¡ìœ¼ë¡œ","STEP2 ëª¨ìŒì„ ì†Œë¦¬ë¡œ","STEP3 ììŒê³¼ í•¨ê»˜ í˜¸í¡ìœ¼ë¡œ ì½ê¸°","STEP4 ììŒê³¼ í•¨ê»˜ ì†Œë¦¬ë‚´ì–´ ì½ê¸°","STEP5 ìì—°ìŠ¤ëŸ½ê²Œ í˜¸í¡ìœ¼ë¡œ ì½ê¸°", "STEP6 ë°œìŒ AI ì²´í¬","STEP7 ìµœì¢… ë…¹ìŒ"];
    const D=["","ëª¨ìŒ ì…ëª¨ì–‘ ì‹ ê²½ì“°ë©° í˜¸í¡ìœ¼ë¡œ í•œê¸€ìì”© ì½ê¸°","ëª¨ìŒ ì…ëª¨ì–‘ ì‹ ê²½ì“°ë©° ì†Œë¦¬ë‚´ì–´ í•œê¸€ìì”© ì½ê¸°","ììŒê³¼ í•¨ê»˜ ì…ëª¨ì–‘ì„ ì‹ ê²½ì“°ë©° í•œê¸€ìì”© í˜¸í¡ìœ¼ë¡œ ì½ê¸°","ììŒê³¼ í•¨ê»˜ ì…ëª¨ì–‘ì„ ì‹ ê²½ì“°ë©° í•œê¸€ìì”© ì†Œë¦¬ë‚´ì–´ë¡œ ì½ê¸°","ìì—°ìŠ¤ëŸ½ê²Œ í•œë¬¸ì¥ì„ í•œ í˜¸í¡ìœ¼ë¡œ ì½ê¸°","AIê°€ ë°œìŒ ì •í™•ë„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.","ìµœì¢… ê²°ê³¼ë¬¼ì„ ë…¹ìŒí•˜ê³  ë“¤ì–´ë³´ì„¸ìš”."];

    // í˜„ì¬ ë¬¸ì¥ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì§„í–‰ ë¶ˆê°€
    if (!currentTrainObj) {
        step = 0;
        ind.textContent="STEP 0";
        box.innerHTML=`<p style="color:#aaa;">'ìƒˆ ë¬¸ì¥ ë½‘ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>`;
        btnPrev.disabled = true;
        btnNext.disabled = true;
        btnComplete.style.display = 'none';
        return;
    }

    let showText = "";
    if (step <= 2) { showText = extractVowels(currentTrainObj.text); }
    else if (step <= 7) { showText = currentTrainObj.pron; } 

    ind.textContent="STEP "+step;
    box.innerHTML=
        `<div style='font-size:20px; font-weight:900; margin-bottom:10px;'>${T[step]}</div>
         <div style='color:#666; margin-bottom:20px; font-size:15px;'>${D[step]}</div>
         <div class='train-main-text'>${showText}</div>`;

    // â­ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë¡œì§ â­
    btnPrev.disabled = (step === 1);
    btnNext.disabled = (step === 7);

    const recBox = document.getElementById("recordBox");
    const micBtn = document.getElementById("micBtn");
    const recStatus = document.getElementById("recStatus");
    const aiSection = document.getElementById("aiSection");
    const recSection = document.getElementById("recSection");
    
    // ë²„íŠ¼ í‘œì‹œ ì œì–´
    btnComplete.style.display = (step === 7) ? 'flex' : 'none';

    if(step === 6) {
        recBox.style.display = 'block';
        micBtn.textContent = 'ğŸ—£ï¸';
        recStatus.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ AI ì²´í¬ ì‹œì‘";
        aiSection.style.display = 'block';
        recSection.style.display = 'none';
        document.getElementById("resultBox").style.display = 'none';
    } else if (step === 7) {
        recBox.style.display = 'block';
        micBtn.textContent = 'ğŸ¤';
        recStatus.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘";
        aiSection.style.display = 'none';
        recSection.style.display = 'block';
        document.getElementById("resultBox").style.display = 'none';
    } else {
        recBox.style.display = 'none';
    }
}

// â­ ìƒˆë¡œ ì¶”ê°€: ë‹¬ë ¥ í¼ì¹˜ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€ í•¨ìˆ˜ â­
function toggleCalendar() {
    const calendarArea = document.getElementById('calendarDisplayArea');
    if (calendarArea.style.display === 'none') {
        renderCalendar(); // ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë Œë”ë§ í›„ í‘œì‹œ
        calendarArea.style.display = 'block';
    } else {
        calendarArea.style.display = 'none'; // í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ìˆ¨ê¹€
    }
}


// â­ ìˆ˜ì •ëœ renderCalendar ë¡œì§ (í´ë¦­ ì´ë²¤íŠ¸ ìœ ì§€) â­
function renderCalendar(year, month) {
    const today = new Date();
    const currentYear = year || today.getFullYear();
    const currentMonth = month !== undefined ? month : today.getMonth(); // 0-11
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const numDays = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday
    
    const records = getVocalRecords(); // ì €ì¥ëœ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    const container = document.getElementById('calendarContainer');
    container.innerHTML = '';
    
    // ì›”/ë…„ í‘œì‹œ ë° ë„¤ë¹„ê²Œì´ì…˜
    let table = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <button onclick="renderCalendar(${currentYear}, ${currentMonth === 0 ? 11 : currentMonth - 1})" style="background:#ddd; border:none; padding:5px 10px; border-radius:5px;">â¬…</button>
        <h2 style="font-size: 18px; margin: 0;">${currentYear}. ${currentMonth + 1}</h2>
        <button onclick="renderCalendar(${currentYear}, ${currentMonth === 11 ? 0 : currentMonth + 1})" style="background:#ddd; border:none; padding:5px 10px; border-radius:5px;">â¡</button>
    </div>`;

    table += '<table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 15px;">';
    table += '<thead><tr style="background: #eee; height: 35px;"><th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th></tr></thead><tbody><tr>';
    
    let day = 1;
    let cellCount = 0;

    // 1. ì²« ì£¼ ë¹ˆ ì…€ ì±„ìš°ê¸°
    for (let i = 0; i < startDayOfWeek; i++) {
        table += '<td style="border: 1px solid #eee; padding: 5px;"></td>';
        cellCount++;
    }

    // 2. ë‚ ì§œ ì±„ìš°ê¸°
    for (day = 1; day <= numDays; day++) {
        if (cellCount % 7 === 0 && cellCount !== 0) {
            table += '</tr><tr>';
        }
        
        // ë‚ ì§œë¥¼ ISO í˜•ì‹ìœ¼ë¡œ ìƒì„± (YYYY-MM-DD)
        const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const currentDate = new Date(currentYear, currentMonth, day);
        const todayKey = today.toISOString().slice(0, 10);
        
        const isToday = dateKey === todayKey;
        const isPastOrToday = currentDate <= today || isToday; 

        let statusText = day;
        let background = '#fff';
        let title = dateKey;
        let onClickEvent = '';
        
        const record = records.get(dateKey); // í•´ë‹¹ ë‚ ì§œì˜ ê¸°ë¡

        if (record) {
            // ì—°ìŠµ ì™„ë£Œ (O)
            statusText = `<span style="font-weight:900; color:#2ecc71;">O</span>`;
            background = '#e8f5e9';
            title += `\n[ì™„ë£Œ] ë¬¸ì¥:\n${record.text}`;
            // â­ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€: ê¸°ë¡ì´ ìˆì„ ë•Œë§Œ í´ë¦­ ê°€ëŠ¥
            onClickEvent = `onclick="displayDayRecord('${dateKey}', true)" style="cursor: pointer;"`;
        } else if (isPastOrToday && !isToday) {
             // ê³¼ê±°ì´ê³  ê¸°ë¡ì´ ì—†ìœ¼ë©´ ë¯¸ì™„ë£Œ (X)
            statusText = `<span style="font-weight:900; color:#ff6b6b;">X</span>`;
            background = '#fde9e9';
            title += '\n[ë¯¸ì™„ë£Œ]';
            // â­ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€: ë¯¸ì™„ë£Œ ê¸°ë¡ë„ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ ê°€ëŠ¥
            onClickEvent = `onclick="displayDayRecord('${dateKey}', false)" style="cursor: pointer;"`; 
        }

        if (isToday) {
            // ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡° (O/X ê¸°ë¡ì´ ì—†ìœ¼ë©´ ë‚ ì§œë§Œ í‘œì‹œ)
            background = record ? '#d0e9ff' : '#fffbe5'; // ì™„ë£Œ: í•˜ëŠ˜ìƒ‰, ë¯¸ì™„ë£Œ: ë…¸ë€ìƒ‰
            statusText = statusText === day ? `<span style="font-weight:900; color:#2980b9;">${day}</span>` : statusText;
            
            // ì˜¤ëŠ˜ ë‚ ì§œë„ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • (ê¸°ë¡ì´ ìˆë“  ì—†ë“ )
            onClickEvent = `onclick="displayDayRecord('${dateKey}', ${!!record})" style="cursor: pointer;"`; 
        }

        table += `<td ${onClickEvent} style="border: 1px solid #eee; padding: 5px; background: ${background};" title="${title}">`;
        table += statusText;
        table += '</td>';
        
        cellCount++;
    }

    // 3. ë§ˆì§€ë§‰ ì£¼ ë¹ˆ ì…€ ì±„ìš°ê¸°
    while (cellCount % 7 !== 0) {
        table += '<td style="border: 1px solid #eee; padding: 5px;"></td>';
        cellCount++;
    }
    
    table += '</tr></tbody></table>';
    
    container.innerHTML = table;
}

// â­ ìˆ˜ì •ëœ displayDayRecord ë¡œì§: ë¬¸ì¥ ID ìˆ¨ê¹€ â­
function displayDayRecord(dateKey, isCompleted) {
    const records = getVocalRecords();
    const record = records.get(dateKey);
    const box = document.getElementById('recordDisplayBox');
    const dateEl = document.getElementById('recordDisplayDate');
    const contentEl = document.getElementById('recordDisplayContent');
    
    dateEl.textContent = `${dateKey} ì—°ìŠµ ê¸°ë¡`;

    if (isCompleted && record) {
        contentEl.innerHTML = `
            <p style="font-weight: bold; color: #2ecc71;">âœ… ì—°ìŠµ ì™„ë£Œ</p>
            <p><strong>ë¬¸ì¥ ë‚´ìš©:</strong> "${record.text}..."</p>
            <p style="font-size: 13px; color: #777;">(ë…¹ìŒ íŒŒì¼ì€ ìµœì¢… ë…¹ìŒ ì‹œì—ë§Œ ì¼ì‹œì ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.)</p>
        `;
    } else {
        contentEl.innerHTML = `
            <p style="font-weight: bold; color: #ff6b6b;">${isCompleted ? 'âŒ ê¸°ë¡ ì—†ìŒ' : 'âŒ ë¯¸ì™„ë£Œ'}</p>
            <p>í•´ë‹¹ ë‚ ì§œì— ì—°ìŠµì„ ì™„ë£Œí•œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ${dateKey}ëŠ” ê±´ë„ˆë›°ê±°ë‚˜ ì—°ìŠµí•˜ì§€ ì•Šì€ ë‚ ì…ë‹ˆë‹¤.</p>
        `;
    }

    box.style.display = 'flex'; // íŒì—… í‘œì‹œ
}
// â­ AI ì²´í¬ ë˜ëŠ” ë…¹ìŒ ì‹¤í–‰ì„ ë¶„ê¸°í•˜ëŠ” í•¨ìˆ˜ (ëˆ„ë½ ë³µêµ¬ë¨) â­
async function handleAction() {
    if(step === 6) { startRecognition(); }
    else if (step === 7) { toggleRecord(); }
}
function startRecognition() {
    if(!isSpeechSupported) return alert("ì´ ê¸°ê¸°ì—ì„œëŠ” AI ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    if(!isRecording) {
        isRecording = true;
        recognitionResult = "";
        try { recognition.start(); } catch(e) { }
        const btn = document.getElementById('micBtn');
        btn.textContent = 'â¬›';
        btn.classList.add('recording');
        document.getElementById('recStatus').textContent = "ë“£ëŠ” ì¤‘...";
        document.getElementById('resultBox').style.display='block';
        document.getElementById('sttResult').textContent = "...";
        document.getElementById('accBadge').className = 'accuracy-badge acc-wait';
        document.getElementById('accBadge').textContent = 'ë¶„ì„ì¤‘...';
    } else {
        try { recognition.stop(); } catch(e) { }
        isRecording = false;
        resetBtn();
    }
}

function resetBtn() {
    const btn = document.getElementById('micBtn');
    btn.classList.remove('recording');
    if(step === 6) {
        btn.textContent = 'ğŸ—£ï¸';
        document.getElementById('recStatus').textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ AI ì²´í¬ ì‹œì‘";
    } else {
        btn.textContent = 'ğŸ¤';
        document.getElementById('recStatus').textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘";
    }
}
async function toggleRecord() {
    // ë¡œì»¬ í™˜ê²½ ê²½ê³  (ì´ì „ ì‘ë‹µê³¼ ë™ì¼)
    if(window.location.protocol === 'file:') return alert("ì„œë²„ í™˜ê²½(http/https)ì—ì„œë§Œ ë§ˆì´í¬ ì‚¬ìš© ë° íŒŒì¼ ê³µìœ ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    if (!isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            const options = { mimeType: 'audio/mp4' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                 options.mimeType = 'audio/webm'; // fallback
            }
            mediaRecorder = new MediaRecorder(stream, options);

            audioChunks = [];
            mediaRecorder.start();
            startTime = Date.now();
            isRecording = true;
            const btn = document.getElementById('micBtn');
            btn.textContent = 'â¬›'; 
            btn.classList.add('recording');
            document.getElementById('recStatus').textContent = "ë…¹ìŒ ì¤‘...";
            document.getElementById('resultBox').style.display='none'; 
            mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                lastRecordedBlob = audioBlob; // ë…¹ìŒëœ Blob ì €ì¥
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = document.getElementById('myAudio');
                audio.src = audioUrl;
                const duration = (Date.now() - startTime) / 1000;
                document.getElementById('myTime').textContent = duration.toFixed(1) + "s";
                document.getElementById('resultBox').style.display='block'; 
                stream.getTracks().forEach(track => track.stop());
            });
        } catch (e) { alert("ë§ˆì´í¬ ê¶Œí•œ í•„ìš”"); }
    } else {
        if(mediaRecorder) mediaRecorder.stop();
        isRecording = false;
        resetBtn();
    }
}
if (isSpeechSupported) { recognition.onend = function() { isRecording = false; resetBtn(); }; }

// ë°œì„±í›ˆë ¨ ë…¹ìŒ íŒŒì¼ ê³µìœ  í•¨ìˆ˜
async function shareVocalResult() {
    if (!lastRecordedBlob || !currentTrainObj) {
        return alert("ë¨¼ì € STEP 7ì—ì„œ ë…¹ìŒì„ ì™„ë£Œí•˜ê³  ë¬¸ì¥ì„ ë½‘ì•„ì•¼ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
    
    // íŒŒì¼ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì¸ì¦ í•„ìš”
    if (!currentFilenameBase || instructorName === 'ê¸°ë³¸') {
         await promptAndAuthenticate();
         if (instructorName === 'ê¸°ë³¸') return alert("ì¸ì¦ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ì¸ì¦ ì—†ì´ëŠ” ë“œë¼ì´ë¸Œ ì—…ë¡œë“œê°€ ì œí•œë©ë‹ˆë‹¤.");
    }

    const originalText = document.getElementById('train_origin').textContent;
    const mimeType = lastRecordedBlob.type;
    // ... (Base64 ì¸ì½”ë”© ë¡œì§ ìœ ì§€) ...
    const base64Data = await blobToBase64(lastRecordedBlob).catch(err => { /* ... */ });
    if (!base64Data) return;

 // ë…¹ìŒ íŒŒì¼ì„ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œí•˜ê³  ì‹œíŠ¸ì— ë§í¬ë¥¼ ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜
async function uploadAudioToDriveAndLog(vocalId, sentenceText, base64Data, mimeType, action) {
    if (!GOOGLE_APP_SCRIPT_URL || GOOGLE_APP_SCRIPT_URL.includes('https://script.google.com/macros/s/AKfycbwF5bgM15euvMN0mxQOi_B3q6YQnDIbMHr0G1lGGeIuqQ2gJAzN2giQ5cBzrB82Dt24XQ/exec')) {
        console.warn("Google Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ì´í„° ì „ì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
        return;
    }
    
    const payload = {
        name: studentName,
        vocalId: vocalId,
        sentence: sentenceText,
        action: action, 
        audioData: base64Data, 
        mimeType: mimeType,
        // â­ ì¶”ê°€ ì „ì†¡ ë°ì´í„° â­
        fileNameBase: currentFilenameBase, // GASê°€ ì‚¬ìš©í•  íŒŒì¼ëª… ë² ì´ìŠ¤
        instructor: instructorName       // GASê°€ í´ë”ë¥¼ ì„ íƒí•  ê°•ì‚¬ ì´ë¦„
    };

    try {
        await fetch(GOOGLE_APP_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        console.log('Drive upload and Sheet logging attempted.');
    } catch (error) {
        console.error('Drive upload failed:', error);
    }
}
/* --- [íƒ­ 4] ê¸°ì¶œë¬¸ì œ ë¡œì§ --- */
// ì™¸ë¶€ íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ê°’
const defaultPast = { male: [], female: [] };
const pData = (typeof pastQuestionData !== 'undefined') ? pastQuestionData : defaultPast;

function rollPastQuestion(gender) {
    if (!pData[gender] || pData[gender].length === 0) {
        return alert("í•´ë‹¹ ì„±ë³„ì˜ ê¸°ì¶œë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
    }
    const q = pick(pData[gender]);
    document.getElementById("pastRoleDisplay").textContent = q.role;
    document.getElementById("pastLinesDisplay").textContent = q.lines;
}
/* --- [íƒ­ 4] ê¸°ì¶œë¬¸ì œ ë…¹ìŒ ê¸°ëŠ¥ --- */
let pastMediaRecorder, pastAudioChunks = [], isPastRecording = false, pastStartTime;

async function togglePastRecord() {
    // ë¡œì»¬ í™˜ê²½ ê²½ê³  (ì´ì „ ì‘ë‹µê³¼ ë™ì¼)
    if(window.location.protocol === 'file:') return alert("ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ ì„œë²„ í™˜ê²½(http/https)ì—ì„œë§Œ ë§ˆì´í¬ ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    
    const btn = document.getElementById('pastMicBtn');
    const status = document.getElementById('pastRecStatus');
    const resultBox = document.getElementById('pastResultBox');
    const timeDisplay = document.getElementById('pastTime');
    const audioEl = document.getElementById('pastAudio');

    if (!isPastRecording) {
        // ë…¹ìŒ ì‹œì‘
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            const options = { mimeType: 'audio/mp4' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                 options.mimeType = 'audio/webm'; 
            }
            pastMediaRecorder = new MediaRecorder(stream, options);

            pastAudioChunks = [];
            
            pastMediaRecorder.start();
            pastStartTime = Date.now();
            isPastRecording = true;

            // UI ë³€ê²½
            btn.textContent = 'â¬›'; 
            btn.classList.add('recording');
            status.textContent = "ë…¹ìŒ ì¤‘...";
            resultBox.style.display = 'none'; // ë‹¤ì‹œ ë…¹ìŒí•˜ë©´ ê²°ê³¼ì°½ ìˆ¨ê¹€

            // ë°ì´í„° ìˆ˜ì§‘
            pastMediaRecorder.addEventListener("dataavailable", e => pastAudioChunks.push(e.data));

            // ë…¹ìŒ ì¢…ë£Œ ì‹œ ì²˜ë¦¬
            pastMediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(pastAudioChunks, { type: pastMediaRecorder.mimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                audioEl.src = audioUrl;

                const duration = (Date.now() - pastStartTime) / 1000;
                timeDisplay.textContent = duration.toFixed(1) + "s";
                
                resultBox.style.display = 'block'; // ê²°ê³¼ì°½ í‘œì‹œ
                
                // ìŠ¤íŠ¸ë¦¼ íŠ¸ë™ ì¢…ë£Œ (ë§ˆì´í¬ ë„ê¸°)
                stream.getTracks().forEach(track => track.stop());
            });

        } catch (e) {
            console.error(e);
            alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
    } else {
        // ë…¹ìŒ ì¤‘ì§€
        if(pastMediaRecorder) pastMediaRecorder.stop();
        isPastRecording = false;

        // UI ì›ë³µ
        btn.textContent = 'ğŸ¤';
        btn.classList.remove('recording');
        status.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒ ì‹œì‘";
    }
}
// í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¬ë ¥ê³¼ í˜„ì¬ ë¬¸ì¥ ì´ˆê¸°í™”
window.onload = function() {
// â­ ì¶”ê°€: í•™ìƒ ì´ë¦„ í™•ì¸ ë° ì„¤ì • â­
    checkStudentName();

    // íƒ­ ë¡œì§ ì´ˆê¸°í™” (ê¸°ì¡´ ì½”ë“œ)
    document.querySelectorAll('.tab').forEach(t => {
        t.onclick = () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            document.getElementById(t.dataset.tab).classList.add('active');
        };
    });
    
    // ë‹¬ë ¥ ì´ˆê¸°í™”
    renderCalendar();
};
</script>
</body>
</html>